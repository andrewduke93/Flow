import{r,j as e,R as B}from"./animations-D9Wo9mUM.js";import{u as H}from"./index-D4vXX8vZ.js";import{u as O,R as $}from"./rsvp-eqVIbU96.js";import{SettingsSheet as q}from"./SettingsSheet-DyETI2yI.js";import{T as U}from"./cloud-Be3Yh6fZ.js";import{M as V,m as G,n as J,P as K,b as Q,o as Z}from"./icons-x0kDHYDe.js";import"./vendor-react-uIRdnfX0.js";class I{constructor(){this.words=[],this.sourceText="",this.totalWords=0,this._position=0,this._isPlaying=!1,this._wpm=300,this.playbackTimer=null,this.positionListeners=new Set,this.playStateListeners=new Set}static getInstance(){return I.instance||(I.instance=new I),I.instance}load(s){if(this.stop(),this.sourceText=s,this.words=[],!s||s.length===0){this.totalWords=0;return}const n=Math.ceil(s.length/5);this.words=new Array(n);let t=0,o=-1,a=!0,u=!1;for(let l=0;l<=s.length;l++){const x=l<s.length?s[l]:" ",w=x===" "||x==="	"||x===`
`||x==="\r";if(x===`
`&&(u=!0),w&&!a&&o>=0){const g=s.slice(o,l);let f=0;const b=g[g.length-1];b==="."||b==="!"||b==="?"?f=2:(b===","||b===";"||b===":"||b==="â€”"||b==="â€“")&&(f=1),this.words[t]={text:g,start:o,end:l,index:t,trailingPause:f},t++,o=-1}else!w&&a&&(o=l,u&&t>0&&(this.words[t-1].trailingPause=3),u=!1);a=w}this.words.length=t,this.totalWords=t}get position(){return this._position}set position(s){const n=Math.max(0,Math.min(this.totalWords-1,s));n!==this._position&&(this._position=n,this.notifyPosition())}get progress(){return this.totalWords>0?this._position/this.totalWords:0}set progress(s){this.position=Math.floor(s*this.totalWords)}get total(){return this.totalWords}getWord(s){return this.words[s]||null}getCurrentWord(){return this.words[this._position]||null}getWindow(s,n){const t=Math.max(0,this._position-s),o=Math.min(this.totalWords,this._position+n);return this.words.slice(t,o)}getRange(s,n){const t=Math.max(0,s),o=Math.min(this.totalWords,t+n);return this.words.slice(t,o)}getParagraphs(s,n){const t=[];let o=[],a=s;for(let u=s;u<this.totalWords&&t.length<n;u++){const l=this.words[u];o.length===0&&(a=u),o.push(l),l.trailingPause===3&&(t.push({words:o,startIndex:a}),o=[])}return o.length>0&&t.length<n&&t.push({words:o,startIndex:a}),t}wordIndexFromProgress(s){return Math.floor(s*this.totalWords)}get isPlaying(){return this._isPlaying}get wpm(){return this._wpm}set wpm(s){this._wpm=Math.max(50,Math.min(1500,s)),this._isPlaying&&(this.stop(),this.play())}play(){this._isPlaying||this.totalWords===0||(this._isPlaying=!0,this.notifyPlayState(),this.scheduleNext())}stop(){this.playbackTimer!==null&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this._isPlaying&&(this._isPlaying=!1,this.notifyPlayState())}toggle(){this._isPlaying?this.stop():this.play()}scheduleNext(){if(!this._isPlaying)return;const s=this.getCurrentWord();if(!s){this.stop();return}let n=6e4/this._wpm;const t=s.trailingPause;t===1?n*=1.3:t===2?n*=1.8:t===3&&(n*=2.2);const o=s.text.length;o>10?n*=1.2:o>7?n*=1.1:o<=2&&(n*=.85),this.playbackTimer=window.setTimeout(()=>{this._position<this.totalWords-1?(this.position=this._position+1,this.scheduleNext()):this.stop()},n)}skipForward(s=10){this.position=this._position+s}skipBack(s=10){this.position=this._position-s}jumpToStart(){this.position=0}jumpToEnd(){this.position=this.totalWords-1}onPosition(s){return this.positionListeners.add(s),()=>this.positionListeners.delete(s)}onPlayState(s){return this.playStateListeners.add(s),()=>this.playStateListeners.delete(s)}notifyPosition(){const s=this._position;this.positionListeners.forEach(n=>n(s))}notifyPlayState(){const s=this._isPlaying;this.playStateListeners.forEach(n=>n(s))}getStats(){return{totalWords:this.totalWords,position:this._position,progress:this.progress,isPlaying:this._isPlaying,wpm:this._wpm}}}const tt=r.memo(({words:c,startIndex:s,activeIndex:n,isNearActive:t,fontSize:o,lineHeight:a,paragraphSpacing:u,fontFamily:l,textColor:x,accentColor:w,onWordTap:S})=>{const g=l==="New York"?'"New York", "Iowan Old Style", Georgia, serif':l==="OpenDyslexic"?'"OpenDyslexic", sans-serif':l==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif";if(!t){const f=c.map(b=>b.text).join(" ");return e.jsx("p",{"data-start":s,style:{fontSize:`${o}px`,lineHeight:a,marginBottom:`${u}px`,fontFamily:g,color:x,textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto",opacity:.9},children:f})}return e.jsx("p",{"data-start":s,style:{fontSize:`${o}px`,lineHeight:a,marginBottom:`${u}px`,fontFamily:g,color:x,textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto"},children:c.map((f,b)=>{const v=f.index===n;return e.jsxs(B.Fragment,{children:[e.jsx("span",{"data-idx":f.index,style:{backgroundColor:v?w:"transparent",color:v?"#FFFFFF":"inherit",padding:v?"2px 4px":"0",margin:v?"-2px -4px":"0",borderRadius:v?"4px":"0",transition:"background-color 0.1s ease"},children:f.text}),b<c.length-1?" ":""]},f.index)})})}),et=r.memo(({word:c,fontSize:s,fontFamily:n,textColor:t,accentColor:o})=>{if(!c)return null;const a=n==="New York"?'"New York", "Iowan Old Style", Georgia, serif':n==="OpenDyslexic"?'"OpenDyslexic", sans-serif':n==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif",u=c.text,l=u.length<=1?0:u.length<=5?1:u.length<=9?2:u.length<=13?3:4,x=u.slice(0,l),w=u[l]||"",S=u.slice(l+1),g=Math.min(s*2.5,72);return e.jsxs("div",{className:"relative w-full h-full flex flex-col items-center justify-center select-none",children:[e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[3px] pointer-events-none z-10",style:{backgroundColor:o,height:`${g*1.4}px`,top:"50%",transform:"translate(-50%, -50%)",borderRadius:"2px",boxShadow:`0 0 12px ${o}60`}}),e.jsxs("div",{className:"relative flex items-center",style:{fontFamily:a,fontSize:`${g}px`,fontWeight:500,letterSpacing:"0.02em"},children:[e.jsx("span",{style:{color:t,textAlign:"right",display:"inline-block",minWidth:"45vw",paddingRight:"2px"},children:x}),e.jsx("span",{style:{color:o,fontWeight:700,position:"relative",zIndex:5},children:w}),e.jsx("span",{style:{color:t,textAlign:"left",display:"inline-block",minWidth:"45vw",paddingLeft:"2px"},children:S})]}),e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[2px]",style:{backgroundColor:`${o}30`,height:"30px",top:`calc(50% - ${g*.7+35}px)`}}),e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[2px]",style:{backgroundColor:`${o}30`,height:"30px",top:`calc(50% + ${g*.7+5}px)`}})]})}),st=({book:c,onToggleChrome:s,isActive:n})=>{const t=I.getInstance(),o=H(),{settings:a,updateSettings:u}=O(),l=r.useRef(null),x=r.useRef(null),[w,S]=r.useState(!1),[g,f]=r.useState(0),[b,v]=r.useState(!1),[k,M]=r.useState(0),P=r.useRef(!1);r.useRef(0);const j=r.useRef(null),N=r.useRef(a.fontSize);r.useEffect(()=>{if(!c.chapters||c.chapters.length===0){S(!0);return}S(!1);const i=[...c.chapters].sort((m,h)=>m.sortOrder-h.sortOrder),d=[];for(const m of i)if(m.content){const h=m.content.replace(/<[^>]*>/g," ").replace(/&[a-z]+;/gi," ").replace(/\s+/g," ").trim();h&&d.push(h)}const p=d.join(`

`);t.load(p),M(t.total),c.lastTokenIndex!==void 0&&c.lastTokenIndex>0?t.position=c.lastTokenIndex:c.bookmarkProgress&&c.bookmarkProgress>0&&(t.progress=c.bookmarkProgress),t.wpm=a.wpm||300,f(t.position),S(!0),requestAnimationFrame(()=>{R(t.position,!1)})},[c.id]),r.useEffect(()=>{const i=t.onPosition(p=>{f(p),t.isPlaying&&R(p,!0),c.lastTokenIndex=p,c.bookmarkProgress=t.progress}),d=t.onPlayState(p=>{v(p)});return()=>{i(),d()}},[]);const R=r.useCallback((i,d)=>{if(!x.current||k===0)return;P.current=!0;const p=x.current.querySelector(`[data-start="${i}"]`);if(p){const m=l.current;if(m){const h=p.offsetTop-m.clientHeight*.3;m.scrollTo({top:Math.max(0,h),behavior:d?"smooth":"instant"})}}else{const m=l.current;if(m){const W=i/k*(m.scrollHeight-m.clientHeight);m.scrollTo({top:W,behavior:d?"smooth":"instant"})}}setTimeout(()=>{P.current=!1},d?500:50)},[k]);r.useEffect(()=>{const i=l.current;if(!i||!w)return;let d=!1;const p=()=>{P.current||d||(d=!0,requestAnimationFrame(()=>{if(!P.current&&i){const m=i.scrollTop/Math.max(1,i.scrollHeight-i.clientHeight),h=Math.floor(m*(k-1));Math.abs(h-g)>20&&(t.position=h)}d=!1}))};return i.addEventListener("scroll",p,{passive:!0}),()=>i.removeEventListener("scroll",p)},[w,k,g]),r.useEffect(()=>{const i=l.current;if(!i)return;const d=h=>{if(h.touches.length===2){const W=h.touches[0].clientX-h.touches[1].clientX,F=h.touches[0].clientY-h.touches[1].clientY;j.current=Math.sqrt(W*W+F*F),N.current=a.fontSize}},p=h=>{if(h.touches.length===2&&j.current!==null){h.preventDefault();const W=h.touches[0].clientX-h.touches[1].clientX,F=h.touches[0].clientY-h.touches[1].clientY,Y=Math.sqrt(W*W+F*F)/j.current,D=Math.round(Math.max(12,Math.min(40,N.current*Y)));D!==a.fontSize&&u({fontSize:D})}},m=()=>{j.current=null};return i.addEventListener("touchstart",d,{passive:!0}),i.addEventListener("touchmove",p,{passive:!1}),i.addEventListener("touchend",m,{passive:!0}),()=>{i.removeEventListener("touchstart",d),i.removeEventListener("touchmove",p),i.removeEventListener("touchend",m)}},[a.fontSize,u]);const C=r.useRef(null),T=r.useRef(null),E=r.useCallback(i=>{$.impactLight(),t.position=i,t.play()},[]),A=r.useCallback(()=>{$.impactMedium(),t.toggle()},[]),_=r.useCallback(i=>{const d="touches"in i?i.touches[0].clientX:i.clientX,p="touches"in i?i.touches[0].clientY:i.clientY;C.current={x:d,y:p,time:Date.now()},T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{$.impactLight()},500)},[]),L=r.useCallback(i=>{if(T.current&&(clearTimeout(T.current),T.current=null),!C.current)return;const d="changedTouches"in i?i.changedTouches[0].clientX:i.clientX,p="changedTouches"in i?i.changedTouches[0].clientY:i.clientY,m=Math.abs(d-C.current.x),h=Math.abs(p-C.current.y);if(Date.now()-C.current.time<300&&m<15&&h<15){const Y=i.target.dataset?.idx;Y!==void 0?E(parseInt(Y)):s()}C.current=null},[E,s]),z=r.useCallback(()=>{T.current&&(clearTimeout(T.current),T.current=null),C.current=null},[]),y=r.useMemo(()=>k===0?[]:t.getParagraphs(0,1e4),[k,w]);return w?k===0?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:o.background},children:e.jsxs("div",{className:"text-center px-8",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“–"}),e.jsx("p",{style:{color:o.secondaryText},children:"No content available"})]})}):e.jsxs("div",{ref:l,className:"absolute inset-0 overflow-y-auto overflow-x-hidden",style:{backgroundColor:o.background,WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},onTouchStart:_,onTouchEnd:L,onTouchCancel:z,onMouseDown:_,onMouseUp:L,children:[b&&e.jsxs("div",{className:"fixed inset-0 z-50",style:{backgroundColor:o.background},onClick:A,children:[e.jsx(et,{word:t.getCurrentWord(),fontSize:a.fontSize,fontFamily:a.fontFamily,textColor:o.primaryText,accentColor:o.accent}),e.jsx("div",{className:"absolute bottom-8 left-8 right-8",children:e.jsx("div",{className:"h-1 rounded-full overflow-hidden",style:{backgroundColor:`${o.primaryText}20`},children:e.jsx("div",{className:"h-full rounded-full transition-all duration-200",style:{backgroundColor:o.accent,width:`${t.progress*100}%`}})})}),e.jsx("div",{className:"absolute bottom-16 left-0 right-0 text-center",children:e.jsx("span",{className:"text-xs opacity-40",style:{color:o.secondaryText},children:"tap to pause"})})]}),e.jsx("div",{ref:x,className:"w-full min-h-full",style:{maxWidth:"680px",margin:"0 auto",padding:"80px 24px 200px 24px"},children:y.map((i,d)=>{const p=Math.abs(i.startIndex-g)<500;return e.jsx(tt,{words:i.words,startIndex:i.startIndex,activeIndex:g,isNearActive:p,fontSize:a.fontSize,lineHeight:a.lineHeight,paragraphSpacing:a.paragraphSpacing,fontFamily:a.fontFamily,textColor:o.primaryText,accentColor:o.accent,onWordTap:E},i.startIndex)})})]}):e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:o.background},children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 border-2 rounded-full animate-spin",style:{borderColor:o.accent,borderTopColor:"transparent"}}),e.jsx("span",{className:"text-sm lowercase tracking-wider",style:{color:o.secondaryText},children:"loading"})]})})},ut=({book:c,onClose:s})=>{const n=I.getInstance(),t=H(),{settings:o,updateSettings:a}=O(),[u,l]=r.useState(!0),[x,w]=r.useState(!1),[S,g]=r.useState(0),[f,b]=r.useState(!1),[v,k]=r.useState(!1),[M,P]=r.useState(o.rsvpSpeed||300),j=r.useRef(),N=r.useRef();r.useEffect(()=>{n.wpm=o.rsvpSpeed||300,P(n.wpm);const y=n.onPosition(d=>{g(n.progress),N.current&&clearTimeout(N.current),N.current=setTimeout(()=>{const p={...c,lastTokenIndex:d,bookmarkProgress:n.progress,lastOpened:new Date};U.getInstance().saveBook(p)},500)}),i=n.onPlayState(d=>{w(d),d&&(j.current=setTimeout(()=>l(!1),2e3))});return()=>{y(),i(),j.current&&clearTimeout(j.current),N.current&&clearTimeout(N.current)}},[c.id]),r.useEffect(()=>()=>{n.stop()},[]),r.useEffect(()=>{f&&n.isPlaying&&n.stop()},[f]);const R=r.useCallback(()=>{n.stop(),s(c.id,n.position,n.progress)},[c.id,s]),C=r.useCallback(()=>{$.impactMedium(),n.toggle()},[]),T=r.useCallback(()=>{$.impactLight();const y=Math.max(50,M-50);n.wpm=y,P(y),a({rsvpSpeed:y,hasCustomSpeed:!0})},[M,a]),E=r.useCallback(()=>{$.impactLight();const y=Math.min(1e3,M+50);n.wpm=y,P(y),a({rsvpSpeed:y,hasCustomSpeed:!0})},[M,a]),A=r.useCallback(()=>{j.current&&clearTimeout(j.current),l(y=>!y)},[]),_=r.useCallback(y=>{const i=parseFloat(y.target.value);n.progress=i},[]),L=r.useCallback(()=>{window.history.pushState({modal:"settings"},"",window.location.href),b(!0)},[]),z=r.useCallback(()=>{k(!0),setTimeout(()=>{b(!1),k(!1)},350)},[]);return r.useEffect(()=>{const y=()=>{f||v?z():x&&n.stop()};return window.addEventListener("popstate",y),()=>window.removeEventListener("popstate",y)},[f,v,x,z]),e.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden animate-fadeIn",style:{backgroundColor:t.background},children:[e.jsx(st,{book:c,onToggleChrome:A,isActive:!0}),e.jsx("div",{className:`fixed left-0 right-0 z-[60] transition-all duration-300 ${u?"opacity-100 translate-y-0":"opacity-0 translate-y-8 pointer-events-none"}`,style:{bottom:"env(safe-area-inset-bottom, 0px)",padding:"0 16px 16px 16px"},children:e.jsxs("div",{className:"rounded-2xl backdrop-blur-xl border shadow-2xl overflow-hidden",style:{backgroundColor:`${t.dimmer}f0`,borderColor:t.borderColor},children:[e.jsx("div",{className:"px-4 pt-3",children:e.jsx("input",{type:"range",min:"0",max:"1",step:"0.001",value:S,onChange:_,className:"w-full h-1.5 rounded-full appearance-none cursor-pointer",style:{background:`linear-gradient(to right, ${t.accent} ${S*100}%, ${t.borderColor} ${S*100}%)`}})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-3",children:[e.jsx("button",{onClick:T,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(V,{size:18})}),e.jsxs("span",{className:"text-xs font-mono opacity-50 w-16 text-center",style:{color:t.secondaryText},children:[M," wpm"]}),e.jsx("button",{onClick:C,className:"w-14 h-14 rounded-full flex items-center justify-center transition-all active:scale-90 shadow-lg",style:{backgroundColor:t.accent,color:"#FFFFFF"},children:x?e.jsx(G,{size:24}):e.jsx(J,{size:24,className:"ml-1"})}),e.jsx("button",{onClick:E,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(K,{size:18})}),e.jsx("button",{onClick:L,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(Q,{size:18})})]})]})}),e.jsx("div",{className:`fixed top-0 left-0 right-0 z-[60] transition-all duration-300 ${u?"opacity-100 translate-y-0":"opacity-0 -translate-y-full pointer-events-none"}`,children:e.jsxs("div",{className:"backdrop-blur-xl border-b pt-safe-top py-3 px-4 flex items-center justify-between",style:{backgroundColor:`${t.dimmer}f0`,borderColor:t.borderColor},children:[e.jsx("button",{onClick:R,className:"w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(Z,{size:20})}),e.jsx("div",{className:"flex-1 mx-4 truncate text-center",children:e.jsx("span",{className:"text-sm font-medium",style:{color:t.primaryText},children:c.title})}),e.jsx("div",{className:"w-10"})," "]})}),(f||v)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:v?"fadeOut 0.35s ease-out":"fadeIn 0.4s ease-out"},onClick:z}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[28px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:t.background,animation:v?"slideDown 0.35s ease-in":"slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)"},children:e.jsx(q,{onClose:z})})]}),e.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
      `})]})};export{ut as ReaderContainer};
