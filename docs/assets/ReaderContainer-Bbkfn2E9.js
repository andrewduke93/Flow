import{r as e,j as n,R as le}from"./animations-D9Wo9mUM.js";import{T as ce,b as ue,u as se,R as B,a as ae}from"./rsvp-0BBpS2BC.js";import{u as U}from"./index-BEC5ROHs.js";import{M as he,P as de,m as me,n as fe,o as pe,S as ge,b as xe,p as ye}from"./icons-Bsbxsu_x.js";import{SettingsSheet as we}from"./SettingsSheet-DwMarGAi.js";import"./vendor-react-uIRdnfX0.js";import"./cloud-LWBW7V_C.js";const ne=new Set([".","!","?","…","‽"]),be=new Set([";",":","—","–"]);class A{constructor(){this._tokens=[],this._currentIndex=0,this._mode="scroll",this._playState="idle",this._wpm=250,this.animationFrameId=null,this.lastFrameTime=0,this.accumulatedTime=0,this.rampStep=3,this.wordsInSentence=0,this.listeners=new Set,this.positionListeners=new Set,this.completionListeners=new Set,this.notifyScheduled=!1,this.lastContentRef=null,this.preparationPromise=null,this.wakeLock=null,this.loop=u=>{if(this._playState!=="playing")return;if(this.lastFrameTime===0){this.lastFrameTime=u,this.animationFrameId=requestAnimationFrame(this.loop);return}const i=(u-this.lastFrameTime)/1e3;this.lastFrameTime=u;const d=Math.min(i,.1);this.accumulatedTime+=d;const a=this.currentToken;if(!a){this.finish();return}const l=60/this._wpm;let s=1;this.rampStep===0?s=2:this.rampStep===1?s=1.5:this.rampStep===2&&(s=1.2);let b=1;const k=a.originalText,x=k.charAt(k.length-1),m=k.charAt(k.length-2);ne.has(x)||x==='"'&&ne.has(m)||x==="”"&&ne.has(m)?(b=1+.3*Math.max(1,this._wpm/200),this.wordsInSentence=0):be.has(x)?b=1.15:this.wordsInSentence++;const j=l*a.durationMultiplier*s*b;this.accumulatedTime>=j&&(this.advance(),this.accumulatedTime-=j),this._playState==="playing"&&(this.animationFrameId=requestAnimationFrame(this.loop))};const r=ce.getInstance();this._wpm=r.getSettings().rsvpSpeed||250,r.subscribe(()=>{const u=r.getSettings().rsvpSpeed;u!==this._wpm&&(this._wpm=u,this.notify())}),document.addEventListener("visibilitychange",async()=>{document.visibilityState==="visible"&&this._playState==="playing"&&await this.requestWakeLock()})}static getInstance(){return A.instance||(A.instance=new A),A.instance}get tokens(){return this._tokens}get currentIndex(){return this._currentIndex}get mode(){return this._mode}get playState(){return this._playState}get wpm(){return this._wpm}get isPlaying(){return this._playState==="playing"}get currentToken(){return this._tokens[this._currentIndex]||null}get progress(){return this._tokens.length===0?0:this._currentIndex/this._tokens.length}get position(){const r=this.currentToken;return{tokenIndex:this._currentIndex,progress:this.progress,characterOffset:r?.startOffset??0}}async loadContent(r,u){if(this.lastContentRef===r&&this._tokens.length>0){u&&this.seek(u);return}if(this.preparationPromise&&(await this.preparationPromise,this.lastContentRef===r)){u&&this.seek(u);return}this.preparationPromise=(async()=>{try{const i=await ue.process(r);this._tokens=i,this.lastContentRef=r}finally{this.preparationPromise=null}})(),await this.preparationPromise,u&&this.seek(u),this.notify()}clear(){this.pause(),this._tokens=[],this._currentIndex=0,this.lastContentRef=null,this.notify()}setMode(r){if(this._mode===r)return;this._playState==="playing"&&this.pause(),this._mode=r,r==="scroll"&&(this._playState="idle"),this.notify(),this.emitPosition()}play(){this._playState!=="playing"&&this._tokens.length!==0&&(this._mode!=="rsvp"&&(this._mode="rsvp"),this._currentIndex>=this._tokens.length-1&&(this._currentIndex=0),this._playState="playing",this.lastFrameTime=0,this.accumulatedTime=0,this._currentIndex===0&&(this.rampStep=0),this.requestWakeLock(),this.loop(performance.now()),this.notify())}pause(){this._playState==="playing"&&(this._playState="paused",this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.releaseWakeLock(),this.notify(),this.emitPosition())}toggle(){this._playState==="playing"?this.pause():this.play()}seek(r){const u=this._playState==="playing";if(u&&this.pause(),r.tokenIndex!==void 0)this._currentIndex=Math.max(0,Math.min(r.tokenIndex,this._tokens.length-1));else if(r.progress!==void 0)this._currentIndex=Math.floor(r.progress*this._tokens.length);else if(r.characterOffset!==void 0){const i=this._tokens.findIndex(d=>d.startOffset>=r.characterOffset);this._currentIndex=i>=0?i:this._tokens.length-1}this.accumulatedTime=0,this.notify(),this.emitPosition(),u&&this.play()}seekByTokens(r){const u=Math.max(0,Math.min(this._currentIndex+r,this._tokens.length-1));u!==this._currentIndex&&(this._currentIndex=u,this.accumulatedTime=0,this.notify(),this.emitPosition())}advance(){this._currentIndex<this._tokens.length-1?(this._currentIndex++,this.rampStep<3&&this.rampStep++,this.notify()):this.finish()}finish(){this.pause(),this._currentIndex=this._tokens.length-1,this._playState="idle",this.notify(),this.completionListeners.forEach(r=>r())}async requestWakeLock(){try{"wakeLock"in navigator&&(this.wakeLock=await navigator.wakeLock.request("screen"))}catch{}}releaseWakeLock(){this.wakeLock&&(this.wakeLock.release(),this.wakeLock=null)}subscribe(r){return this.listeners.add(r),()=>this.listeners.delete(r)}onPositionChange(r){return this.positionListeners.add(r),()=>this.positionListeners.delete(r)}onComplete(r){return this.completionListeners.add(r),()=>this.completionListeners.delete(r)}notify(){this._playState==="playing"&&!this.notifyScheduled?(this.notifyScheduled=!0,queueMicrotask(()=>{this.notifyScheduled=!1,this.listeners.forEach(r=>r())})):this._playState!=="playing"&&this.listeners.forEach(r=>r())}emitPosition(){const r=this.position;this.positionListeners.forEach(u=>u(r))}getTimeRemaining(){const r=this._tokens.length-this._currentIndex;return Math.ceil(r/this._wpm)}getTimeRemainingFormatted(){const r=this.getTimeRemaining();return r<1?"<1m":r>=60?`${Math.floor(r/60)}h`:`${r}m`}}const ke=e.memo(({onTap:h})=>{const r=e.useRef(null),u=e.useRef(null),i=A.getInstance(),d=U(),{settings:a}=se(),l=e.useRef(null),s=e.useRef(-1),b=e.useRef(1),k=e.useCallback(g=>{const t=Math.max(1,g.length);return t<=3?0:Math.min(t-1,Math.max(0,Math.floor(t*.3)))},[]),x=e.useCallback(()=>a.fontFamily==="New York"?"Georgia, serif":a.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':"system-ui, -apple-system, sans-serif",[a.fontFamily]),m=e.useCallback(()=>{const g=r.current,t=g?.getContext("2d");if(!g||!t)return;const S=i.currentToken,L=u.current;if(!L)return;const p=b.current,y=L.clientWidth,v=L.clientHeight;if(t.clearRect(0,0,g.width,g.height),!S)return;const P=S.originalText,R=k(P),w=a.fontSize||18,I=Math.min(w*3,Math.max(w*1.8,y*.08)),z=x();t.font=`600 ${I*p}px ${z}`,t.textBaseline="middle";const E=P.slice(0,R),W=P[R]||"",D=P.slice(R+1),H=S.punctuation||"",_=t.measureText(E).width,M=t.measureText(W).width,o=t.measureText(D).width,c=H?t.measureText(H).width:0,f=y*.355*p,C=v*.42*p,F=_+M/2,$=f-F;if(t.strokeStyle="#E25822",t.globalAlpha=.12,t.lineWidth=1.5*p,t.beginPath(),t.moveTo(f,v*.25*p),t.lineTo(f,v*.75*p),t.stroke(),t.globalAlpha=1,t.fillStyle=d.primaryText,t.fillText(E,$,C),t.fillStyle="#E25822",t.shadowColor="#E2582230",t.shadowBlur=24*p,t.fillText(W,$+_,C),t.shadowBlur=0,t.fillStyle=d.primaryText,t.fillText(D,$+_+M,C),H&&(t.fillStyle=d.secondaryText,t.globalAlpha=.4,t.fillText(H,$+_+M+o+2*p,C),t.globalAlpha=1),!i.isPlaying||a.showGhostPreview){const K=i.tokens,q=i.currentIndex;t.font=`400 ${I*.9*p}px ${z}`;const X=I*.6*p;let Q=$-X;for(let N=q-1;N>=Math.max(0,q-4);N--){const O=K[N];if(!O)break;const Y=O.originalText,Z=t.measureText(Y).width;Q-=Z;const ee=q-N,te=Math.max(.08,.4-ee*.08);t.fillStyle=d.primaryText,t.globalAlpha=te,t.fillText(Y,Q,C),Q-=X}let oe=$+_+M+o+c+X;for(let N=q+1;N<=Math.min(K.length-1,q+4);N++){const O=K[N];if(!O)break;const Y=O.originalText,Z=t.measureText(Y).width,ee=N-q,te=Math.max(.08,.4-ee*.08);t.fillStyle=d.primaryText,t.globalAlpha=te,t.fillText(Y,oe,C),oe+=Z+X}t.globalAlpha=1}const J=i.progress,re=v*.92*p,G=2*p,V=32*p,ie=y*p-V*2;t.fillStyle=d.primaryText,t.globalAlpha=.1,t.beginPath(),t.roundRect(V,re,ie,G,G/2),t.fill(),t.fillStyle="#E25822",t.globalAlpha=.2,t.beginPath(),t.roundRect(V,re,ie*J,G,G/2),t.fill(),t.globalAlpha=1},[d,a,k,x]),T=e.useCallback(()=>{m(),i.isPlaying&&(l.current=requestAnimationFrame(T))},[m]);e.useEffect(()=>{const g=r.current,t=u.current;if(!g||!t)return;const S=window.devicePixelRatio||1;b.current=S;const L=()=>{const y=t.clientWidth,v=t.clientHeight;g.width=y*S,g.height=v*S,g.style.width=`${y}px`,g.style.height=`${v}px`,m()};L(),window.addEventListener("resize",L);const p=i.subscribe(()=>{const y=i.currentIndex;(y!==s.current||!i.isPlaying)&&(s.current=y,i.isPlaying&&!l.current?T():i.isPlaying||(l.current&&(cancelAnimationFrame(l.current),l.current=null),m()))});return m(),()=>{window.removeEventListener("resize",L),p(),l.current&&cancelAnimationFrame(l.current)}},[m,T]),e.useEffect(()=>{m()},[d,a,m]);const j=e.useCallback(()=>{B.impactLight(),h?.()},[h]);return n.jsx("div",{ref:u,className:"absolute inset-0 select-none",style:{backgroundColor:d.background},onClick:j,children:n.jsx("canvas",{ref:r,className:"absolute inset-0 w-full h-full",style:{touchAction:"none"}})})}),Se={paragraph:{},"chapter-heading":{fontSize:"1.5em",fontWeight:600,textAlign:"center",marginTop:"2em",marginBottom:"1.5em",letterSpacing:"0.05em"},"scene-break":{textAlign:"center",margin:"2em 0",fontSize:"1.2em",letterSpacing:"0.5em",color:"inherit",opacity:.5},dialogue:{marginLeft:"1em",marginBottom:"0.5em"},"dialogue-attribution":{marginLeft:"1em",marginBottom:"0.75em",fontStyle:"normal"},"toc-entry":{display:"flex",justifyContent:"space-between",borderBottom:"1px dotted currentColor",opacity:.8,padding:"0.25em 0"},letter:{fontStyle:"italic",marginLeft:"2em",marginRight:"2em",padding:"1em",borderLeft:"2px solid currentColor",opacity:.9},poetry:{fontStyle:"italic",marginLeft:"2em",whiteSpace:"pre-wrap",lineHeight:1.8},blockquote:{marginLeft:"1.5em",paddingLeft:"1em",borderLeft:"3px solid currentColor",opacity:.85,fontStyle:"italic"},"list-item":{marginLeft:"1.5em",marginBottom:"0.25em"},"first-paragraph":{},epigraph:{textAlign:"center",fontStyle:"italic",marginBottom:"2em",opacity:.8,fontSize:"0.95em"}},ve=e.memo(({book:h,onToggleChrome:r,onRequestPlay:u,isRSVPActive:i})=>{const d=ae.getInstance(),a=A.getInstance(),l=U(),{settings:s,updateSettings:b}=se(),k=e.useRef(null),x=e.useRef(null),[m,T]=e.useState([]),[j,g]=e.useState(0),[t,S]=e.useState(!1),[L,p]=e.useState(0),[y,v]=e.useState(""),P=e.useRef(!1),R=e.useRef(null),w=e.useRef(s.fontSize);e.useEffect(()=>{console.log("[FlowReader] Initializing for book:",h.id,"chapters:",h.chapters?.length||0),S(!1),p(0),v(""),(async()=>{if(!h.chapters||h.chapters.length===0){console.log("[FlowReader] No chapters found, showing empty state"),S(!0),v("");return}try{console.log("[FlowReader] Loading core..."),await d.load(h);const c=d.contentStorage.string;if(console.log("[FlowReader] Content loaded, length:",c?.length||0),!c||c.trim().length===0){console.warn("[FlowReader] Content is empty after load"),S(!0);return}v(c),S(!0),p(1),console.log("[FlowReader] Ready!");const f=h.lastTokenIndex||0;a.loadContent(c,{tokenIndex:f}).then(()=>{console.log("[FlowReader] Tokens loaded:",a.tokens.length),T(a.tokens),g(a.currentIndex)}).catch(C=>console.error("[FlowReader] Token load failed:",C))}catch(c){console.error("[FlowReader] Init failed:",c),S(!0)}})()},[h.id]),e.useEffect(()=>a.subscribe(()=>{if(a.tokens.length>0&&a.tokens!==m&&T(a.tokens),g(a.currentIndex),!i&&x.current&&a.tokens.length>0){const c=a.progress,f=x.current.scrollHeight-x.current.clientHeight,C=c*f,F=x.current.scrollTop;Math.abs(C-F)>500&&(P.current=!0,x.current.scrollTo({top:C,behavior:"smooth"}),setTimeout(()=>{P.current=!1},600))}}),[i]),e.useEffect(()=>{const o=x.current;if(!o||!t||m.length===0||i)return;let c=!1;const f=()=>{P.current||c||(c=!0,requestAnimationFrame(()=>{if(!P.current&&o){const C=o.scrollTop/Math.max(1,o.scrollHeight-o.clientHeight),F=Math.floor(C*(m.length-1));Math.abs(F-a.currentIndex)>5&&(a.seek({tokenIndex:F}),d.saveProgress(F))}c=!1}))};return o.addEventListener("scroll",f,{passive:!0}),()=>o.removeEventListener("scroll",f)},[t,m.length,i]);const I=e.useCallback(o=>{if(o.touches.length===2){const c=o.touches[0].clientX-o.touches[1].clientX,f=o.touches[0].clientY-o.touches[1].clientY;R.current=Math.sqrt(c*c+f*f),w.current=s.fontSize}},[s.fontSize]),z=e.useCallback(o=>{if(o.touches.length===2&&R.current!==null){o.preventDefault();const c=o.touches[0].clientX-o.touches[1].clientX,f=o.touches[0].clientY-o.touches[1].clientY,F=Math.sqrt(c*c+f*f)/R.current,$=Math.round(Math.max(12,Math.min(40,w.current*F)));$!==s.fontSize&&b({fontSize:$})}},[s.fontSize,b]),E=e.useCallback(()=>{R.current=null},[]);e.useEffect(()=>{const o=x.current;if(o)return o.addEventListener("touchstart",I,{passive:!0}),o.addEventListener("touchmove",z,{passive:!1}),o.addEventListener("touchend",E,{passive:!0}),()=>{o.removeEventListener("touchstart",I),o.removeEventListener("touchmove",z),o.removeEventListener("touchend",E)}},[I,z,E]);const W=e.useMemo(()=>{if(m.length===0)return[];const o=[];let c=[],f=0;for(let C=0;C<m.length;C++){const F=m[C];if(c.push(F),F.isParagraphEnd||C===m.length-1){const $=c.map(J=>J.originalText).join(" ");o.push({tokens:c,startIndex:f,plainText:$,blockType:"paragraph"}),c=[],f=C+1}}return o},[m]),D=e.useCallback(o=>{B.impactMedium(),a.seek({tokenIndex:o}),u?.(o)},[u]),H=e.useCallback(()=>{a.toggle()},[]),_=s.fontFamily==="New York"?'"New York", "Iowan Old Style", Georgia, serif':s.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':s.fontFamily==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif";if(!t)return n.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:l.background},children:n.jsx("div",{className:"w-6 h-6 rounded-full border-2 animate-spin",style:{borderColor:`${l.accent}20`,borderTopColor:l.accent}})});const M=e.useMemo(()=>{if(m.length>0||!y)return null;try{return y.split(/\n\n+/).filter(c=>c.trim()).map((c,f)=>({type:"paragraph",content:c.trim()}))}catch(o){return console.error("[FlowReader] Format error:",o),null}},[m.length,y]);return n.jsxs("div",{ref:k,className:"absolute inset-0",children:[n.jsx("div",{ref:x,className:"absolute inset-0 overflow-y-auto overscroll-contain transition-opacity duration-300",style:{backgroundColor:l.background,opacity:i?a.isPlaying?0:.4:1,pointerEvents:i?"none":"auto"},onClick:r,children:n.jsxs("div",{className:"max-w-2xl mx-auto px-6 py-safe",style:{paddingTop:"calc(5rem + env(safe-area-inset-top))",paddingBottom:"12rem"},children:[M&&M.length>0&&M.map((o,c)=>n.jsx(Ce,{block:o,fontSize:s.fontSize,lineHeight:s.lineHeight,paragraphSpacing:s.paragraphSpacing,fontFamily:_,theme:l},c)),!M&&W.length>0&&W.map(o=>n.jsx(Te,{para:o,activeIndex:j,fontSize:s.fontSize,lineHeight:s.lineHeight,paragraphSpacing:s.paragraphSpacing,fontFamily:_,theme:l,onWordClick:D},o.startIndex)),!M&&W.length===0&&y&&n.jsx("p",{style:{color:l.primaryText,fontSize:`${s.fontSize}px`,fontFamily:_},children:y}),!y&&m.length===0&&n.jsxs("div",{style:{color:l.primaryText,textAlign:"center",paddingTop:"4rem"},children:[n.jsx("p",{style:{opacity:.5,fontSize:`${s.fontSize}px`},children:"Unable to load book content"}),n.jsxs("p",{style:{opacity:.3,fontSize:`${s.fontSize*.8}px`,marginTop:"0.5rem"},children:["Book chapters: ",h.chapters?.length||0]})]})]})}),n.jsx("div",{className:`absolute inset-0 transition-all duration-300 ${i?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}`,style:{transitionTimingFunction:"cubic-bezier(0.2, 0, 0, 1)"},children:n.jsx(ke,{onTap:H})})]})}),Ce=e.memo(({block:h,fontSize:r,lineHeight:u,paragraphSpacing:i,fontFamily:d,theme:a})=>{const l={fontSize:`${r}px`,lineHeight:u,fontFamily:d,color:a.primaryText,textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},s=Se[h.type];switch(h.type){case"chapter-heading":return n.jsx("h2",{style:{...l,...s,fontSize:`${r*1.5}px`},children:h.content});case"scene-break":return n.jsx("div",{style:{...l,...s},role:"separator",children:h.content});case"dialogue":case"dialogue-attribution":return n.jsx("p",{style:{...l,...s,marginBottom:`${i*.6}px`},children:h.content});case"toc-entry":const b=h.content.match(/^(.+?)(\s*\.{2,}\s*|\s{2,})(\d+)$/);return b?n.jsxs("div",{style:{...l,display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:"0.5em",marginBottom:"0.25em",paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel*1.5}em`:0},children:[n.jsx("span",{style:{flex:"1"},children:b[1].trim()}),n.jsx("span",{style:{borderBottom:"1px dotted currentColor",flex:"1",opacity:.3,marginBottom:"0.25em"}}),n.jsx("span",{style:{opacity:.6},children:b[3]})]}):n.jsx("p",{style:{...l,...s,marginBottom:"0.25em"},children:h.content});case"letter":return n.jsx("blockquote",{style:{...l,...s,marginBottom:`${i}px`,borderLeftColor:a.accent},children:h.content});case"poetry":return n.jsx("p",{style:{...l,...s,marginBottom:`${i*.5}px`},children:h.content});case"blockquote":return n.jsx("blockquote",{style:{...l,...s,marginBottom:`${i}px`,borderLeftColor:a.accent,paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel}em`:"1em"},children:h.content});case"list-item":const k=h.metadata?.listStyle==="number"?`${h.metadata.listIndex}. `:h.metadata?.listStyle==="letter"?`${String.fromCharCode(96+(h.metadata.listIndex||1))}. `:"• ";return n.jsxs("p",{style:{...l,...s,marginBottom:"0.25em"},children:[n.jsx("span",{style:{opacity:.6},children:k}),h.content]});case"first-paragraph":const x=h.content.charAt(0),m=h.content.slice(1);return n.jsxs("p",{style:{...l,marginBottom:`${i}px`,textAlign:"justify",textJustify:"inter-word"},children:[n.jsx("span",{style:{float:"left",fontSize:`${r*3.2}px`,lineHeight:.8,marginRight:"0.08em",marginTop:"0.05em",fontWeight:500,color:a.accent},children:x}),m]});case"epigraph":return n.jsx("p",{style:{...l,...s,marginBottom:`${i*2}px`,fontSize:`${r*.95}px`},children:h.content});case"paragraph":default:return n.jsx("p",{style:{...l,marginBottom:`${i}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em"},children:h.content})}}),Te=e.memo(({para:h,activeIndex:r,fontSize:u,lineHeight:i,paragraphSpacing:d,fontFamily:a,theme:l,onWordClick:s})=>n.jsx("p",{className:"cursor-pointer transition-opacity hover:opacity-100",style:{fontSize:`${u}px`,lineHeight:i,fontFamily:a,color:l.primaryText,marginBottom:`${d}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em",textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},children:h.tokens.map(b=>{const k=b.globalIndex===r;return n.jsxs(le.Fragment,{children:[n.jsx("span",{onClick:x=>{x.stopPropagation(),s(b.globalIndex)},className:"inline rounded-sm cursor-pointer select-none transition-colors duration-150",style:{backgroundColor:k?l.accent:"transparent",color:k?"#FFFFFF":"inherit",padding:k?"0.1em 0.15em":"0",margin:k?"-0.1em -0.15em":"0"},children:b.originalText})," "]},b.id)})})),je=e.memo(({book:h,onToggleRSVP:r,isRSVPActive:u,onSettingsClick:i})=>{const d=A.getInstance(),{settings:a,updateSettings:l}=se(),s=U(),[b,k]=e.useState(!1),[x,m]=e.useState(0),[T,j]=e.useState(!1),g=e.useRef(null),t=e.useRef(null),S=e.useRef(!1),L=e.useRef(0),p=e.useRef(null),y=e.useRef(null),[v,P]=e.useState(!1),R=e.useRef(!1);e.useEffect(()=>{const o=()=>{if(k(d.isPlaying),!T){const f=d.progress;m(f),t.current&&(t.current.style.width=`${f*100}%`)}};o();const c=d.subscribe(o);return()=>c()},[T]);const w=e.useCallback(()=>d.getTimeRemainingFormatted(),[x]),I=e.useCallback(o=>{if(!g.current)return;o.preventDefault(),j(!0),S.current=d.isPlaying,S.current&&d.pause();const c=g.current.getBoundingClientRect(),f=Math.max(0,Math.min(1,(o.clientX-c.left)/c.width));m(f),t.current&&(t.current.style.width=`${f*100}%`),o.target.setPointerCapture(o.pointerId)},[]),z=e.useCallback(o=>{if(!T||!g.current)return;const c=g.current.getBoundingClientRect(),f=Math.max(0,Math.min(1,(o.clientX-c.left)/c.width));m(f),t.current&&(t.current.style.width=`${f*100}%`)},[T]),E=e.useCallback(o=>{if(!T||!g.current)return;const c=g.current.getBoundingClientRect(),f=Math.max(0,Math.min(1,(o.clientX-c.left)/c.width));d.seek({progress:f}),j(!1),S.current&&d.play(),B.impactMedium()},[T]),W=e.useCallback(()=>{const o=Date.now();o-L.current<200||(L.current=o,B.impactMedium(),r())},[r]),D=e.useCallback(o=>{B.impactLight();const c=Math.max(50,Math.min(1e3,(a.rsvpSpeed||250)+o));l({rsvpSpeed:c,hasCustomSpeed:!0})},[a.rsvpSpeed,l]),H=e.useCallback(()=>{u&&(B.impactLight(),R.current=d.isPlaying,d.seekByTokens(-10),y.current=setTimeout(()=>{P(!0),R.current&&d.pause(),p.current=setInterval(()=>{d.seekByTokens(-10),B.selectionChanged(),d.currentIndex<=0&&_()},150)},300))},[u]),_=e.useCallback(()=>{y.current&&clearTimeout(y.current),p.current&&clearInterval(p.current),y.current=null,p.current=null,v&&(P(!1),R.current&&d.play(),B.impactMedium())},[v]);e.useEffect(()=>()=>{p.current&&clearInterval(p.current),y.current&&clearTimeout(y.current)},[]);const M=e.useCallback(()=>{B.impactLight(),l({showGhostPreview:!a.showGhostPreview})},[a.showGhostPreview,l]);return n.jsxs("div",{className:"w-full backdrop-blur-xl rounded-2xl border overflow-hidden",style:{backgroundColor:`${s.surface}f0`,borderColor:s.borderColor},children:[n.jsx("div",{ref:g,className:"h-10 px-4 flex items-center cursor-pointer touch-none",onPointerDown:I,onPointerMove:z,onPointerUp:E,onPointerCancel:E,children:n.jsxs("div",{className:"w-full h-1 rounded-full relative",style:{backgroundColor:`${s.primaryText}10`},children:[n.jsx("div",{ref:t,className:"absolute top-0 left-0 h-full rounded-full",style:{backgroundColor:s.accent,width:`${x*100}%`}}),T&&n.jsx("div",{className:"absolute top-1/2 w-4 h-4 rounded-full border-2 border-white shadow-lg",style:{left:`${x*100}%`,transform:"translate(-50%, -50%)",backgroundColor:s.accent}})]})}),n.jsxs("div",{className:"flex items-center justify-between px-4 pb-4 gap-3",children:[n.jsxs("div",{className:"flex items-center h-11 rounded-xl border shrink-0",style:{borderColor:s.borderColor,backgroundColor:`${s.primaryText}05`},children:[n.jsx("button",{onClick:()=>D(-25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:s.secondaryText},children:n.jsx(he,{size:16})}),n.jsx("div",{className:"px-2 min-w-[48px] text-center",children:n.jsx("span",{className:"text-xs font-bold tabular-nums",style:{color:s.primaryText},children:a.rsvpSpeed||250})}),n.jsx("button",{onClick:()=>D(25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:s.secondaryText},children:n.jsx(de,{size:16})})]}),n.jsxs("div",{className:"flex items-center gap-2",children:[u&&n.jsx("button",{onPointerDown:H,onPointerUp:_,onPointerLeave:_,onPointerCancel:_,className:`w-11 h-11 rounded-full flex items-center justify-center transition-all ${v?"scale-110":"active:scale-95"}`,style:{backgroundColor:v?`${s.accent}25`:`${s.primaryText}08`,color:v?s.accent:s.secondaryText},children:n.jsx(me,{size:18,className:v?"animate-spin":"",style:{animationDirection:"reverse",animationDuration:"1s"}})}),n.jsx("button",{onClick:W,className:"w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform",style:{backgroundColor:s.accent,boxShadow:`0 4px 16px -2px ${s.accent}50`},children:u&&b?n.jsx(fe,{size:22,className:"text-white fill-white"}):n.jsx(pe,{size:22,className:"text-white fill-white ml-0.5"})}),u&&n.jsx("button",{onClick:M,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:a.showGhostPreview?`${s.accent}25`:`${s.primaryText}08`,color:a.showGhostPreview?s.accent:s.secondaryText},children:n.jsx(ge,{size:18,className:a.showGhostPreview?"fill-current":""})})]}),n.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[n.jsx("button",{onClick:i,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${s.primaryText}08`,color:s.secondaryText},children:n.jsx(xe,{size:18})}),n.jsx("span",{className:"text-xs font-medium tabular-nums min-w-[32px] text-right",style:{color:s.secondaryText},children:w()})]})]})]})}),Ee=({book:h,onClose:r})=>{const u=ae.getInstance(),i=A.getInstance(),d=U(),[a,l]=e.useState(!0),[s,b]=e.useState(!1),[k,x]=e.useState(!1),[m,T]=e.useState(!1),[j,g]=e.useState(!1),t=e.useRef(!1);e.useEffect(()=>{const w=()=>{const z=i.mode==="rsvp",E=i.isPlaying;b(z),x(E),u.isRSVPMode=z};w();const I=i.subscribe(w);return()=>I()},[]),e.useEffect(()=>{const w=i.onPositionChange(I=>{u.saveProgress(I.tokenIndex)});return()=>w()},[]),e.useEffect(()=>()=>{i.pause(),i.mode==="rsvp"&&u.saveProgress(i.currentIndex),i.setMode("scroll"),i.clear()},[]),e.useEffect(()=>{const w=()=>{t.current||(t.current=!0,m||j?S():s&&(i.pause(),i.setMode("scroll"),l(!0)),t.current=!1)};return window.addEventListener("popstate",w),()=>window.removeEventListener("popstate",w)},[m,j,s]),e.useEffect(()=>{let w;return a&&s&&k&&(w=setTimeout(()=>l(!1),2500)),()=>clearTimeout(w)},[a,s,k]),e.useEffect(()=>{m&&i.isPlaying&&i.pause()},[m]);const S=e.useCallback(()=>{g(!0),setTimeout(()=>{T(!1),g(!1)},400)},[]),L=e.useCallback(()=>{const w=i.currentIndex,I=i.progress;i.pause(),u.saveProgress(w),i.setMode("scroll"),r(h.id,w,I)},[h.id,r]),p=e.useCallback(()=>{s?i.toggle():(i.setMode("rsvp"),t.current||window.history.pushState({rsvpMode:!0},"",window.location.href),i.play(),l(!1))},[s]),y=e.useCallback(w=>{i.seek({tokenIndex:w}),i.setMode("rsvp"),t.current||window.history.pushState({rsvpMode:!0},"",window.location.href),i.play(),l(!1)},[]),v=e.useCallback(()=>{t.current||window.history.pushState({modal:"settings"},"",window.location.href),T(!0)},[]),P=e.useCallback(()=>{l(w=>!w)},[]),R=e.useCallback(()=>{i.pause(),i.setMode("scroll"),l(!0)},[]);return n.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden m-0 p-0 animate-fadeIn",style:{backgroundColor:d.background},children:[n.jsx("div",{className:"absolute inset-0 z-10",children:n.jsx(ve,{book:h,onToggleChrome:P,onRequestPlay:y,isRSVPActive:s})}),n.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50 pointer-events-auto",style:{bottom:"calc(2rem + env(safe-area-inset-bottom))"},children:n.jsx(je,{book:h,onToggleRSVP:p,isRSVPActive:s,onSettingsClick:v})}),n.jsx("div",{className:`absolute top-0 left-0 right-0 z-[60] transition-transform duration-400 pointer-events-none ${a||s&&!k?"translate-y-0":"-translate-y-full"}`,style:{transitionTimingFunction:"cubic-bezier(0.16, 1, 0.3, 1)"},children:n.jsx("div",{className:"backdrop-blur-2xl border-b pt-safe-top py-4 px-5 flex items-center justify-between pointer-events-auto",style:{backgroundColor:d.dimmer,borderColor:d.borderColor},children:n.jsx("button",{onClick:s?R:L,className:"w-11 h-11 -ml-1 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${d.primaryText}08`,color:d.primaryText},children:n.jsx(ye,{size:20})})})}),(m||j)&&n.jsxs(n.Fragment,{children:[n.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:j?"fadeOut 0.4s ease-out":"fadeIn 0.6s ease-out"},onClick:S}),n.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[32px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:d.background,animation:j?"slideDown 0.5s cubic-bezier(0.7, 0, 0.84, 0)":"slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1)"},children:n.jsx(we,{onClose:S})})]}),n.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
      `})]})};export{Ee as ReaderContainer};
