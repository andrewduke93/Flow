import{r as o,j as r,R as pe}from"./animations-D9Wo9mUM.js";import{T as me,b as fe,u as le,R as D,a as de}from"./rsvp-0BBpS2BC.js";import{u as ee}from"./index-Maxra59y.js";import{M as ge,P as ye,m as xe,n as be,o as ke,S as we,b as Te,p as Se}from"./icons-Bsbxsu_x.js";import{SettingsSheet as ve}from"./SettingsSheet-hiU2FBco.js";import"./vendor-react-uIRdnfX0.js";import"./cloud-LWBW7V_C.js";const ae=new Set([".","!","?","…","‽"]),Ce=new Set([";",":","—","–"]);class H{constructor(){this._tokens=[],this._currentIndex=0,this._mode="scroll",this._playState="idle",this._wpm=250,this.animationFrameId=null,this.lastFrameTime=0,this.accumulatedTime=0,this.rampStep=3,this.wordsInSentence=0,this.listeners=new Set,this.positionListeners=new Set,this.completionListeners=new Set,this.notifyScheduled=!1,this.lastContentRef=null,this.preparationPromise=null,this.wakeLock=null,this.loop=i=>{if(this._playState!=="playing")return;if(this.lastFrameTime===0){this.lastFrameTime=i,this.animationFrameId=requestAnimationFrame(this.loop);return}const s=(i-this.lastFrameTime)/1e3;this.lastFrameTime=i;const l=Math.min(s,.1);this.accumulatedTime+=l;const u=this.currentToken;if(!u){this.finish();return}const a=60/this._wpm;let t=1;this.rampStep===0?t=2:this.rampStep===1?t=1.5:this.rampStep===2&&(t=1.2);let w=1;const b=u.originalText,f=b.charAt(b.length-1),d=b.charAt(b.length-2);ae.has(f)||f==='"'&&ae.has(d)||f==="”"&&ae.has(d)?(w=1+.3*Math.max(1,this._wpm/200),this.wordsInSentence=0):Ce.has(f)?w=1.15:this.wordsInSentence++;const T=a*u.durationMultiplier*t*w;this.accumulatedTime>=T&&(this.advance(),this.accumulatedTime-=T),this._playState==="playing"&&(this.animationFrameId=requestAnimationFrame(this.loop))};const e=me.getInstance();this._wpm=e.getSettings().rsvpSpeed||250,e.subscribe(()=>{const i=e.getSettings().rsvpSpeed;i!==this._wpm&&(this._wpm=i,this.notify())}),document.addEventListener("visibilitychange",async()=>{document.visibilityState==="visible"&&this._playState==="playing"&&await this.requestWakeLock()})}static getInstance(){return H.instance||(H.instance=new H),H.instance}get tokens(){return this._tokens}get currentIndex(){return this._currentIndex}get mode(){return this._mode}get playState(){return this._playState}get wpm(){return this._wpm}get isPlaying(){return this._playState==="playing"}get currentToken(){return this._tokens[this._currentIndex]||null}get progress(){return this._tokens.length===0?0:this._currentIndex/this._tokens.length}get position(){const e=this.currentToken;return{tokenIndex:this._currentIndex,progress:this.progress,characterOffset:e?.startOffset??0}}async loadContent(e,i){if(this.lastContentRef===e&&this._tokens.length>0){i&&this.seek(i);return}if(this.preparationPromise&&(await this.preparationPromise,this.lastContentRef===e)){i&&this.seek(i);return}this.preparationPromise=(async()=>{try{const s=await fe.process(e);this._tokens=s,this.lastContentRef=e}finally{this.preparationPromise=null}})(),await this.preparationPromise,i&&this.seek(i),this.notify()}clear(){this.pause(),this._tokens=[],this._currentIndex=0,this.lastContentRef=null,this.notify()}setMode(e){if(this._mode===e)return;this._playState==="playing"&&this.pause(),this._mode=e,e==="scroll"&&(this._playState="idle"),this.notify(),this.emitPosition()}play(){this._playState!=="playing"&&this._tokens.length!==0&&(this._mode!=="rsvp"&&(this._mode="rsvp"),this._currentIndex>=this._tokens.length-1&&(this._currentIndex=0),this._playState="playing",this.lastFrameTime=0,this.accumulatedTime=0,this._currentIndex===0&&(this.rampStep=0),this.requestWakeLock(),this.loop(performance.now()),this.notify())}pause(){this._playState==="playing"&&(this._playState="paused",this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.releaseWakeLock(),this.notify(),this.emitPosition())}toggle(){this._playState==="playing"?this.pause():this.play()}seek(e){const i=this._playState==="playing";if(i&&this.pause(),e.tokenIndex!==void 0)this._currentIndex=Math.max(0,Math.min(e.tokenIndex,this._tokens.length-1));else if(e.progress!==void 0)this._currentIndex=Math.floor(e.progress*this._tokens.length);else if(e.characterOffset!==void 0){const s=this._tokens.findIndex(l=>l.startOffset>=e.characterOffset);this._currentIndex=s>=0?s:this._tokens.length-1}this.accumulatedTime=0,this.notify(),this.emitPosition(),i&&this.play()}seekByTokens(e){const i=Math.max(0,Math.min(this._currentIndex+e,this._tokens.length-1));i!==this._currentIndex&&(this._currentIndex=i,this.accumulatedTime=0,this.notify(),this.emitPosition())}advance(){this._currentIndex<this._tokens.length-1?(this._currentIndex++,this.rampStep<3&&this.rampStep++,this.notify()):this.finish()}finish(){this.pause(),this._currentIndex=this._tokens.length-1,this._playState="idle",this.notify(),this.completionListeners.forEach(e=>e())}async requestWakeLock(){try{"wakeLock"in navigator&&(this.wakeLock=await navigator.wakeLock.request("screen"))}catch{}}releaseWakeLock(){this.wakeLock&&(this.wakeLock.release(),this.wakeLock=null)}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}onPositionChange(e){return this.positionListeners.add(e),()=>this.positionListeners.delete(e)}onComplete(e){return this.completionListeners.add(e),()=>this.completionListeners.delete(e)}notify(){this._playState==="playing"&&!this.notifyScheduled?(this.notifyScheduled=!0,queueMicrotask(()=>{this.notifyScheduled=!1,this.listeners.forEach(e=>e())})):this._playState!=="playing"&&this.listeners.forEach(e=>e())}emitPosition(){const e=this.position;this.positionListeners.forEach(i=>i(e))}getTimeRemaining(){const e=this._tokens.length-this._currentIndex;return Math.ceil(e/this._wpm)}getTimeRemainingFormatted(){const e=this.getTimeRemaining();return e<1?"<1m":e>=60?`${Math.floor(e/60)}h`:`${e}m`}}const Ie=o.memo(({onTap:h})=>{const e=o.useRef(null),i=o.useRef(null),s=H.getInstance(),l=ee(),{settings:u}=le(),a=o.useRef(null),t=o.useRef(-1),w=o.useRef(1),b=o.useCallback(y=>{const n=Math.max(1,y.length);return n<=3?0:Math.min(n-1,Math.max(0,Math.floor(n*.3)))},[]),f=o.useCallback(()=>u.fontFamily==="New York"?"Georgia, serif":u.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':"system-ui, -apple-system, sans-serif",[u.fontFamily]),d=o.useCallback(()=>{const y=e.current,n=y?.getContext("2d");if(!y||!n)return;const g=s.currentToken,F=i.current;if(!F)return;const k=w.current,S=F.clientWidth,C=F.clientHeight;if(n.clearRect(0,0,y.width,y.height),!g)return;const R=g.originalText,P=b(R),v=u.fontSize||18,j=Math.min(v*3,Math.max(v*1.8,S*.08)),$=f();n.font=`600 ${j*k}px ${$}`,n.textBaseline="middle";const N=R.slice(0,P),W=R[P]||"",G=R.slice(P+1),O=g.punctuation||"",_=n.measureText(N).width,E=n.measureText(W).width,c=n.measureText(G).width,m=O?n.measureText(O).width:0,x=S*.355*k,I=C*.42*k,A=_+E/2,z=x-A;if(n.strokeStyle="#E25822",n.globalAlpha=.12,n.lineWidth=1.5*k,n.beginPath(),n.moveTo(x,C*.25*k),n.lineTo(x,C*.75*k),n.stroke(),n.globalAlpha=1,n.fillStyle=l.primaryText,n.fillText(N,z,I),n.fillStyle="#E25822",n.shadowColor="#E2582230",n.shadowBlur=24*k,n.fillText(W,z+_,I),n.shadowBlur=0,n.fillStyle=l.primaryText,n.fillText(G,z+_+E,I),O&&(n.fillStyle=l.secondaryText,n.globalAlpha=.4,n.fillText(O,z+_+E+c+2*k,I),n.globalAlpha=1),!s.isPlaying||u.showGhostPreview){const X=s.tokens,U=s.currentIndex;n.font=`400 ${j*.9*k}px ${$}`;const Z=j*.6*k;let se=z-Z;for(let B=U-1;B>=Math.max(0,U-4);B--){const J=X[B];if(!J)break;const K=J.originalText,re=n.measureText(K).width;se-=re;const ie=U-B,oe=Math.max(.08,.4-ie*.08);n.fillStyle=l.primaryText,n.globalAlpha=oe,n.fillText(K,se,I),se-=Z}let ce=z+_+E+c+m+Z;for(let B=U+1;B<=Math.min(X.length-1,U+4);B++){const J=X[B];if(!J)break;const K=J.originalText,re=n.measureText(K).width,ie=B-U,oe=Math.max(.08,.4-ie*.08);n.fillStyle=l.primaryText,n.globalAlpha=oe,n.fillText(K,ce,I),ce+=re+Z}n.globalAlpha=1}const te=s.progress,V=C*.92*k,M=2*k,q=32*k,L=S*k-q*2;n.fillStyle=l.primaryText,n.globalAlpha=.1,n.beginPath(),n.roundRect(q,V,L,M,M/2),n.fill(),n.fillStyle="#E25822",n.globalAlpha=.2,n.beginPath(),n.roundRect(q,V,L*te,M,M/2),n.fill(),n.globalAlpha=1},[l,u,b,f]),p=o.useCallback(()=>{d(),s.isPlaying&&(a.current=requestAnimationFrame(p))},[d]);o.useEffect(()=>{const y=e.current,n=i.current;if(!y||!n)return;const g=window.devicePixelRatio||1;w.current=g;const F=()=>{const S=n.clientWidth,C=n.clientHeight;y.width=S*g,y.height=C*g,y.style.width=`${S}px`,y.style.height=`${C}px`,d()};F(),window.addEventListener("resize",F);const k=s.subscribe(()=>{const S=s.currentIndex;(S!==t.current||!s.isPlaying)&&(t.current=S,s.isPlaying&&!a.current?p():s.isPlaying||(a.current&&(cancelAnimationFrame(a.current),a.current=null),d()))});return d(),()=>{window.removeEventListener("resize",F),k(),a.current&&cancelAnimationFrame(a.current)}},[d,p]),o.useEffect(()=>{d()},[l,u,d]);const T=o.useCallback(()=>{D.impactLight(),h?.()},[h]);return r.jsx("div",{ref:i,className:"absolute inset-0 select-none",style:{backgroundColor:l.background},onClick:T,children:r.jsx("canvas",{ref:e,className:"absolute inset-0 w-full h-full",style:{touchAction:"none"}})})}),ue=[/^chapter\s+(\d+|[ivxlc]+)\s*[:\-–—]?\s*(.*)$/i,/^(part|book|section|prologue|epilogue|interlude)\s*(\d*|[ivxlc]*)\s*[:\-–—]?\s*(.*)$/i,/^(\d+|[IVXLC]+)\.\s+(.+)$/,/^[★✦✧◆◇●○]\s+(.+)$/],je=[/^[\*\#\-–—]{3,}$/,/^[●○◆◇★✦✧]{1,5}$/,/^~{3,}$/,/^\s*\*\s*\*\s*\*\s*$/],Q=[/^(table of contents|contents|index)$/i,/^.{1,50}\s*\.{2,}\s*\d+$/,/^.{1,50}\s+\d+$/],Re=/^[""\u201C\u00AB\u2039]/,Pe=/[""\u201D\u00BB\u203A][,.]?\s*$/,_e=/^.{0,10}(said|asked|replied|whispered|shouted|murmured|exclaimed|cried|muttered|answered|continued|added|began|interrupted|called|demanded|insisted|suggested|warned|promised|admitted|agreed|announced|argued|begged|claimed|complained|confessed|declared|denied|doubted|explained|gasped|groaned|growled|grumbled|guessed|hinted|hissed|howled|huffed|hummed|inquired|joked|laughed|lied|mentioned|moaned|mumbled|mused|noted|observed|offered|ordered|pleaded|pointed out|prayed|pressed|proclaimed|proposed|protested|questioned|reasoned|recalled|remarked|reminded|repeated|reported|requested|responded|revealed|roared|sang|scolded|screamed|sighed|smiled|snapped|sneered|sobbed|spoke|stammered|stated|stormed|stuttered|swore|teased|threatened|told|urged|uttered|volunteered|vowed|wailed|warned|wept|wondered|yelled)\b/i,Le=[/^dear\s+.+[,:]/i,/^to\s+(whom|my|the)/i,/^(sincerely|regards|yours|best|love|cheers|respectfully|warmly),?$/i],Fe=60,Ee=[/^\s{4,}.+/,/^>\s+/],Y={bullet:/^[\•\-\*\◦\▪]\s+/,number:/^(\d+)[.)]\s+/,letter:/^([a-z])[.)]\s+/i},Me=[/^[""\u201C].{10,200}[""\u201D]\s*—/,/^[""\u201C].{10,200}[""\u201D]$/];class $e{static formatText(e){const i=[],s=this.splitIntoParagraphs(e);let l=!1,u=-1,a="paragraph",t=!1,w={inDialogue:!1,speaker:""},b=0;for(let f=0;f<Math.min(s.length,50);f++){const d=s[f].trim();if(Q[0].test(d)){l=!0;continue}if(l&&ue.some(p=>p.test(d))&&f>5){u=f;break}}l=!1;for(let f=0;f<s.length;f++){const d=s[f],p=d.trim();if(!p)continue;if(f<u){if(Q[0].test(p)){l=!0,i.push({type:"chapter-heading",content:p});continue}if(l&&(Q[1].test(p)||Q[2].test(p))){i.push({type:"toc-entry",content:p,metadata:{indentLevel:this.detectIndent(d)}});continue}}if(l=!1,je.some(g=>g.test(p))){i.push({type:"scene-break",content:"* * *"}),t=!0,b=0;continue}const T=this.matchChapterHeading(p);if(T){i.push({type:"chapter-heading",content:p,metadata:{chapterNumber:T.number}}),a="chapter-heading",t=!0,b=0;continue}if(t&&Me.some(g=>g.test(p))){i.push({type:"epigraph",content:p});continue}if(Le.some(g=>g.test(p))){i.push({type:"letter",content:p}),a="letter",t=!1;continue}const y=this.matchList(p);if(y){i.push({type:"list-item",content:y.content,metadata:{listStyle:y.style,listIndex:y.index}}),a="list-item";continue}if(Ee.some(g=>g.test(d))){i.push({type:"blockquote",content:p.replace(/^>\s*/,""),metadata:{indentLevel:this.detectIndent(d)}}),a="blockquote";continue}if(p.length<Fe&&!p.endsWith(".")?b++:b=0,b>=3){for(let g=i.length-1;g>=0&&g>=i.length-b;g--)i[g].type==="paragraph"&&(i[g].type="poetry");i.push({type:"poetry",content:p}),a="poetry";continue}const n=this.detectDialogue(p,w);if(n.isDialogue){w=n.context,n.isAttribution?i.push({type:"dialogue-attribution",content:p,metadata:{speaker:n.speaker}}):i.push({type:"dialogue",content:p,metadata:{speaker:w.speaker}}),a="dialogue",t=!1;continue}if(t&&a==="chapter-heading"){i.push({type:"first-paragraph",content:p,metadata:{isFirstInChapter:!0}}),a="first-paragraph",t=!1;continue}i.push({type:"paragraph",content:p}),a="paragraph",t=!1}return i}static splitIntoParagraphs(e){return e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(/\n\n+/)}static detectIndent(e){const i=e.match(/^(\s*)/);return i?Math.floor(i[1].length/2):0}static matchChapterHeading(e){for(const i of ue){const s=e.match(i);if(s){let l;const u=s[1];return/^\d+$/.test(u)?l=parseInt(u):/^[ivxlc]+$/i.test(u)&&(l=this.romanToInt(u)),{number:l}}}return e===e.toUpperCase()&&e.length<50&&e.length>2&&/[A-Z]/.test(e)?{}:null}static romanToInt(e){const i={i:1,v:5,x:10,l:50,c:100};let s=0;const l=e.toLowerCase();for(let u=0;u<l.length;u++){const a=i[l[u]]||0,t=i[l[u+1]]||0;a<t?s-=a:s+=a}return s}static matchList(e){if(e.match(Y.bullet))return{style:"bullet",content:e.replace(Y.bullet,"")};const s=e.match(Y.number);if(s)return{style:"number",content:e.replace(Y.number,""),index:parseInt(s[1])};const l=e.match(Y.letter);return l?{style:"letter",content:e.replace(Y.letter,""),index:l[1].toLowerCase().charCodeAt(0)-96}:null}static detectDialogue(e,i){const s=Re.test(e),l=Pe.test(e),u=_e.test(e);let a=i.speaker;if(u){const t=e.match(/([A-Z][a-z]+)\s+(said|asked|replied)/i)||e.match(/(said|asked|replied)\s+([A-Z][a-z]+)/i);t&&(a=t[1]===t[1].toLowerCase()?t[2]:t[1])}return s&&u?{isDialogue:!0,isAttribution:!0,speaker:a,context:{inDialogue:!1,speaker:a}}:s&&l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!1,speaker:a}}:i.inDialogue&&l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!1,speaker:i.speaker}}:s&&!l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!0,speaker:a}}:{isDialogue:!1,isAttribution:!1,context:{inDialogue:!1,speaker:""}}}}const he={paragraph:{},"chapter-heading":{fontSize:"1.5em",fontWeight:600,textAlign:"center",marginTop:"2em",marginBottom:"1.5em",letterSpacing:"0.05em"},"scene-break":{textAlign:"center",margin:"2em 0",fontSize:"1.2em",letterSpacing:"0.5em",color:"inherit",opacity:.5},dialogue:{marginLeft:"1em",marginBottom:"0.5em"},"dialogue-attribution":{marginLeft:"1em",marginBottom:"0.75em",fontStyle:"normal"},"toc-entry":{display:"flex",justifyContent:"space-between",borderBottom:"1px dotted currentColor",opacity:.8,padding:"0.25em 0"},letter:{fontStyle:"italic",marginLeft:"2em",marginRight:"2em",padding:"1em",borderLeft:"2px solid currentColor",opacity:.9},poetry:{fontStyle:"italic",marginLeft:"2em",whiteSpace:"pre-wrap",lineHeight:1.8},blockquote:{marginLeft:"1.5em",paddingLeft:"1em",borderLeft:"3px solid currentColor",opacity:.85,fontStyle:"italic"},"list-item":{marginLeft:"1.5em",marginBottom:"0.25em"},"first-paragraph":{},epigraph:{textAlign:"center",fontStyle:"italic",marginBottom:"2em",opacity:.8,fontSize:"0.95em"}},Ne=o.memo(({book:h,onToggleChrome:e,onRequestPlay:i,isRSVPActive:s})=>{const l=de.getInstance(),u=H.getInstance(),a=ee(),{settings:t,updateSettings:w}=le(),b=o.useRef(null),f=o.useRef(null),[d,p]=o.useState([]),[T,y]=o.useState(0),[n,g]=o.useState(!1),[F,k]=o.useState(0),[S,C]=o.useState(""),R=o.useRef(!1),P=o.useRef(null),v=o.useRef(t.fontSize);o.useEffect(()=>{console.log("[FlowReader] Initializing for book:",h.id,"chapters:",h.chapters?.length||0),g(!1),k(0),C(""),(async()=>{if(!h.chapters||h.chapters.length===0){console.log("[FlowReader] No chapters found, showing empty state"),g(!0),C("");return}try{console.log("[FlowReader] Loading core..."),await l.load(h);const m=l.contentStorage.string;if(console.log("[FlowReader] Content loaded, length:",m?.length||0),!m||m.trim().length===0){console.warn("[FlowReader] Content is empty after load"),g(!0);return}C(m),g(!0),k(1),console.log("[FlowReader] Ready!");const x=h.lastTokenIndex||0;u.loadContent(m,{tokenIndex:x}).then(()=>{console.log("[FlowReader] Tokens loaded:",u.tokens.length),p(u.tokens),y(u.currentIndex)}).catch(I=>console.error("[FlowReader] Token load failed:",I))}catch(m){console.error("[FlowReader] Init failed:",m),g(!0)}})()},[h.id]),o.useEffect(()=>u.subscribe(()=>{if(u.tokens.length>0&&u.tokens!==d&&p(u.tokens),y(u.currentIndex),!s&&f.current&&u.tokens.length>0){const m=u.progress,x=f.current.scrollHeight-f.current.clientHeight,I=m*x,A=f.current.scrollTop;Math.abs(I-A)>500&&(R.current=!0,f.current.scrollTo({top:I,behavior:"smooth"}),setTimeout(()=>{R.current=!1},600))}}),[s]),o.useEffect(()=>{const c=f.current;if(!c||!n||d.length===0||s)return;let m=!1;const x=()=>{R.current||m||(m=!0,requestAnimationFrame(()=>{if(!R.current&&c){const I=c.scrollTop/Math.max(1,c.scrollHeight-c.clientHeight),A=Math.floor(I*(d.length-1));Math.abs(A-u.currentIndex)>5&&(u.seek({tokenIndex:A}),l.saveProgress(A))}m=!1}))};return c.addEventListener("scroll",x,{passive:!0}),()=>c.removeEventListener("scroll",x)},[n,d.length,s]);const j=o.useCallback(c=>{if(c.touches.length===2){const m=c.touches[0].clientX-c.touches[1].clientX,x=c.touches[0].clientY-c.touches[1].clientY;P.current=Math.sqrt(m*m+x*x),v.current=t.fontSize}},[t.fontSize]),$=o.useCallback(c=>{if(c.touches.length===2&&P.current!==null){c.preventDefault();const m=c.touches[0].clientX-c.touches[1].clientX,x=c.touches[0].clientY-c.touches[1].clientY,A=Math.sqrt(m*m+x*x)/P.current,z=Math.round(Math.max(12,Math.min(40,v.current*A)));z!==t.fontSize&&w({fontSize:z})}},[t.fontSize,w]),N=o.useCallback(()=>{P.current=null},[]);o.useEffect(()=>{const c=f.current;if(c)return c.addEventListener("touchstart",j,{passive:!0}),c.addEventListener("touchmove",$,{passive:!1}),c.addEventListener("touchend",N,{passive:!0}),()=>{c.removeEventListener("touchstart",j),c.removeEventListener("touchmove",$),c.removeEventListener("touchend",N)}},[j,$,N]);const W=o.useMemo(()=>{if(d.length===0)return[];const c=[];let m=[],x=0,I="paragraph";const A=/^chapter\s+(\d+|[ivxlc]+)|^(part|book|section|prologue|epilogue)\s*/i,z=/^[\*\#\-–—]{3,}$|^[●○◆◇★]{1,5}$/,te=/^[""\u201C]/;for(let M=0;M<d.length;M++){const q=d[M];if(m.push(q),q.isParagraphEnd||M===d.length-1){const L=m.map(X=>X.originalText).join(" "),ne=V(L,I);c.push({tokens:m,startIndex:x,plainText:L,blockType:ne,metadata:I==="chapter-heading"?{isFirstInChapter:!0}:void 0}),I=ne,m=[],x=M+1}}function V(M,q){const L=M.trim();return z.test(L)?"scene-break":L.length<60&&(A.test(L)||L===L.toUpperCase()&&/[A-Z]/.test(L)&&L.length>2)?"chapter-heading":te.test(L)?"dialogue":q==="chapter-heading"?"first-paragraph":"paragraph"}return c},[d]),G=o.useCallback(c=>{D.impactMedium(),u.seek({tokenIndex:c}),i?.(c)},[i]),O=o.useCallback(()=>{u.toggle()},[]),_=t.fontFamily==="New York"?'"New York", "Iowan Old Style", Georgia, serif':t.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':t.fontFamily==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif";if(!n)return r.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:a.background},children:r.jsx("div",{className:"w-6 h-6 rounded-full border-2 animate-spin",style:{borderColor:`${a.accent}20`,borderTopColor:a.accent}})});const E=o.useMemo(()=>{if(d.length>0||!S)return null;try{const c=$e.formatText(S);return console.log("[FlowReader] Formatted blocks:",c?.length||0),c}catch(c){return console.error("[FlowReader] TextFormatter error:",c),null}},[d.length,S]);return r.jsxs("div",{ref:b,className:"absolute inset-0",children:[r.jsx("div",{ref:f,className:"absolute inset-0 overflow-y-auto overscroll-contain transition-opacity duration-300",style:{backgroundColor:a.background,opacity:s?u.isPlaying?0:.4:1,pointerEvents:s?"none":"auto"},onClick:e,children:r.jsxs("div",{className:"max-w-2xl mx-auto px-6 py-safe",style:{paddingTop:"calc(5rem + env(safe-area-inset-top))",paddingBottom:"12rem"},children:[E&&E.length>0&&E.map((c,m)=>r.jsx(Ae,{block:c,fontSize:t.fontSize,lineHeight:t.lineHeight,paragraphSpacing:t.paragraphSpacing,fontFamily:_,theme:a},m)),!E&&W.length>0&&W.map(c=>r.jsx(ze,{para:c,activeIndex:T,fontSize:t.fontSize,lineHeight:t.lineHeight,paragraphSpacing:t.paragraphSpacing,fontFamily:_,theme:a,onWordClick:G},c.startIndex)),!E&&W.length===0&&S&&r.jsx("p",{style:{color:a.primaryText,fontSize:`${t.fontSize}px`,fontFamily:_},children:S}),!S&&d.length===0&&r.jsxs("div",{style:{color:a.primaryText,textAlign:"center",paddingTop:"4rem"},children:[r.jsx("p",{style:{opacity:.5,fontSize:`${t.fontSize}px`},children:"Unable to load book content"}),r.jsxs("p",{style:{opacity:.3,fontSize:`${t.fontSize*.8}px`,marginTop:"0.5rem"},children:["Book chapters: ",h.chapters?.length||0]})]})]})}),r.jsx("div",{className:`absolute inset-0 transition-all duration-300 ${s?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}`,style:{transitionTimingFunction:"cubic-bezier(0.2, 0, 0, 1)"},children:r.jsx(Ie,{onTap:O})})]})}),Ae=o.memo(({block:h,fontSize:e,lineHeight:i,paragraphSpacing:s,fontFamily:l,theme:u})=>{const a={fontSize:`${e}px`,lineHeight:i,fontFamily:l,color:u.primaryText,textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},t=he[h.type];switch(h.type){case"chapter-heading":return r.jsx("h2",{style:{...a,...t,fontSize:`${e*1.5}px`},children:h.content});case"scene-break":return r.jsx("div",{style:{...a,...t},role:"separator",children:h.content});case"dialogue":case"dialogue-attribution":return r.jsx("p",{style:{...a,...t,marginBottom:`${s*.6}px`},children:h.content});case"toc-entry":const w=h.content.match(/^(.+?)(\s*\.{2,}\s*|\s{2,})(\d+)$/);return w?r.jsxs("div",{style:{...a,display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:"0.5em",marginBottom:"0.25em",paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel*1.5}em`:0},children:[r.jsx("span",{style:{flex:"1"},children:w[1].trim()}),r.jsx("span",{style:{borderBottom:"1px dotted currentColor",flex:"1",opacity:.3,marginBottom:"0.25em"}}),r.jsx("span",{style:{opacity:.6},children:w[3]})]}):r.jsx("p",{style:{...a,...t,marginBottom:"0.25em"},children:h.content});case"letter":return r.jsx("blockquote",{style:{...a,...t,marginBottom:`${s}px`,borderLeftColor:u.accent},children:h.content});case"poetry":return r.jsx("p",{style:{...a,...t,marginBottom:`${s*.5}px`},children:h.content});case"blockquote":return r.jsx("blockquote",{style:{...a,...t,marginBottom:`${s}px`,borderLeftColor:u.accent,paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel}em`:"1em"},children:h.content});case"list-item":const b=h.metadata?.listStyle==="number"?`${h.metadata.listIndex}. `:h.metadata?.listStyle==="letter"?`${String.fromCharCode(96+(h.metadata.listIndex||1))}. `:"• ";return r.jsxs("p",{style:{...a,...t,marginBottom:"0.25em"},children:[r.jsx("span",{style:{opacity:.6},children:b}),h.content]});case"first-paragraph":const f=h.content.charAt(0),d=h.content.slice(1);return r.jsxs("p",{style:{...a,marginBottom:`${s}px`,textAlign:"justify",textJustify:"inter-word"},children:[r.jsx("span",{style:{float:"left",fontSize:`${e*3.2}px`,lineHeight:.8,marginRight:"0.08em",marginTop:"0.05em",fontWeight:500,color:u.accent},children:f}),d]});case"epigraph":return r.jsx("p",{style:{...a,...t,marginBottom:`${s*2}px`,fontSize:`${e*.95}px`},children:h.content});case"paragraph":default:return r.jsx("p",{style:{...a,marginBottom:`${s}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em"},children:h.content})}}),ze=o.memo(({para:h,activeIndex:e,fontSize:i,lineHeight:s,paragraphSpacing:l,fontFamily:u,theme:a,onWordClick:t})=>{const w={fontSize:`${i}px`,lineHeight:s,fontFamily:u,color:a.primaryText,textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},b=he[h.blockType],f=(d,p=0)=>r.jsx(r.Fragment,{children:d.map((T,y)=>{const n=T.globalIndex===e;return r.jsxs(pe.Fragment,{children:[r.jsx("span",{onClick:g=>{g.stopPropagation(),t(T.globalIndex)},className:"inline rounded-sm cursor-pointer select-none transition-colors duration-150",style:{backgroundColor:n?a.accent:"transparent",color:n?"#FFFFFF":"inherit",padding:n?"0.1em 0.15em":"0",margin:n?"-0.1em -0.15em":"0"},children:T.originalText})," "]},T.id)})});switch(h.blockType){case"chapter-heading":return r.jsx("h2",{className:"cursor-pointer",style:{...w,...b,fontSize:`${i*1.5}px`},children:f(h.tokens)});case"scene-break":return r.jsx("div",{className:"cursor-pointer",style:{...w,...b},role:"separator",children:"* * *"});case"dialogue":return r.jsx("p",{className:"cursor-pointer",style:{...w,...b,marginBottom:`${l*.6}px`},children:f(h.tokens)});case"first-paragraph":const d=h.tokens[0],p=h.tokens.slice(1),T=d?.originalText?.charAt(0)||"",y=d?.originalText?.slice(1)||"";return r.jsxs("p",{className:"cursor-pointer",style:{...w,marginBottom:`${l}px`,textAlign:"justify",textJustify:"inter-word"},children:[r.jsx("span",{onClick:n=>{n.stopPropagation(),d&&t(d.globalIndex)},style:{float:"left",fontSize:`${i*3.2}px`,lineHeight:.8,marginRight:"0.08em",marginTop:"0.05em",fontWeight:500,color:e===d?.globalIndex?"#FFFFFF":a.accent,backgroundColor:e===d?.globalIndex?a.accent:"transparent",borderRadius:"0.1em",cursor:"pointer"},children:T}),y&&r.jsx("span",{onClick:n=>{n.stopPropagation(),d&&t(d.globalIndex)},className:"cursor-pointer",style:{backgroundColor:e===d?.globalIndex?a.accent:"transparent",color:e===d?.globalIndex?"#FFFFFF":"inherit"},children:y})," ",f(p)]});case"paragraph":default:return r.jsx("p",{className:"cursor-pointer transition-opacity hover:opacity-100",style:{...w,marginBottom:`${l}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em"},children:f(h.tokens)})}}),Be=o.memo(({book:h,onToggleRSVP:e,isRSVPActive:i,onSettingsClick:s})=>{const l=H.getInstance(),{settings:u,updateSettings:a}=le(),t=ee(),[w,b]=o.useState(!1),[f,d]=o.useState(0),[p,T]=o.useState(!1),y=o.useRef(null),n=o.useRef(null),g=o.useRef(!1),F=o.useRef(0),k=o.useRef(null),S=o.useRef(null),[C,R]=o.useState(!1),P=o.useRef(!1);o.useEffect(()=>{const c=()=>{if(b(l.isPlaying),!p){const x=l.progress;d(x),n.current&&(n.current.style.width=`${x*100}%`)}};c();const m=l.subscribe(c);return()=>m()},[p]);const v=o.useCallback(()=>l.getTimeRemainingFormatted(),[f]),j=o.useCallback(c=>{if(!y.current)return;c.preventDefault(),T(!0),g.current=l.isPlaying,g.current&&l.pause();const m=y.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(c.clientX-m.left)/m.width));d(x),n.current&&(n.current.style.width=`${x*100}%`),c.target.setPointerCapture(c.pointerId)},[]),$=o.useCallback(c=>{if(!p||!y.current)return;const m=y.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(c.clientX-m.left)/m.width));d(x),n.current&&(n.current.style.width=`${x*100}%`)},[p]),N=o.useCallback(c=>{if(!p||!y.current)return;const m=y.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(c.clientX-m.left)/m.width));l.seek({progress:x}),T(!1),g.current&&l.play(),D.impactMedium()},[p]),W=o.useCallback(()=>{const c=Date.now();c-F.current<200||(F.current=c,D.impactMedium(),e())},[e]),G=o.useCallback(c=>{D.impactLight();const m=Math.max(50,Math.min(1e3,(u.rsvpSpeed||250)+c));a({rsvpSpeed:m,hasCustomSpeed:!0})},[u.rsvpSpeed,a]),O=o.useCallback(()=>{i&&(D.impactLight(),P.current=l.isPlaying,l.seekByTokens(-10),S.current=setTimeout(()=>{R(!0),P.current&&l.pause(),k.current=setInterval(()=>{l.seekByTokens(-10),D.selectionChanged(),l.currentIndex<=0&&_()},150)},300))},[i]),_=o.useCallback(()=>{S.current&&clearTimeout(S.current),k.current&&clearInterval(k.current),S.current=null,k.current=null,C&&(R(!1),P.current&&l.play(),D.impactMedium())},[C]);o.useEffect(()=>()=>{k.current&&clearInterval(k.current),S.current&&clearTimeout(S.current)},[]);const E=o.useCallback(()=>{D.impactLight(),a({showGhostPreview:!u.showGhostPreview})},[u.showGhostPreview,a]);return r.jsxs("div",{className:"w-full backdrop-blur-xl rounded-2xl border overflow-hidden",style:{backgroundColor:`${t.surface}f0`,borderColor:t.borderColor},children:[r.jsx("div",{ref:y,className:"h-10 px-4 flex items-center cursor-pointer touch-none",onPointerDown:j,onPointerMove:$,onPointerUp:N,onPointerCancel:N,children:r.jsxs("div",{className:"w-full h-1 rounded-full relative",style:{backgroundColor:`${t.primaryText}10`},children:[r.jsx("div",{ref:n,className:"absolute top-0 left-0 h-full rounded-full",style:{backgroundColor:t.accent,width:`${f*100}%`}}),p&&r.jsx("div",{className:"absolute top-1/2 w-4 h-4 rounded-full border-2 border-white shadow-lg",style:{left:`${f*100}%`,transform:"translate(-50%, -50%)",backgroundColor:t.accent}})]})}),r.jsxs("div",{className:"flex items-center justify-between px-4 pb-4 gap-3",children:[r.jsxs("div",{className:"flex items-center h-11 rounded-xl border shrink-0",style:{borderColor:t.borderColor,backgroundColor:`${t.primaryText}05`},children:[r.jsx("button",{onClick:()=>G(-25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:t.secondaryText},children:r.jsx(ge,{size:16})}),r.jsx("div",{className:"px-2 min-w-[48px] text-center",children:r.jsx("span",{className:"text-xs font-bold tabular-nums",style:{color:t.primaryText},children:u.rsvpSpeed||250})}),r.jsx("button",{onClick:()=>G(25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:t.secondaryText},children:r.jsx(ye,{size:16})})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[i&&r.jsx("button",{onPointerDown:O,onPointerUp:_,onPointerLeave:_,onPointerCancel:_,className:`w-11 h-11 rounded-full flex items-center justify-center transition-all ${C?"scale-110":"active:scale-95"}`,style:{backgroundColor:C?`${t.accent}25`:`${t.primaryText}08`,color:C?t.accent:t.secondaryText},children:r.jsx(xe,{size:18,className:C?"animate-spin":"",style:{animationDirection:"reverse",animationDuration:"1s"}})}),r.jsx("button",{onClick:W,className:"w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform",style:{backgroundColor:t.accent,boxShadow:`0 4px 16px -2px ${t.accent}50`},children:i&&w?r.jsx(be,{size:22,className:"text-white fill-white"}):r.jsx(ke,{size:22,className:"text-white fill-white ml-0.5"})}),i&&r.jsx("button",{onClick:E,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:u.showGhostPreview?`${t.accent}25`:`${t.primaryText}08`,color:u.showGhostPreview?t.accent:t.secondaryText},children:r.jsx(we,{size:18,className:u.showGhostPreview?"fill-current":""})})]}),r.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[r.jsx("button",{onClick:s,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${t.primaryText}08`,color:t.secondaryText},children:r.jsx(Te,{size:18})}),r.jsx("span",{className:"text-xs font-medium tabular-nums min-w-[32px] text-right",style:{color:t.secondaryText},children:v()})]})]})]})}),Ye=({book:h,onClose:e})=>{const i=de.getInstance(),s=H.getInstance(),l=ee(),[u,a]=o.useState(!0),[t,w]=o.useState(!1),[b,f]=o.useState(!1),[d,p]=o.useState(!1),[T,y]=o.useState(!1),n=o.useRef(!1);o.useEffect(()=>{const v=()=>{const $=s.mode==="rsvp",N=s.isPlaying;w($),f(N),i.isRSVPMode=$};v();const j=s.subscribe(v);return()=>j()},[]),o.useEffect(()=>{const v=s.onPositionChange(j=>{i.saveProgress(j.tokenIndex)});return()=>v()},[]),o.useEffect(()=>()=>{s.pause(),s.mode==="rsvp"&&i.saveProgress(s.currentIndex),s.setMode("scroll"),s.clear()},[]),o.useEffect(()=>{const v=()=>{n.current||(n.current=!0,d||T?g():t&&(s.pause(),s.setMode("scroll"),a(!0)),n.current=!1)};return window.addEventListener("popstate",v),()=>window.removeEventListener("popstate",v)},[d,T,t]),o.useEffect(()=>{let v;return u&&t&&b&&(v=setTimeout(()=>a(!1),2500)),()=>clearTimeout(v)},[u,t,b]),o.useEffect(()=>{d&&s.isPlaying&&s.pause()},[d]);const g=o.useCallback(()=>{y(!0),setTimeout(()=>{p(!1),y(!1)},400)},[]),F=o.useCallback(()=>{const v=s.currentIndex,j=s.progress;s.pause(),i.saveProgress(v),s.setMode("scroll"),e(h.id,v,j)},[h.id,e]),k=o.useCallback(()=>{t?s.toggle():(s.setMode("rsvp"),n.current||window.history.pushState({rsvpMode:!0},"",window.location.href),s.play(),a(!1))},[t]),S=o.useCallback(v=>{s.seek({tokenIndex:v}),s.setMode("rsvp"),n.current||window.history.pushState({rsvpMode:!0},"",window.location.href),s.play(),a(!1)},[]),C=o.useCallback(()=>{n.current||window.history.pushState({modal:"settings"},"",window.location.href),p(!0)},[]),R=o.useCallback(()=>{a(v=>!v)},[]),P=o.useCallback(()=>{s.pause(),s.setMode("scroll"),a(!0)},[]);return r.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden m-0 p-0 animate-fadeIn",style:{backgroundColor:l.background},children:[r.jsx("div",{className:"absolute inset-0 z-10",children:r.jsx(Ne,{book:h,onToggleChrome:R,onRequestPlay:S,isRSVPActive:t})}),r.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50 pointer-events-auto",style:{bottom:"calc(2rem + env(safe-area-inset-bottom))"},children:r.jsx(Be,{book:h,onToggleRSVP:k,isRSVPActive:t,onSettingsClick:C})}),r.jsx("div",{className:`absolute top-0 left-0 right-0 z-[60] transition-transform duration-400 pointer-events-none ${u||t&&!b?"translate-y-0":"-translate-y-full"}`,style:{transitionTimingFunction:"cubic-bezier(0.16, 1, 0.3, 1)"},children:r.jsx("div",{className:"backdrop-blur-2xl border-b pt-safe-top py-4 px-5 flex items-center justify-between pointer-events-auto",style:{backgroundColor:l.dimmer,borderColor:l.borderColor},children:r.jsx("button",{onClick:t?P:F,className:"w-11 h-11 -ml-1 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${l.primaryText}08`,color:l.primaryText},children:r.jsx(Se,{size:20})})})}),(d||T)&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:T?"fadeOut 0.4s ease-out":"fadeIn 0.6s ease-out"},onClick:g}),r.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[32px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:l.background,animation:T?"slideDown 0.5s cubic-bezier(0.7, 0, 0.84, 0)":"slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1)"},children:r.jsx(ve,{onClose:g})})]}),r.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
      `})]})};export{Ye as ReaderContainer};
