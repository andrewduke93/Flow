import{r as t,j as s,R as ne}from"./animations-D9Wo9mUM.js";import{a as ee,b as K,c as Z,u as te,d as se,R as q}from"./rsvp-C4BxTOo3.js";import{u as Q}from"./index-BPjOvlZq.js";import{M as re,P as oe,m as ae,n as ie,o as le,S as ce,b as ue,p as de}from"./icons-Bsbxsu_x.js";import{SettingsSheet as fe}from"./SettingsSheet-jWv25j_H.js";import"./vendor-react-uIRdnfX0.js";import"./cloud-a20xGCo9.js";const he=t.memo(({text:g,fontSize:z,lineHeight:d,paragraphSpacing:S,fontFamily:r,textColor:p,startTokenIndex:m,onParagraphClick:a})=>s.jsx("p",{id:`p-${m}`,"data-start-index":m,onClick:()=>a(m),className:"reader-paragraph cursor-pointer transition-opacity hover:opacity-100",style:{fontSize:`${z}px`,lineHeight:d,marginBottom:`${S}px`,fontFamily:r==="New York"?'"New York", "Iowan Old Style", Georgia, serif':r==="OpenDyslexic"?'"OpenDyslexic", sans-serif':r==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif",color:p,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",overflowWrap:"break-word",letterSpacing:"-0.01em",wordSpacing:"0.02em",fontKerning:"normal",fontVariantLigatures:"common-ligatures",textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},children:g})),me=t.memo(({tokens:g,activeIndex:z,onWordClick:d,fontSize:S,lineHeight:r,paragraphSpacing:p,fontFamily:m,theme:a,startTokenIndex:o})=>{const u=t.useCallback(c=>{const f=c.target;if(f.dataset.idx){c.stopPropagation();const P=parseInt(f.dataset.idx||"-1"),v=parseInt(f.dataset.off||"0");P>=0&&d(P,v)}},[d]);return s.jsx("p",{id:`p-${o}`,"data-start-index":o,onClick:u,className:"reader-paragraph",style:{fontSize:`${S}px`,lineHeight:r,marginBottom:`${p}px`,fontFamily:m==="New York"?'"New York", "Iowan Old Style", Georgia, serif':m==="OpenDyslexic"?'"OpenDyslexic", sans-serif':m==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif",opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",overflowWrap:"break-word",letterSpacing:"-0.01em",wordSpacing:"0.02em",fontKerning:"normal",fontVariantLigatures:"common-ligatures",textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},children:g.map(c=>{const f=c.globalIndex===z;return s.jsxs(ne.Fragment,{children:[s.jsx("span",{id:`w-${c.globalIndex}`,"data-idx":c.globalIndex,"data-off":c.startOffset,className:"inline rounded-sm cursor-pointer select-none transition-colors duration-150",style:{backgroundColor:f?a.accent:"transparent",color:f?"#FFFFFF":"inherit",padding:f?"0.1em 0.15em":"0",margin:f?"-0.1em -0.15em":"0",boxDecorationBreak:"clone",WebkitBoxDecorationBreak:"clone"},children:c.originalText})," "]},c.id)})})}),pe=t.memo(({sectionIndex:g,paragraphs:z,activeParagraphIndex:d,activeIndex:S,onWordClick:r,onParagraphClick:p,fontSize:m,lineHeight:a,paragraphSpacing:o,fontFamily:u,theme:c})=>s.jsx("div",{children:z.map((f,P)=>{const v=g*30+P;return Math.abs(v-d)<=1?s.jsx(me,{startTokenIndex:f.startIndex,tokens:f.tokens,activeIndex:S,onWordClick:r,fontSize:m,lineHeight:a,paragraphSpacing:o,fontFamily:u,theme:c},v):s.jsx(he,{text:f.plainText,fontSize:m,lineHeight:a,paragraphSpacing:o,fontFamily:u,textColor:c.primaryText,startTokenIndex:f.startIndex,onParagraphClick:p},v)})})),xe=({book:g,onToggleChrome:z,onRequestRSVP:d,isActive:S})=>{const r=ee.getInstance(),p=K.getInstance(),m=Z.getInstance(),a=Q(),{settings:o,updateSettings:u}=te(),c=t.useRef(null),[f,P]=t.useState([]),[v,I]=t.useState(-1),E=t.useRef(-1),[b,T]=t.useState(!1),[L,$]=t.useState(0),[R,N]=t.useState(!1),j=t.useRef(!1),w=t.useRef(null),x=t.useRef(o.fontSize);t.useRef(null);const k=t.useCallback(e=>{I(e),E.current=e},[]),F=t.useCallback((e,n)=>{if(!c.current)return;let i=document.getElementById(`w-${e}`);if(!i){const Y=Array.from(c.current.querySelectorAll("p[data-start-index]"));let G=null,X=-1;for(const U of Y){const H=parseInt(U.dataset.startIndex||"-1");H<=e&&H>X&&(G=U,X=H)}i=G}if(!i){if(r.totalTokens>0){const Y=e/r.totalTokens,X=c.current.scrollHeight*Y;c.current.scrollTo({top:X,behavior:n?"smooth":"instant"})}return}j.current=!0;const h=c.current,C=h.clientHeight*.15;let M=i.offsetTop,W=i.offsetParent;for(;W&&W!==h;)M+=W.offsetTop,W=W.offsetParent;const J=M-C;h.scrollTo({top:Math.max(0,J),behavior:n?"smooth":"instant"}),setTimeout(()=>{j.current=!1},n?600:100)},[]),V=t.useCallback(e=>{if(e.touches.length===2){const n=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY;w.current=Math.sqrt(n*n+i*i),x.current=o.fontSize}},[o.fontSize]),O=t.useCallback(e=>{if(e.touches.length===2&&w.current!==null){e.preventDefault();const n=e.touches[0].clientX-e.touches[1].clientX,i=e.touches[0].clientY-e.touches[1].clientY,C=Math.sqrt(n*n+i*i)/w.current,M=Math.round(Math.max(12,Math.min(40,x.current*C)));M!==o.fontSize&&u({fontSize:M})}},[o.fontSize,u]),B=t.useCallback(()=>{w.current=null},[]);t.useEffect(()=>{const e=c.current;if(e)return e.addEventListener("touchstart",V,{passive:!0}),e.addEventListener("touchmove",O,{passive:!1}),e.addEventListener("touchend",B,{passive:!0}),()=>{e.removeEventListener("touchstart",V),e.removeEventListener("touchmove",O),e.removeEventListener("touchend",B)}},[V,O,B]),t.useEffect(()=>{"scrollRestoration"in history&&(history.scrollRestoration="manual"),T(!1),N(!1),j.current=!0;const n=(r.currentBook?.id===g.id?r.currentBook.lastTokenIndex:void 0)??g.lastTokenIndex;n!==void 0&&k(n);const i=r.subscribe(()=>{$(r.loadingProgress)});return(async()=>{if(T(!1),N(!1),$(0),P([]),!g.chapters||g.chapters.length===0){console.error("[TitanReaderView] Book has no chapters!",{bookId:g.id,title:g.title}),T(!0),N(!0);return}try{await r.load(g);const C=r.contentStorage.string;await p.prepare(C,{progress:0})}catch(C){console.error("[TitanReaderView] Initialization failed:",C)}finally{const C=m.tokens;P(C),T(!0),requestAnimationFrame(()=>{N(!0)})}})(),()=>i()},[g.id,k]),t.useEffect(()=>{const e=()=>{const i=r.currentBook?.lastTokenIndex;if(i===void 0)return;const h=Math.abs(i-E.current);if(h>0&&(k(i),h>10)){const C=r.isRSVPMode;F(i,C)}},n=r.onJump(e);return()=>n()},[k,F]),t.useLayoutEffect(()=>{if(!b||!R||f.length===0)return;const e=v>=0?v:g.lastTokenIndex??0;e>0?requestAnimationFrame(()=>{F(e,!1),j.current=!1}):j.current=!1},[b,R,f.length]),t.useEffect(()=>{const e=c.current;if(!e||!R||f.length===0)return;let n=!1;const i=()=>{j.current||n||(n=!0,requestAnimationFrame(()=>{if(!j.current&&e){const h=e.scrollTop/Math.max(1,e.scrollHeight-e.clientHeight),C=Math.floor(h*(f.length-1));Math.abs(C-E.current)>50&&(k(C),r.saveProgress(C))}n=!1}))};return e.addEventListener("scroll",i,{passive:!0}),()=>e.removeEventListener("scroll",i)},[R,f.length,k]);const A=t.useMemo(()=>{if(f.length===0)return[];const e=[];let n=[],i=-1;for(const h of f)i===-1&&(i=h.globalIndex),n.push(h),h.isParagraphEnd&&(e.push({tokens:n,startIndex:i,plainText:n.map(C=>C.originalText).join(" ")}),n=[],i=-1);return n.length>0&&e.push({tokens:n,startIndex:i===-1?0:i,plainText:n.map(h=>h.originalText).join(" ")}),e},[f]),_=t.useCallback((e,n)=>{k(e),r.saveProgress(e),d&&d(n,e)},[d,k]),D=t.useCallback(e=>{k(e),r.saveProgress(e)},[k]),y=t.useMemo(()=>A.findIndex(e=>v>=e.startIndex&&v<e.startIndex+e.tokens.length),[A,v]),l=t.useMemo(()=>{const e=[];for(let n=0;n<A.length;n+=30)e.push(A.slice(n,n+30));return e},[A]);return s.jsxs("div",{ref:c,className:"absolute inset-0 z-10 w-full h-full overflow-y-auto overflow-x-hidden custom-scrollbar",style:{backgroundColor:a.background,color:a.primaryText,scrollBehavior:"auto",WebkitOverflowScrolling:"touch",touchAction:"pan-y pinch-zoom",overscrollBehaviorY:"contain",transform:"translateZ(0)"},onClick:e=>{e.target===e.currentTarget&&z()},children:[!b&&s.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[100] pointer-events-auto",style:{backgroundColor:a.background},children:s.jsxs("div",{className:"flex flex-col items-center gap-6",children:[s.jsxs("div",{className:"w-12 h-12 relative",children:[s.jsx("div",{className:"absolute inset-0 rounded-full border-2 opacity-20",style:{borderColor:a.accent}}),s.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-t-transparent animate-spin",style:{borderColor:a.accent,borderTopColor:"transparent"}})]}),s.jsxs("div",{className:"flex flex-col items-center",children:[s.jsx("span",{className:"text-sm font-bold tracking-widest lowercase",style:{color:a.secondaryText},children:"loading"}),s.jsxs("span",{className:"text-xs font-mono mt-1 opacity-50",style:{color:a.primaryText},children:[Math.floor(L*100),"%"]})]})]})}),b&&f.length===0&&s.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[50] pointer-events-auto",style:{backgroundColor:a.background},children:s.jsxs("div",{className:"flex flex-col items-center gap-4 px-8 text-center",children:[s.jsx("div",{className:"text-4xl opacity-30",children:"ðŸ“–"}),s.jsx("span",{className:"text-lg font-medium",style:{color:a.secondaryText},children:"No content available"}),s.jsx("span",{className:"text-sm opacity-60",style:{color:a.secondaryText},children:"This book appears to be empty or failed to load."})]})}),s.jsxs("div",{className:"w-full min-h-[100dvh] box-border relative",style:{maxWidth:"680px",margin:"0 auto",padding:"80px 24px 160px 24px"},children:[l.map((e,n)=>s.jsx(pe,{sectionIndex:n,paragraphs:e,activeParagraphIndex:y,activeIndex:v,onWordClick:_,onParagraphClick:D,fontSize:o.fontSize,lineHeight:o.lineHeight,paragraphSpacing:o.paragraphSpacing,fontFamily:o.fontFamily,theme:a},n)),s.jsx("div",{className:"h-[40vh]"})]}),w.current!==null&&s.jsx("div",{className:"fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 px-6 py-3 rounded-2xl shadow-2xl z-[200] backdrop-blur-xl",style:{backgroundColor:`${a.surface}ee`,border:`1px solid ${a.borderColor}`},children:s.jsxs("span",{className:"text-2xl font-bold",style:{color:a.primaryText},children:[o.fontSize,"px"]})})]})},ge=t.memo(({onTap:g,onLongPressExit:z})=>{const d=K.getInstance(),S=Z.getInstance(),r=Q(),{settings:p}=te(),m=t.useRef(null),a=t.useRef(null),[o,u]=t.useState(0),[c,f]=t.useState([]),[P,v]=t.useState(!1),[I,E]=t.useState(0),b=t.useRef(-1),T=t.useRef([]),L=t.useRef(new Map),$="#E25822",R=35.5,N=p.fontSize||18,j=`clamp(${N*1.8}px, 8vw, ${N*3}px)`;t.useEffect(()=>{f(S.tokens),T.current=S.tokens,b.current=S.currentIndex,u(S.currentIndex),v(d.state===se.PLAYING);let y=null,l=!1;const e=()=>{l||(l=!0,y&&cancelAnimationFrame(y),y=requestAnimationFrame(()=>{l=!1;const h=S.currentIndex,C=d.state===se.PLAYING,M=S.tokens;v(C),M!==T.current&&(f(M),T.current=M),h!==b.current&&(b.current=h,u(h))}))},n=d.subscribe(e),i=S.subscribe(e);return e(),()=>{n(),i(),y&&cancelAnimationFrame(y)}},[]);const w=t.useMemo(()=>c[o]||null,[c,o]),x=!P||p.showGhostPreview,k=4,F=t.useMemo(()=>{if(c.length===0)return[];if(!x)return w?[{token:w,globalIdx:o}]:[];const y=Math.max(0,o-k),l=Math.min(c.length-1,o+k);return c.slice(y,l+1).map((e,n)=>({token:e,globalIdx:y+n}))},[c,o,x,k,w]),V=y=>{const l=Math.max(1,y.length);return l<=3?0:Math.min(l-1,Math.max(0,Math.floor(l*.3)))};t.useLayoutEffect(()=>{if(!a.current)return;const y=a.current,l=Array.from(y.children),n=(m.current?.clientWidth||window.innerWidth)*(R/100);L.current.clear(),l.forEach(h=>{const C=parseInt(h.dataset.idx||"0"),M=h.getBoundingClientRect(),W=y.getBoundingClientRect(),J=M.left-W.left;let Y=J+M.width/2;if(C===o&&w){const G=w.originalText,X=V(G);try{const U=h.querySelector?.("span:nth-child(2)");if(U?.getBoundingClientRect){const H=U.getBoundingClientRect();Y=(H.left+H.right)/2-W.left}else if(G.length>0){const H=M.width/G.length;Y=J+X*H+H/2}}catch{const U=M.width/Math.max(1,G.length);Y=J+X*U+U/2}}L.current.set(C,{left:J,width:M.width,center:Y})});const i=L.current.get(o);i&&E(n-i.center)},[F,o,w]);const O=t.useCallback(()=>{q.impactLight(),g?.()},[g]);if(!w)return null;const B=V(w.originalText),A=w.originalText.slice(0,B),_=w.originalText[B]||"",D=w.originalText.slice(B+1);return s.jsxs("div",{ref:m,role:"application","aria-label":"Speed reading view. Tap to pause/play.",className:"absolute inset-0 select-none overflow-hidden",style:{backgroundColor:r.background},onClick:O,children:[s.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:`radial-gradient(ellipse 90% 60% at ${R}% 42%, transparent 0%, ${r.background}90 100%)`}}),s.jsx("div",{className:"absolute top-[25%] bottom-[25%] w-[1.5px] z-0 pointer-events-none",style:{left:`${R}%`,backgroundColor:$,opacity:.12}}),s.jsxs("div",{className:"absolute inset-x-0 top-[42%] -translate-y-1/2 flex items-center justify-start overflow-visible z-20",children:[x&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"absolute left-0 top-[-50%] bottom-[-50%] w-24 z-30 pointer-events-none",style:{background:`linear-gradient(to right, ${r.background}, transparent)`}}),s.jsx("div",{className:"absolute right-0 top-[-50%] bottom-[-50%] w-24 z-30 pointer-events-none",style:{background:`linear-gradient(to left, ${r.background}, transparent)`}})]}),s.jsx("div",{ref:a,className:"flex items-baseline gap-4 whitespace-nowrap",style:{transform:`translate3d(${I}px, 0, 0)`,willChange:"transform"},children:F.map(({token:y,globalIdx:l})=>{const e=l===o,n=Math.abs(l-o),i=Math.max(.08,.4-n*.08);return e?s.jsxs("span",{"data-idx":l,className:"inline-flex items-baseline font-sans font-semibold",style:{fontSize:j,fontFamily:p.fontFamily==="New York"?"Georgia, serif":"system-ui, sans-serif"},children:[s.jsx("span",{style:{color:r.primaryText},children:A}),s.jsx("span",{style:{color:$,textShadow:`0 0 24px ${$}30`},children:_}),s.jsx("span",{style:{color:r.primaryText},children:D}),y.punctuation&&s.jsx("span",{style:{color:r.secondaryText,opacity:.4,marginLeft:"2px"},children:y.punctuation})]},y.id):s.jsx("span",{"data-idx":l,className:"font-sans",style:{fontSize:j,fontWeight:400,fontFamily:p.fontFamily==="New York"?"Georgia, serif":"system-ui, sans-serif",color:r.primaryText,opacity:i},children:y.originalText},y.id)})})]}),s.jsx("div",{className:"absolute bottom-8 left-8 right-8 h-[2px] rounded-full overflow-hidden opacity-20",children:s.jsx("div",{className:"h-full rounded-full transition-all duration-100",style:{width:`${c.length>0?o/c.length*100:0}%`,backgroundColor:$}})})]})}),be=t.memo(({book:g,onToggleRSVP:z,isRSVPActive:d,onSettingsClick:S})=>{const r=ee.getInstance(),p=K.getInstance(),m=Z.getInstance(),{settings:a,updateSettings:o}=te(),u=Q(),[c,f]=t.useState(!1),[P,v]=t.useState(0),[I,E]=t.useState(!1),b=t.useRef(null),T=t.useRef(null),L=t.useRef(!1),$=t.useRef(0),R=t.useRef(null),N=t.useRef(null),[j,w]=t.useState(!1),x=t.useRef(!1);t.useEffect(()=>{const l=()=>{if(f(m.isPlaying),!I){const h=r.totalTokens>0?p.currentTokenIndex/r.totalTokens:0;v(h),T.current&&(T.current.style.width=`${h*100}%`)}};l();const e=r.subscribe(l),n=m.subscribe(l),i=p.subscribe(l);return()=>{e(),n(),i()}},[I]);const k=t.useCallback(()=>{const l=Math.max(0,r.totalTokens-p.currentTokenIndex),e=a.rsvpSpeed||250,n=l/e;if(n<1)return"<1m";if(n<60)return`${Math.round(n)}m`;const i=Math.floor(n/60),h=Math.round(n%60);return`${i}h${h>0?` ${h}m`:""}`},[P,a.rsvpSpeed]),F=t.useCallback(l=>{if(!b.current)return;l.preventDefault(),E(!0),L.current=m.isPlaying,L.current&&m.stop();const e=b.current.getBoundingClientRect(),n=Math.max(0,Math.min(1,(l.clientX-e.left)/e.width));v(n),T.current&&(T.current.style.width=`${n*100}%`),l.target.setPointerCapture(l.pointerId)},[]),V=t.useCallback(l=>{if(!I||!b.current)return;const e=b.current.getBoundingClientRect(),n=Math.max(0,Math.min(1,(l.clientX-e.left)/e.width));v(n),T.current&&(T.current.style.width=`${n*100}%`)},[I]),O=t.useCallback(l=>{if(!I||!b.current)return;const e=b.current.getBoundingClientRect(),n=Math.max(0,Math.min(1,(l.clientX-e.left)/e.width)),i=Math.floor(n*r.totalTokens);p.seekToToken(i),E(!1),L.current&&m.start(),q.impactMedium()},[I]),B=t.useCallback(()=>{const l=Date.now();l-$.current<200||($.current=l,q.impactMedium(),z())},[z]),A=t.useCallback(l=>{q.impactLight();const e=Math.max(50,Math.min(1e3,(a.rsvpSpeed||250)+l));o({rsvpSpeed:e,hasCustomSpeed:!0})},[a.rsvpSpeed,o]),_=t.useCallback(()=>{d&&(q.impactLight(),x.current=m.isPlaying,p.seekByTokens(-10),N.current=setTimeout(()=>{w(!0),x.current&&m.stop(),R.current=setInterval(()=>{p.seekByTokens(-10),q.selectionChanged(),p.currentTokenIndex<=0&&D()},150)},300))},[d]),D=t.useCallback(()=>{N.current&&clearTimeout(N.current),R.current&&clearInterval(R.current),N.current=null,R.current=null,j&&(w(!1),x.current&&m.start(),q.impactMedium())},[j]);t.useEffect(()=>()=>{R.current&&clearInterval(R.current),N.current&&clearTimeout(N.current)},[]);const y=t.useCallback(()=>{q.impactLight(),o({showGhostPreview:!a.showGhostPreview})},[a.showGhostPreview,o]);return s.jsxs("div",{className:"w-full backdrop-blur-xl rounded-2xl border overflow-hidden",style:{backgroundColor:`${u.surface}f0`,borderColor:u.borderColor},children:[s.jsx("div",{ref:b,className:"h-10 px-4 flex items-center cursor-pointer touch-none",onPointerDown:F,onPointerMove:V,onPointerUp:O,onPointerCancel:O,children:s.jsxs("div",{className:"w-full h-1 rounded-full relative",style:{backgroundColor:`${u.primaryText}10`},children:[s.jsx("div",{ref:T,className:"absolute top-0 left-0 h-full rounded-full",style:{backgroundColor:u.accent,width:`${P*100}%`}}),I&&s.jsx("div",{className:"absolute top-1/2 w-4 h-4 rounded-full border-2 border-white shadow-lg",style:{left:`${P*100}%`,transform:"translate(-50%, -50%)",backgroundColor:u.accent}})]})}),s.jsxs("div",{className:"flex items-center justify-between px-4 pb-4 gap-3",children:[s.jsxs("div",{className:"flex items-center h-11 rounded-xl border shrink-0",style:{borderColor:u.borderColor,backgroundColor:`${u.primaryText}05`},children:[s.jsx("button",{onClick:()=>A(-25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:u.secondaryText},children:s.jsx(re,{size:16})}),s.jsx("div",{className:"px-2 min-w-[48px] text-center",children:s.jsx("span",{className:"text-xs font-bold tabular-nums",style:{color:u.primaryText},children:a.rsvpSpeed||250})}),s.jsx("button",{onClick:()=>A(25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:u.secondaryText},children:s.jsx(oe,{size:16})})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[d&&s.jsx("button",{onPointerDown:_,onPointerUp:D,onPointerLeave:D,onPointerCancel:D,className:`w-11 h-11 rounded-full flex items-center justify-center transition-all ${j?"scale-110":"active:scale-95"}`,style:{backgroundColor:j?`${u.accent}25`:`${u.primaryText}08`,color:j?u.accent:u.secondaryText},children:s.jsx(ae,{size:18,className:j?"animate-spin":"",style:{animationDirection:"reverse",animationDuration:"1s"}})}),s.jsx("button",{onClick:B,className:"w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform",style:{backgroundColor:u.accent,boxShadow:`0 4px 16px -2px ${u.accent}50`},children:d&&c?s.jsx(ie,{size:22,className:"text-white fill-white"}):s.jsx(le,{size:22,className:"text-white fill-white ml-0.5"})}),d&&s.jsx("button",{onClick:y,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:a.showGhostPreview?`${u.accent}25`:`${u.primaryText}08`,color:a.showGhostPreview?u.accent:u.secondaryText},children:s.jsx(ce,{size:18,className:a.showGhostPreview?"fill-current":""})})]}),s.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[s.jsx("button",{onClick:S,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${u.primaryText}08`,color:u.secondaryText},children:s.jsx(ue,{size:18})}),s.jsx("span",{className:"text-xs font-medium tabular-nums min-w-[32px] text-right",style:{color:u.secondaryText},children:k()})]})]})]})}),je=({book:g,onClose:z})=>{const d=ee.getInstance(),S=K.getInstance(),r=Z.getInstance(),p=Q(),[m,a]=t.useState(!0),[o,u]=t.useState(!1),[c,f]=t.useState(!1),[P,v]=t.useState(!1),[I,E]=t.useState(!1),b=t.useRef(!1);t.useEffect(()=>{const x=()=>{u(d.isRSVPMode),f(r.isPlaying)};x();const k=d.subscribe(x),F=r.subscribe(x);return()=>{k(),F()}},[]),t.useEffect(()=>()=>{r.stop(),d.isRSVPMode&&d.saveProgress(S.currentTokenIndex),d.isRSVPMode=!1},[]),t.useEffect(()=>{const x=()=>{b.current||(b.current=!0,P||I?T():o&&(r.stop(),d.isRSVPMode=!1,a(!0)),b.current=!1)};return window.addEventListener("popstate",x),()=>window.removeEventListener("popstate",x)},[P,I,o]),t.useEffect(()=>{let x;return m&&o&&c&&(x=setTimeout(()=>a(!1),2500)),()=>clearTimeout(x)},[m,o,c]),t.useEffect(()=>{P&&r.isPlaying&&r.stop()},[P]);const T=t.useCallback(()=>{E(!0),setTimeout(()=>{v(!1),E(!1)},400)},[]),L=t.useCallback(()=>{const x=S.currentTokenIndex,k=d.currentProgress;r.stop(),d.saveProgress(x),d.isRSVPMode=!1,z(g.id,x,k)},[g.id,z]),$=t.useCallback(()=>{o?r.isPlaying?r.stop():r.start():(d.isRSVPMode=!0,b.current||window.history.pushState({rsvpMode:!0},"",window.location.href),r.start(),a(!1))},[o]),R=t.useCallback((x,k)=>{S.seekToToken(k),d.isRSVPMode=!0,b.current||window.history.pushState({rsvpMode:!0},"",window.location.href),r.start(),a(!1)},[]),N=t.useCallback(()=>{b.current||window.history.pushState({modal:"settings"},"",window.location.href),v(!0)},[]),j=t.useCallback(()=>{a(x=>!x)},[]),w=t.useCallback(()=>{r.stop(),d.isRSVPMode=!1,a(!0)},[]);return s.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden m-0 p-0 animate-fadeIn",style:{backgroundColor:p.background},children:[s.jsx("div",{className:"absolute inset-0 z-10 transition-opacity duration-300",style:{opacity:o?c?0:.4:1,pointerEvents:o?"none":"auto"},children:s.jsx(xe,{book:g,onToggleChrome:j,onRequestRSVP:R,isActive:!o})}),o&&s.jsx("div",{className:"absolute inset-0 z-20",onClick:j,children:s.jsx(ge,{onTap:()=>{r.isPlaying?r.stop():r.start()}})}),s.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50 pointer-events-auto",style:{bottom:"calc(2rem + env(safe-area-inset-bottom))"},children:s.jsx(be,{book:g,onToggleRSVP:$,isRSVPActive:o,onSettingsClick:N})}),s.jsx("div",{className:`absolute top-0 left-0 right-0 z-[60] transition-transform duration-400 pointer-events-none ${m||o&&!c?"translate-y-0":"-translate-y-full"}`,style:{transitionTimingFunction:"cubic-bezier(0.16, 1, 0.3, 1)"},children:s.jsx("div",{className:"backdrop-blur-2xl border-b pt-safe-top py-4 px-5 flex items-center justify-between pointer-events-auto",style:{backgroundColor:p.dimmer,borderColor:p.borderColor},children:s.jsx("button",{onClick:o?w:L,className:"w-11 h-11 -ml-1 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${p.primaryText}08`,color:p.primaryText},children:s.jsx(de,{size:20})})})}),(P||I)&&s.jsxs(s.Fragment,{children:[s.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:I?"fadeOut 0.4s ease-out":"fadeIn 0.6s ease-out"},onClick:T}),s.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[32px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:p.background,animation:I?"slideDown 0.5s cubic-bezier(0.7, 0, 0.84, 0)":"slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1)"},children:s.jsx(fe,{onClose:T})})]}),s.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
      `})]})};export{je as ReaderContainer};
