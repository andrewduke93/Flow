import{r as o,j as e}from"./animations-D9Wo9mUM.js";import{u as Q,T as K}from"./index-B5XDJuKM.js";import{u as X,R as N}from"./rsvp-ChCL7CNZ.js";import{T as L}from"./cloud-uA1tuQWL.js";import{M as se,l as ne,m as re,n as oe,o as ae,P as ie,p as le,q as ce,E as de,r as he,s as ue,t as pe}from"./icons-DhCoUMbR.js";import"./vendor-react-uIRdnfX0.js";class R{constructor(){this.words=[],this.sourceText="",this.totalWords=0,this._position=0,this._isPlaying=!1,this._wpm=300,this.playbackTimer=null,this.positionListeners=new Set,this.playStateListeners=new Set}static getInstance(){return R.instance||(R.instance=new R),R.instance}load(n){if(this.stop(),this.sourceText=n,this.words=[],!n||n.length===0){this.totalWords=0;return}const r=Math.ceil(n.length/5);this.words=new Array(r);let t=0,s=-1,a=!0,d=!1;for(let h=0;h<=n.length;h++){const m=h<n.length?n[h]:" ",b=m===" "||m==="	"||m===`
`||m==="\r";if(m===`
`&&(d=!0),b&&!a&&s>=0){const k=n.slice(s,h);let f=0;const w=k[k.length-1];w==="."||w==="!"||w==="?"?f=2:(w===","||w===";"||w===":"||w==="â€”"||w==="â€“")&&(f=1),this.words[t]={text:k,start:s,end:h,index:t,trailingPause:f},t++,s=-1}else!b&&a&&(s=h,d&&t>0&&(this.words[t-1].trailingPause=3),d=!1);a=b}this.words.length=t,this.totalWords=t}get position(){return this._position}set position(n){const r=Math.max(0,Math.min(this.totalWords-1,n));r!==this._position&&(this._position=r,this.notifyPosition())}get progress(){return this.totalWords>0?this._position/this.totalWords:0}set progress(n){this.position=Math.floor(n*this.totalWords)}get total(){return this.totalWords}getWord(n){return this.words[n]||null}getCurrentWord(){return this.words[this._position]||null}getWindow(n,r){const t=Math.max(0,this._position-n),s=Math.min(this.totalWords,this._position+r);return this.words.slice(t,s)}getRange(n,r){const t=Math.max(0,n),s=Math.min(this.totalWords,t+r);return this.words.slice(t,s)}getParagraphs(n,r){const t=[];let s=[],a=n;for(let d=n;d<this.totalWords&&t.length<r;d++){const h=this.words[d];s.length===0&&(a=d),s.push(h),h.trailingPause===3&&(t.push({words:s,startIndex:a}),s=[])}return s.length>0&&t.length<r&&t.push({words:s,startIndex:a}),t}wordIndexFromProgress(n){return Math.floor(n*this.totalWords)}get isPlaying(){return this._isPlaying}get wpm(){return this._wpm}set wpm(n){this._wpm=Math.max(50,Math.min(1500,n)),this._isPlaying&&(this.stop(),this.play())}play(){this._isPlaying||this.totalWords===0||(this._isPlaying=!0,this.notifyPlayState(),this.scheduleNext())}stop(){this.playbackTimer!==null&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this._isPlaying&&(this._isPlaying=!1,this.notifyPlayState())}toggle(){this._isPlaying?this.stop():this.play()}scheduleNext(){if(!this._isPlaying)return;const n=this.getCurrentWord();if(!n){this.stop();return}let r=6e4/this._wpm;const t=n.trailingPause;t===1?r*=1.3:t===2?r*=1.8:t===3&&(r*=2.2);const s=n.text.length;s>10?r*=1.2:s>7?r*=1.1:s<=2&&(r*=.85),this.playbackTimer=window.setTimeout(()=>{this._position<this.totalWords-1?(this.position=this._position+1,this.scheduleNext()):this.stop()},r)}skipForward(n=10){this.position=this._position+n}skipBack(n=10){this.position=this._position-n}jumpToStart(){this.position=0}jumpToEnd(){this.position=this.totalWords-1}onPosition(n){return this.positionListeners.add(n),()=>this.positionListeners.delete(n)}onPlayState(n){return this.playStateListeners.add(n),()=>this.playStateListeners.delete(n)}notifyPosition(){const n=this._position;this.positionListeners.forEach(r=>r(n))}notifyPlayState(){const n=this._isPlaying;this.playStateListeners.forEach(r=>r(n))}getStats(){return{totalWords:this.totalWords,position:this._position,progress:this.progress,isPlaying:this._isPlaying,wpm:this._wpm}}cleanup(){this.stop(),this.words=[],this.sourceText="",this.totalWords=0,this._position=0}}const J={"New York":'"New York", "Iowan Old Style", Palatino, Georgia, serif',"SF Pro":'"SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif',OpenDyslexic:'"OpenDyslexic", "Comic Sans MS", sans-serif',"Atkinson Hyperlegible":'"Atkinson Hyperlegible", Verdana, sans-serif'},xe=o.memo(({word:c,fontSize:n,fontFamily:r,textColor:t,accentColor:s})=>{const a=c.text,d=a.length<=1?0:a.length<=5?1:a.length<=9?2:a.length<=13?3:Math.floor(a.length*.35),h=a.slice(0,d),m=a[d]||"",b=a.slice(d+1);return e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr auto 1fr",alignItems:"baseline",fontFamily:r,fontSize:`${n}px`,fontWeight:500,whiteSpace:"nowrap",width:"100%",maxWidth:"90vw"},children:[e.jsx("span",{style:{color:t,textAlign:"right",paddingRight:"2px"},children:h}),e.jsx("span",{style:{color:s,fontWeight:700},children:m}),e.jsx("span",{style:{color:t,textAlign:"left",paddingLeft:"2px"},children:b})]})}),me=o.memo(({words:c,startIndex:n,isHighlighted:r,fontSize:t,lineHeight:s,paragraphSpacing:a,fontFamily:d,textColor:h,accentColor:m,tappedWord:b,onParagraphClick:p,onWordClick:k})=>e.jsx("p",{"data-start":n,onClick:()=>p(n),style:{fontSize:`${t}px`,lineHeight:s,marginBottom:`${a}px`,marginTop:0,fontFamily:d,color:h,textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto",textRendering:"optimizeLegibility",cursor:"text",opacity:r?1:.85,transition:"opacity 0.2s ease"},children:c.map((f,w)=>e.jsxs("span",{"data-index":f.index,onClick:T=>{T.stopPropagation(),k(f.index)},style:{cursor:"pointer",userSelect:"none",WebkitUserSelect:"none",marginRight:"0.25ch",padding:"0 0.15ch",borderRadius:4,transition:"transform 120ms ease, background-color 120ms ease",transform:b===f.index?"translateY(-2px) scale(1.02)":"none",backgroundColor:b===f.index?"rgba(255,215,0,0.12)":"transparent"},children:[f.text,w<c.length-1?" ":""]},f.index))})),fe=({book:c,onToggleChrome:n,isActive:r,showGhostWords:t=!0})=>{const s=R.getInstance(),a=Q(),{settings:d}=X(),h=o.useRef(null),m=o.useRef(null),[b,p]=o.useState(!1),[k,f]=o.useState(!1),[w,T]=o.useState(null),[H,_]=o.useState(-1),B=o.useRef(!1),I=o.useRef(0),C=o.useRef(!1),P=o.useRef(),$=o.useRef(null),[V,F]=o.useState(null),E=J[d.fontFamily]||J["SF Pro"],Y=Math.min(d.fontSize*2.5,60),j=o.useMemo(()=>{if(!b)return[];const i=[],x=s.getRange(0,s.total);if(x.length===0)return i;let g=[],y=0;for(let l=0;l<x.length;l++){const v=x[l];g.length===0&&(y=v.index),g.push(v),(v.trailingPause===3||l===x.length-1)&&(i.push({words:g.slice(),startIndex:y}),g=[])}return i},[b]);o.useEffect(()=>{if(!c.chapters||c.chapters.length===0){p(!0);return}p(!1);const i=[...c.chapters].sort((y,l)=>y.sortOrder-l.sortOrder),x=[];for(const y of i)if(y.content){const l=y.content.replace(/<[^>]*>/g," ").replace(/&[a-z]+;/gi," ").replace(/\s+/g," ").trim();l&&x.push(l)}const g=x.join(`

`);s.load(g),c.lastTokenIndex!==void 0&&c.lastTokenIndex>0?s.position=Math.min(c.lastTokenIndex,s.total-1):c.bookmarkProgress&&c.bookmarkProgress>0&&(s.progress=c.bookmarkProgress),s.wpm=d.rsvpSpeed||300,I.current=s.position,T(s.getCurrentWord()),p(!0),requestAnimationFrame(()=>{O(s.position,!1)})},[c.id]),o.useEffect(()=>{if(!b)return;const i=l=>{I.current=l;const v=s.getWord(l);T(v);const z=j.findIndex((M,W)=>{const D=j[W+1]?.startIndex??1/0;return l>=M.startIndex&&l<D});_(z),k||O(l,!1),P.current&&clearTimeout(P.current),P.current=setTimeout(()=>{L.getInstance().saveBook({...c,lastTokenIndex:l,bookmarkProgress:s.progress,lastOpened:new Date})},500)},x=l=>{B.current=l,f(l),l||L.getInstance().saveBook({...c,lastTokenIndex:s.position,bookmarkProgress:s.progress,lastOpened:new Date})},g=s.onPosition(i),y=s.onPlayState(x);return i(s.position),x(s.isPlaying),()=>{g(),y(),P.current&&clearTimeout(P.current)}},[b,j,c]);const O=o.useCallback((i,x)=>{if(!m.current||!h.current)return;C.current=!0;const g=j.findIndex((y,l)=>{const v=j[l+1]?.startIndex??1/0;return i>=y.startIndex&&i<v});if(g>=0){const y=m.current.children[g];if(y){const l=h.current,v=y.offsetTop,z=y.offsetHeight,M=l.clientHeight,W=v-M/2+z/2;l.scrollTo({top:Math.max(0,W),behavior:"instant"})}}setTimeout(()=>{C.current=!1},50)},[j]),A=o.useCallback(()=>{if(C.current||k)return;const i=h.current;if(!i)return;const x=i.scrollTop,g=i.clientHeight,y=x+g/2,l=m.current?.children;if(!l)return;let v=0,z=1/0;for(let W=0;W<l.length;W++){const D=l[W],Z=D.offsetTop,ee=D.offsetHeight,te=Z+ee/2,U=Math.abs(te-y);U<z&&(z=U,v=W)}const M=j[v];M&&M.startIndex!==s.position&&(s.position=M.startIndex)},[j,k]),G=o.useCallback(i=>{N.impactLight(),s.position=i,s.play()},[]),q=o.useCallback(i=>{N.impactLight(),s.position=i,F(i),$.current&&clearTimeout($.current),$.current=setTimeout(()=>F(null),350),s.play()},[]),u=o.useCallback(()=>{N.impactMedium(),s.toggle()},[]),S=o.useCallback(i=>{i.target.dataset?.start===void 0&&n()},[n]);return b?j.length===0?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:a.background},children:e.jsxs("div",{className:"text-center px-8",children:[e.jsx("div",{className:"text-5xl mb-4",children:"ðŸ“š"}),e.jsx("p",{className:"text-lg font-medium",style:{color:a.secondaryText},children:"no content found"})]})}):k&&w?e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center select-none",style:{backgroundColor:a.background},onClick:u,children:[e.jsx(xe,{word:w,fontSize:Y,fontFamily:E,textColor:a.primaryText,accentColor:a.accent}),e.jsx("div",{className:"absolute left-8 right-8 bottom-8 h-1 rounded-full overflow-hidden",style:{backgroundColor:a.borderColor},children:e.jsx("div",{className:"h-full rounded-full",style:{width:`${s.progress*100}%`,backgroundColor:a.accent,opacity:.6,transition:"width 100ms linear"}})}),e.jsx("div",{className:"absolute top-8 left-1/2 -translate-x-1/2 text-xs uppercase tracking-widest",style:{color:a.secondaryText,opacity:.4},children:"tap to pause"})]}):e.jsx("div",{ref:h,className:"absolute inset-0 overflow-y-auto overflow-x-hidden",style:{backgroundColor:a.background,WebkitOverflowScrolling:"touch"},onClick:S,onScroll:A,children:e.jsx("div",{ref:m,className:"w-full min-h-full",style:{maxWidth:"65ch",margin:"0 auto",padding:"80px 24px 200px"},children:j.map((i,x)=>e.jsx(me,{words:i.words,startIndex:i.startIndex,isHighlighted:x===H,fontSize:d.fontSize,lineHeight:d.lineHeight,paragraphSpacing:d.paragraphSpacing,fontFamily:E,textColor:a.primaryText,accentColor:a.accent,tappedWord:V,onParagraphClick:g=>G(g),onWordClick:g=>q(g)},i.startIndex))})}):e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:a.background},children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 border-2 rounded-full animate-spin",style:{borderColor:a.accent,borderTopColor:"transparent"}}),e.jsx("span",{className:"text-sm lowercase tracking-wider",style:{color:a.secondaryText},children:"loading"})]})})},je=({book:c,onClose:n})=>{const r=R.getInstance(),t=Q(),{settings:s,updateSettings:a}=X(),[d,h]=o.useState(!0),[m,b]=o.useState(!1),[p,k]=o.useState(0),[f,w]=o.useState(s.rsvpSpeed||300),[T,H]=o.useState(s.showGhostPreview??!0),[_,B]=o.useState(!1),I=o.useRef(),C=o.useRef();o.useEffect(()=>{r.wpm=s.rsvpSpeed||300,w(r.wpm),H(s.showGhostPreview??!0);const u=r.onPosition(i=>{k(r.progress),C.current&&clearTimeout(C.current),C.current=setTimeout(()=>{const x={...c,lastTokenIndex:i,bookmarkProgress:r.progress,lastOpened:new Date};L.getInstance().saveBook(x)},200)}),S=r.onPlayState(i=>{if(b(i),i)I.current=setTimeout(()=>h(!1),3e3);else{h(!0),C.current&&clearTimeout(C.current);const x={...c,lastTokenIndex:r.position,bookmarkProgress:r.progress,lastOpened:new Date};L.getInstance().saveBook(x)}});return()=>{if(u(),S(),I.current&&clearTimeout(I.current),C.current){clearTimeout(C.current);const i={...c,lastTokenIndex:r.position,bookmarkProgress:r.progress,lastOpened:new Date};L.getInstance().saveBook(i)}}},[c.id]),o.useEffect(()=>()=>r.stop(),[]);const P=o.useCallback(()=>{r.stop(),n(c.id,r.position,r.progress)},[c.id,n]),$=o.useCallback(()=>{N.impactMedium(),r.toggle()},[]),V=o.useCallback(()=>{N.impactLight(),r.skipBack(50)},[]),F=o.useCallback(u=>{N.impactLight();const S=Math.max(100,Math.min(800,f+u));r.wpm=S,w(S),a({rsvpSpeed:S,hasCustomSpeed:!0})},[f,a]),E=o.useCallback(()=>{N.impactLight();const u=!T;H(u),a({showGhostPreview:u})},[T,a]),Y=o.useCallback(()=>{N.impactLight();const u=K.getInstance(),S=u.mode,i=S==="Night"?"Modern":S==="Modern"?"Sepia":"Night";u.setMode(i)},[]),j=o.useCallback(()=>{I.current&&clearTimeout(I.current),h(u=>!u),B(!1)},[]),O=o.useCallback(u=>{r.progress=parseFloat(u.target.value)},[]),A=o.useCallback(u=>{N.impactLight();const S=Math.max(14,Math.min(32,s.fontSize+u));a({fontSize:S})},[s.fontSize,a]);o.useEffect(()=>{const u=()=>{m?r.stop():P()};return window.addEventListener("popstate",u),()=>window.removeEventListener("popstate",u)},[m,P]);const G=K.getInstance(),q=G.mode==="Night"?se:G.mode==="Sepia"?ne:re;return e.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden",style:{backgroundColor:t.background},children:[e.jsx(fe,{book:c,onToggleChrome:j,isActive:!0,showGhostWords:T}),e.jsx("div",{className:"fixed left-0 right-0 z-[60] flex justify-center pointer-events-none",style:{bottom:"max(20px, env(safe-area-inset-bottom))"},children:e.jsxs("div",{className:`pointer-events-auto shadow-xl backdrop-blur-2xl border flex flex-col rounded-2xl overflow-hidden transition-all duration-300 ease-out ${d?"translate-y-0 opacity-100":"translate-y-4 opacity-0"}`,style:{backgroundColor:t.surface+"f0",borderColor:t.borderColor,maxWidth:"420px",width:"calc(100% - 24px)"},children:[e.jsxs("div",{className:"px-4 pt-3 pb-1",children:[e.jsx("input",{type:"range",min:"0",max:"1",step:"0.0001",value:p,onChange:O,className:"w-full h-1.5 rounded-full appearance-none cursor-pointer touch-pan-x",style:{background:`linear-gradient(to right, ${t.accent} ${p*100}%, ${t.borderColor} ${p*100}%)`}}),e.jsxs("div",{className:"flex justify-between mt-1.5 px-0.5",children:[e.jsx("span",{className:"text-[10px] tabular-nums",style:{color:t.secondaryText,opacity:.6},children:p<.1?"ðŸŒ± just starting":p<.25?`${Math.round(p*100)}% ðŸŒ¿`:p<.5?`${Math.round(p*100)}% ðŸ“– nice pace`:p<.75?`${Math.round(p*100)}% âœ¨ halfway!`:p<.9?`${Math.round(p*100)}% ðŸ”¥ almost there`:`${Math.round(p*100)}% ðŸŽ¯ so close!`}),e.jsxs("span",{className:"text-[10px] tabular-nums",style:{color:t.secondaryText,opacity:.6},children:["~",Math.round((1-p)*r.total/Math.max(1,f)),"m left"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 px-1.5 pb-2",children:[e.jsx("button",{onClick:V,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Rewind",children:e.jsx(oe,{size:18})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:()=>F(-25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Slower",children:e.jsx(ae,{size:16})}),e.jsxs("div",{className:"h-9 px-2 rounded-xl flex items-center justify-center gap-1 min-w-[70px]",style:{backgroundColor:`${t.primaryText}06`},children:[e.jsx("span",{className:"text-sm font-bold tabular-nums",style:{color:t.primaryText},children:f}),e.jsx("span",{className:"text-[10px] lowercase opacity-50",style:{color:t.secondaryText},children:"wpm"})]}),e.jsx("button",{onClick:()=>F(25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Faster",children:e.jsx(ie,{size:16})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:$,className:"flex-1 flex items-center justify-center gap-1.5 h-9 rounded-xl font-semibold text-white shadow-md active:scale-[0.97] transition-all duration-150 text-sm hover:brightness-105",style:{backgroundColor:t.accent,minWidth:"80px"},"aria-label":m?"Pause":"Play",children:m?e.jsxs(e.Fragment,{children:[e.jsx(le,{size:16})," ",e.jsx("span",{className:"lowercase",children:"pause"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{size:16,className:"ml-0.5"})," ",e.jsx("span",{className:"lowercase",children:"flow~"})]})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:E,className:`w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90 ${T?"":"opacity-40"}`,style:{backgroundColor:T?`${t.accent}15`:"transparent",color:T?t.accent:t.secondaryText},"aria-label":"Toggle context",children:T?e.jsx(de,{size:17}):e.jsx(he,{size:17})}),e.jsx("button",{onClick:Y,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Toggle theme",children:e.jsx(q,{size:17})}),e.jsx("button",{onClick:()=>B(u=>!u),className:"w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90",style:{backgroundColor:_?`${t.accent}15`:"transparent",color:_?t.accent:t.secondaryText},"aria-label":"Text size",children:e.jsx(ue,{size:17})})]}),_&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t",style:{borderColor:t.borderColor},children:[e.jsx("span",{className:"text-xs lowercase",style:{color:t.secondaryText},children:"text size"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>A(-2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${t.primaryText}06`,color:t.primaryText},children:e.jsx("span",{className:"text-sm",children:"A"})}),e.jsx("span",{className:"text-sm font-semibold w-8 text-center tabular-nums",style:{color:t.primaryText},children:s.fontSize}),e.jsx("button",{onClick:()=>A(2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${t.primaryText}06`,color:t.primaryText},children:e.jsx("span",{className:"text-lg",children:"A"})})]})]})]})}),e.jsx("div",{className:`fixed top-0 left-0 right-0 z-[60] transition-all duration-300 ease-out ${d?"translate-y-0 opacity-100":"-translate-y-full opacity-0 pointer-events-none"}`,children:e.jsx("div",{className:"backdrop-blur-2xl border-b",style:{backgroundColor:`${t.surface}e8`,borderColor:t.borderColor,paddingTop:"max(12px, env(safe-area-inset-top))"},children:e.jsxs("div",{className:"flex items-center px-4 pb-3",children:[e.jsx("button",{onClick:P,className:"w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},"aria-label":"Back",children:e.jsx(pe,{size:22})}),e.jsxs("div",{className:"flex-1 mx-3 text-center",children:[e.jsx("h1",{className:"text-sm font-semibold truncate",style:{color:t.primaryText},children:c.title}),e.jsx("p",{className:"text-[10px] opacity-50 truncate",style:{color:t.secondaryText},children:c.author})]}),e.jsx("div",{className:"w-10"})]})})}),e.jsx("style",{children:`
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
          border: none;
        }
      `})]})};export{je as ReaderContainer};
