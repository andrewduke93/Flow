import{r as o,j as e,R as Y}from"./animations-D9Wo9mUM.js";import{u as R}from"./index-BBu6uEaj.js";import{u as $,R as z}from"./rsvp-eqVIbU96.js";import{SettingsSheet as H}from"./SettingsSheet-BX96PRFP.js";import{T as O}from"./cloud-Be3Yh6fZ.js";import{M as D,m as B,n as q,P as V,b as X,o as U}from"./icons-x0kDHYDe.js";import"./vendor-react-uIRdnfX0.js";class W{constructor(){this.words=[],this.sourceText="",this.totalWords=0,this._position=0,this._isPlaying=!1,this._wpm=300,this.playbackTimer=null,this.positionListeners=new Set,this.playStateListeners=new Set}static getInstance(){return W.instance||(W.instance=new W),W.instance}load(s){if(this.stop(),this.sourceText=s,this.words=[],!s||s.length===0){this.totalWords=0;return}const n=Math.ceil(s.length/5);this.words=new Array(n);let t=0,i=-1,l=!0,u=!1;for(let c=0;c<=s.length;c++){const m=c<s.length?s[c]:" ",w=m===" "||m==="	"||m===`
`||m==="\r";if(m===`
`&&(u=!0),w&&!l&&i>=0){const y=s.slice(i,c);let p=0;const x=y[y.length-1];x==="."||x==="!"||x==="?"?p=2:(x===","||x===";"||x===":"||x==="â€”"||x==="â€“")&&(p=1),this.words[t]={text:y,start:i,end:c,index:t,trailingPause:p},t++,i=-1}else!w&&l&&(i=c,u&&t>0&&(this.words[t-1].trailingPause=3),u=!1);l=w}this.words.length=t,this.totalWords=t}get position(){return this._position}set position(s){const n=Math.max(0,Math.min(this.totalWords-1,s));n!==this._position&&(this._position=n,this.notifyPosition())}get progress(){return this.totalWords>0?this._position/this.totalWords:0}set progress(s){this.position=Math.floor(s*this.totalWords)}get total(){return this.totalWords}getWord(s){return this.words[s]||null}getCurrentWord(){return this.words[this._position]||null}getWindow(s,n){const t=Math.max(0,this._position-s),i=Math.min(this.totalWords,this._position+n);return this.words.slice(t,i)}getRange(s,n){const t=Math.max(0,s),i=Math.min(this.totalWords,t+n);return this.words.slice(t,i)}getParagraphs(s,n){const t=[];let i=[],l=s;for(let u=s;u<this.totalWords&&t.length<n;u++){const c=this.words[u];i.length===0&&(l=u),i.push(c),c.trailingPause===3&&(t.push({words:i,startIndex:l}),i=[])}return i.length>0&&t.length<n&&t.push({words:i,startIndex:l}),t}wordIndexFromProgress(s){return Math.floor(s*this.totalWords)}get isPlaying(){return this._isPlaying}get wpm(){return this._wpm}set wpm(s){this._wpm=Math.max(50,Math.min(1500,s)),this._isPlaying&&(this.stop(),this.play())}play(){this._isPlaying||this.totalWords===0||(this._isPlaying=!0,this.notifyPlayState(),this.scheduleNext())}stop(){this.playbackTimer!==null&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this._isPlaying&&(this._isPlaying=!1,this.notifyPlayState())}toggle(){this._isPlaying?this.stop():this.play()}scheduleNext(){if(!this._isPlaying)return;const s=this.getCurrentWord();if(!s){this.stop();return}let n=6e4/this._wpm;const t=s.trailingPause;t===1?n*=1.3:t===2?n*=1.8:t===3&&(n*=2.2);const i=s.text.length;i>10?n*=1.2:i>7?n*=1.1:i<=2&&(n*=.85),this.playbackTimer=window.setTimeout(()=>{this._position<this.totalWords-1?(this.position=this._position+1,this.scheduleNext()):this.stop()},n)}skipForward(s=10){this.position=this._position+s}skipBack(s=10){this.position=this._position-s}jumpToStart(){this.position=0}jumpToEnd(){this.position=this.totalWords-1}onPosition(s){return this.positionListeners.add(s),()=>this.positionListeners.delete(s)}onPlayState(s){return this.playStateListeners.add(s),()=>this.playStateListeners.delete(s)}notifyPosition(){const s=this._position;this.positionListeners.forEach(n=>n(s))}notifyPlayState(){const s=this._isPlaying;this.playStateListeners.forEach(n=>n(s))}getStats(){return{totalWords:this.totalWords,position:this._position,progress:this.progress,isPlaying:this._isPlaying,wpm:this._wpm}}}const G=o.memo(({words:d,startIndex:s,activeIndex:n,isNearActive:t,fontSize:i,lineHeight:l,paragraphSpacing:u,fontFamily:c,textColor:m,accentColor:w,onWordTap:b})=>{const y=c==="New York"?'"New York", "Iowan Old Style", Georgia, serif':c==="OpenDyslexic"?'"OpenDyslexic", sans-serif':c==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif";if(!t){const p=d.map(x=>x.text).join(" ");return e.jsx("p",{"data-start":s,onClick:()=>b(s),style:{fontSize:`${i}px`,lineHeight:l,marginBottom:`${u}px`,fontFamily:y,color:m,textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto",cursor:"pointer",opacity:.9},children:p})}return e.jsx("p",{"data-start":s,style:{fontSize:`${i}px`,lineHeight:l,marginBottom:`${u}px`,fontFamily:y,color:m,textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto"},children:d.map((p,x)=>{const v=p.index===n;return e.jsxs(Y.Fragment,{children:[e.jsx("span",{"data-idx":p.index,onClick:S=>{S.stopPropagation(),b(p.index)},style:{backgroundColor:v?w:"transparent",color:v?"#FFFFFF":"inherit",padding:v?"2px 4px":"0",margin:v?"-2px -4px":"0",borderRadius:v?"4px":"0",cursor:"pointer",transition:"background-color 0.1s ease"},children:p.text}),x<d.length-1?" ":""]},p.index)})})}),J=o.memo(({word:d,fontSize:s,fontFamily:n,textColor:t,accentColor:i})=>{if(!d)return null;const l=n==="New York"?'"New York", "Iowan Old Style", Georgia, serif':n==="OpenDyslexic"?'"OpenDyslexic", sans-serif':n==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif",u=d.text,c=u.length<=1?0:u.length<=5?1:u.length<=9?2:u.length<=13?3:4,m=u.slice(0,c),w=u[c]||"",b=u.slice(c+1),y=Math.min(s*2.5,72);return e.jsxs("div",{className:"flex items-center justify-center select-none",style:{fontFamily:l,fontSize:`${y}px`,fontWeight:500,letterSpacing:"0.02em"},children:[e.jsx("span",{style:{color:t,textAlign:"right",minWidth:"40%"},children:m}),e.jsx("span",{style:{color:i,fontWeight:700},children:w}),e.jsx("span",{style:{color:t,textAlign:"left",minWidth:"40%"},children:b})]})}),K=({book:d,onToggleChrome:s,isActive:n})=>{const t=W.getInstance(),i=R(),{settings:l,updateSettings:u}=$(),c=o.useRef(null),m=o.useRef(null),[w,b]=o.useState(!1),[y,p]=o.useState(0),[x,v]=o.useState(!1),[S,N]=o.useState(0),P=o.useRef(!1);o.useRef(0);const j=o.useRef(null),T=o.useRef(l.fontSize);o.useEffect(()=>{if(!d.chapters||d.chapters.length===0){b(!0);return}b(!1);const a=[...d.chapters].sort((h,r)=>h.sortOrder-r.sortOrder),g=[];for(const h of a)if(h.content){const r=h.content.replace(/<[^>]*>/g," ").replace(/&[a-z]+;/gi," ").replace(/\s+/g," ").trim();r&&g.push(r)}const f=g.join(`

`);t.load(f),N(t.total),d.lastTokenIndex!==void 0&&d.lastTokenIndex>0?t.position=d.lastTokenIndex:d.bookmarkProgress&&d.bookmarkProgress>0&&(t.progress=d.bookmarkProgress),t.wpm=l.wpm||300,p(t.position),b(!0),requestAnimationFrame(()=>{M(t.position,!1)})},[d.id]),o.useEffect(()=>{const a=t.onPosition(f=>{p(f),t.isPlaying&&M(f,!0),d.lastTokenIndex=f,d.bookmarkProgress=t.progress}),g=t.onPlayState(f=>{v(f)});return()=>{a(),g()}},[]);const M=o.useCallback((a,g)=>{if(!m.current||S===0)return;P.current=!0;const f=m.current.querySelector(`[data-start="${a}"]`);if(f){const h=c.current;if(h){const r=f.offsetTop-h.clientHeight*.3;h.scrollTo({top:Math.max(0,r),behavior:g?"smooth":"instant"})}}else{const h=c.current;if(h){const k=a/S*(h.scrollHeight-h.clientHeight);h.scrollTo({top:k,behavior:g?"smooth":"instant"})}}setTimeout(()=>{P.current=!1},g?500:50)},[S]);o.useEffect(()=>{const a=c.current;if(!a||!w)return;let g=!1;const f=()=>{P.current||g||(g=!0,requestAnimationFrame(()=>{if(!P.current&&a){const h=a.scrollTop/Math.max(1,a.scrollHeight-a.clientHeight),r=Math.floor(h*(S-1));Math.abs(r-y)>20&&(t.position=r)}g=!1}))};return a.addEventListener("scroll",f,{passive:!0}),()=>a.removeEventListener("scroll",f)},[w,S,y]),o.useEffect(()=>{const a=c.current;if(!a)return;const g=r=>{if(r.touches.length===2){const k=r.touches[0].clientX-r.touches[1].clientX,C=r.touches[0].clientY-r.touches[1].clientY;j.current=Math.sqrt(k*k+C*C),T.current=l.fontSize}},f=r=>{if(r.touches.length===2&&j.current!==null){r.preventDefault();const k=r.touches[0].clientX-r.touches[1].clientX,C=r.touches[0].clientY-r.touches[1].clientY,A=Math.sqrt(k*k+C*C)/j.current,L=Math.round(Math.max(12,Math.min(40,T.current*A)));L!==l.fontSize&&u({fontSize:L})}},h=()=>{j.current=null};return a.addEventListener("touchstart",g,{passive:!0}),a.addEventListener("touchmove",f,{passive:!1}),a.addEventListener("touchend",h,{passive:!0}),()=>{a.removeEventListener("touchstart",g),a.removeEventListener("touchmove",f),a.removeEventListener("touchend",h)}},[l.fontSize,u]);const I=o.useCallback(a=>{z.impactLight(),t.position=a,M(a,!0)},[M]),F=o.useCallback(()=>{z.impactMedium(),t.toggle()},[]),_=o.useMemo(()=>S===0?[]:t.getParagraphs(0,1e4),[S,w]);return w?S===0?e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:i.background},children:e.jsxs("div",{className:"text-center px-8",children:[e.jsx("div",{className:"text-4xl mb-4",children:"ðŸ“–"}),e.jsx("p",{style:{color:i.secondaryText},children:"No content available"})]})}):e.jsxs("div",{ref:c,className:"absolute inset-0 overflow-y-auto overflow-x-hidden",style:{backgroundColor:i.background,WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},onClick:a=>{a.target===a.currentTarget&&s()},children:[x&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",style:{backgroundColor:i.background},onClick:F,children:[e.jsx(J,{word:t.getCurrentWord(),fontSize:l.fontSize,fontFamily:l.fontFamily,textColor:i.primaryText,accentColor:i.accent}),e.jsx("div",{className:"absolute bottom-8 left-8 right-8",children:e.jsx("div",{className:"h-1 rounded-full overflow-hidden",style:{backgroundColor:`${i.primaryText}20`},children:e.jsx("div",{className:"h-full rounded-full transition-all duration-200",style:{backgroundColor:i.accent,width:`${t.progress*100}%`}})})}),e.jsx("div",{className:"absolute bottom-16 left-0 right-0 text-center",children:e.jsx("span",{className:"text-xs opacity-40",style:{color:i.secondaryText},children:"tap to pause"})})]}),e.jsx("div",{ref:m,className:"w-full min-h-full",style:{maxWidth:"680px",margin:"0 auto",padding:"80px 24px 200px 24px"},children:_.map((a,g)=>{const f=Math.abs(a.startIndex-y)<500;return e.jsx(G,{words:a.words,startIndex:a.startIndex,activeIndex:y,isNearActive:f,fontSize:l.fontSize,lineHeight:l.lineHeight,paragraphSpacing:l.paragraphSpacing,fontFamily:l.fontFamily,textColor:i.primaryText,accentColor:i.accent,onWordTap:I},a.startIndex)})})]}):e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:i.background},children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"w-10 h-10 border-2 rounded-full animate-spin",style:{borderColor:i.accent,borderTopColor:"transparent"}}),e.jsx("span",{className:"text-sm lowercase tracking-wider",style:{color:i.secondaryText},children:"loading"})]})})},rt=({book:d,onClose:s})=>{const n=W.getInstance(),t=R(),{settings:i,updateSettings:l}=$(),[u,c]=o.useState(!0),[m,w]=o.useState(!1),[b,y]=o.useState(0),[p,x]=o.useState(!1),[v,S]=o.useState(!1),[N,P]=o.useState(i.rsvpSpeed||300),j=o.useRef(),T=o.useRef();o.useEffect(()=>{n.wpm=i.rsvpSpeed||300,P(n.wpm);const r=n.onPosition(C=>{y(n.progress),T.current&&clearTimeout(T.current),T.current=setTimeout(()=>{const E={...d,lastTokenIndex:C,bookmarkProgress:n.progress,lastOpened:new Date};O.getInstance().saveBook(E)},500)}),k=n.onPlayState(C=>{w(C),C&&(j.current=setTimeout(()=>c(!1),2e3))});return()=>{r(),k(),j.current&&clearTimeout(j.current),T.current&&clearTimeout(T.current)}},[d.id]),o.useEffect(()=>()=>{n.stop()},[]),o.useEffect(()=>{p&&n.isPlaying&&n.stop()},[p]);const M=o.useCallback(()=>{n.stop(),s(d.id,n.position,n.progress)},[d.id,s]),I=o.useCallback(()=>{z.impactMedium(),n.toggle()},[]),F=o.useCallback(()=>{z.impactLight();const r=Math.max(50,N-50);n.wpm=r,P(r),l({rsvpSpeed:r,hasCustomSpeed:!0})},[N,l]),_=o.useCallback(()=>{z.impactLight();const r=Math.min(1e3,N+50);n.wpm=r,P(r),l({rsvpSpeed:r,hasCustomSpeed:!0})},[N,l]),a=o.useCallback(()=>{j.current&&clearTimeout(j.current),c(r=>!r)},[]),g=o.useCallback(r=>{const k=parseFloat(r.target.value);n.progress=k},[]),f=o.useCallback(()=>{window.history.pushState({modal:"settings"},"",window.location.href),x(!0)},[]),h=o.useCallback(()=>{S(!0),setTimeout(()=>{x(!1),S(!1)},350)},[]);return o.useEffect(()=>{const r=()=>{p||v?h():m&&n.stop()};return window.addEventListener("popstate",r),()=>window.removeEventListener("popstate",r)},[p,v,m,h]),e.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden animate-fadeIn",style:{backgroundColor:t.background},children:[e.jsx(K,{book:d,onToggleChrome:a,isActive:!0}),e.jsx("div",{className:`fixed left-0 right-0 z-[60] transition-all duration-300 ${u?"opacity-100 translate-y-0":"opacity-0 translate-y-8 pointer-events-none"}`,style:{bottom:"env(safe-area-inset-bottom, 0px)",padding:"0 16px 16px 16px"},children:e.jsxs("div",{className:"rounded-2xl backdrop-blur-xl border shadow-2xl overflow-hidden",style:{backgroundColor:`${t.dimmer}f0`,borderColor:t.borderColor},children:[e.jsx("div",{className:"px-4 pt-3",children:e.jsx("input",{type:"range",min:"0",max:"1",step:"0.001",value:b,onChange:g,className:"w-full h-1.5 rounded-full appearance-none cursor-pointer",style:{background:`linear-gradient(to right, ${t.accent} ${b*100}%, ${t.borderColor} ${b*100}%)`}})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-3",children:[e.jsx("button",{onClick:F,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(D,{size:18})}),e.jsxs("span",{className:"text-xs font-mono opacity-50 w-16 text-center",style:{color:t.secondaryText},children:[N," wpm"]}),e.jsx("button",{onClick:I,className:"w-14 h-14 rounded-full flex items-center justify-center transition-all active:scale-90 shadow-lg",style:{backgroundColor:t.accent,color:"#FFFFFF"},children:m?e.jsx(B,{size:24}):e.jsx(q,{size:24,className:"ml-1"})}),e.jsx("button",{onClick:_,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(V,{size:18})}),e.jsx("button",{onClick:f,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(X,{size:18})})]})]})}),e.jsx("div",{className:`fixed top-0 left-0 right-0 z-[60] transition-all duration-300 ${u?"opacity-100 translate-y-0":"opacity-0 -translate-y-full pointer-events-none"}`,children:e.jsxs("div",{className:"backdrop-blur-xl border-b pt-safe-top py-3 px-4 flex items-center justify-between",style:{backgroundColor:`${t.dimmer}f0`,borderColor:t.borderColor},children:[e.jsx("button",{onClick:M,className:"w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},children:e.jsx(U,{size:20})}),e.jsx("div",{className:"flex-1 mx-4 truncate text-center",children:e.jsx("span",{className:"text-sm font-medium",style:{color:t.primaryText},children:d.title})}),e.jsx("div",{className:"w-10"})," "]})}),(p||v)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:v?"fadeOut 0.35s ease-out":"fadeIn 0.4s ease-out"},onClick:h}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[28px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:t.background,animation:v?"slideDown 0.35s ease-in":"slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)"},children:e.jsx(H,{onClose:h})})]}),e.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
      `})]})};export{rt as ReaderContainer};
