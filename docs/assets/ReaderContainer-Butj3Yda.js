import{r as a,j as r,R as pe}from"./animations-D9Wo9mUM.js";import{T as me,b as fe,u as le,R as D,a as de}from"./rsvp-0BBpS2BC.js";import{u as ee}from"./index-CSDDBbZa.js";import{M as ge,P as ye,m as xe,n as be,o as ke,S as we,b as Te,p as Se}from"./icons-Bsbxsu_x.js";import{SettingsSheet as ve}from"./SettingsSheet-BuBiYPr0.js";import"./vendor-react-uIRdnfX0.js";import"./cloud-LWBW7V_C.js";const oe=new Set([".","!","?","…","‽"]),Ce=new Set([";",":","—","–"]);class H{constructor(){this._tokens=[],this._currentIndex=0,this._mode="scroll",this._playState="idle",this._wpm=250,this.animationFrameId=null,this.lastFrameTime=0,this.accumulatedTime=0,this.rampStep=3,this.wordsInSentence=0,this.listeners=new Set,this.positionListeners=new Set,this.completionListeners=new Set,this.notifyScheduled=!1,this.lastContentRef=null,this.preparationPromise=null,this.wakeLock=null,this.loop=i=>{if(this._playState!=="playing")return;if(this.lastFrameTime===0){this.lastFrameTime=i,this.animationFrameId=requestAnimationFrame(this.loop);return}const s=(i-this.lastFrameTime)/1e3;this.lastFrameTime=i;const l=Math.min(s,.1);this.accumulatedTime+=l;const c=this.currentToken;if(!c){this.finish();return}const o=60/this._wpm;let n=1;this.rampStep===0?n=2:this.rampStep===1?n=1.5:this.rampStep===2&&(n=1.2);let w=1;const b=c.originalText,m=b.charAt(b.length-1),d=b.charAt(b.length-2);oe.has(m)||m==='"'&&oe.has(d)||m==="”"&&oe.has(d)?(w=1+.3*Math.max(1,this._wpm/200),this.wordsInSentence=0):Ce.has(m)?w=1.15:this.wordsInSentence++;const T=o*c.durationMultiplier*n*w;this.accumulatedTime>=T&&(this.advance(),this.accumulatedTime-=T),this._playState==="playing"&&(this.animationFrameId=requestAnimationFrame(this.loop))};const e=me.getInstance();this._wpm=e.getSettings().rsvpSpeed||250,e.subscribe(()=>{const i=e.getSettings().rsvpSpeed;i!==this._wpm&&(this._wpm=i,this.notify())}),document.addEventListener("visibilitychange",async()=>{document.visibilityState==="visible"&&this._playState==="playing"&&await this.requestWakeLock()})}static getInstance(){return H.instance||(H.instance=new H),H.instance}get tokens(){return this._tokens}get currentIndex(){return this._currentIndex}get mode(){return this._mode}get playState(){return this._playState}get wpm(){return this._wpm}get isPlaying(){return this._playState==="playing"}get currentToken(){return this._tokens[this._currentIndex]||null}get progress(){return this._tokens.length===0?0:this._currentIndex/this._tokens.length}get position(){const e=this.currentToken;return{tokenIndex:this._currentIndex,progress:this.progress,characterOffset:e?.startOffset??0}}async loadContent(e,i){if(this.lastContentRef===e&&this._tokens.length>0){i&&this.seek(i);return}if(this.preparationPromise&&(await this.preparationPromise,this.lastContentRef===e)){i&&this.seek(i);return}this.preparationPromise=(async()=>{try{const s=await fe.process(e);this._tokens=s,this.lastContentRef=e}finally{this.preparationPromise=null}})(),await this.preparationPromise,i&&this.seek(i),this.notify()}clear(){this.pause(),this._tokens=[],this._currentIndex=0,this.lastContentRef=null,this.notify()}setMode(e){if(this._mode===e)return;this._playState==="playing"&&this.pause(),this._mode=e,e==="scroll"&&(this._playState="idle"),this.notify(),this.emitPosition()}play(){this._playState!=="playing"&&this._tokens.length!==0&&(this._mode!=="rsvp"&&(this._mode="rsvp"),this._currentIndex>=this._tokens.length-1&&(this._currentIndex=0),this._playState="playing",this.lastFrameTime=0,this.accumulatedTime=0,this._currentIndex===0&&(this.rampStep=0),this.requestWakeLock(),this.loop(performance.now()),this.notify())}pause(){this._playState==="playing"&&(this._playState="paused",this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.releaseWakeLock(),this.notify(),this.emitPosition())}toggle(){this._playState==="playing"?this.pause():this.play()}seek(e){const i=this._playState==="playing";if(i&&this.pause(),e.tokenIndex!==void 0)this._currentIndex=Math.max(0,Math.min(e.tokenIndex,this._tokens.length-1));else if(e.progress!==void 0)this._currentIndex=Math.floor(e.progress*this._tokens.length);else if(e.characterOffset!==void 0){const s=this._tokens.findIndex(l=>l.startOffset>=e.characterOffset);this._currentIndex=s>=0?s:this._tokens.length-1}this.accumulatedTime=0,this.notify(),this.emitPosition(),i&&this.play()}seekByTokens(e){const i=Math.max(0,Math.min(this._currentIndex+e,this._tokens.length-1));i!==this._currentIndex&&(this._currentIndex=i,this.accumulatedTime=0,this.notify(),this.emitPosition())}advance(){this._currentIndex<this._tokens.length-1?(this._currentIndex++,this.rampStep<3&&this.rampStep++,this.notify()):this.finish()}finish(){this.pause(),this._currentIndex=this._tokens.length-1,this._playState="idle",this.notify(),this.completionListeners.forEach(e=>e())}async requestWakeLock(){try{"wakeLock"in navigator&&(this.wakeLock=await navigator.wakeLock.request("screen"))}catch{}}releaseWakeLock(){this.wakeLock&&(this.wakeLock.release(),this.wakeLock=null)}subscribe(e){return this.listeners.add(e),()=>this.listeners.delete(e)}onPositionChange(e){return this.positionListeners.add(e),()=>this.positionListeners.delete(e)}onComplete(e){return this.completionListeners.add(e),()=>this.completionListeners.delete(e)}notify(){this._playState==="playing"&&!this.notifyScheduled?(this.notifyScheduled=!0,queueMicrotask(()=>{this.notifyScheduled=!1,this.listeners.forEach(e=>e())})):this._playState!=="playing"&&this.listeners.forEach(e=>e())}emitPosition(){const e=this.position;this.positionListeners.forEach(i=>i(e))}getTimeRemaining(){const e=this._tokens.length-this._currentIndex;return Math.ceil(e/this._wpm)}getTimeRemainingFormatted(){const e=this.getTimeRemaining();return e<1?"<1m":e>=60?`${Math.floor(e/60)}h`:`${e}m`}}const Ie=a.memo(({onTap:h})=>{const e=a.useRef(null),i=a.useRef(null),s=H.getInstance(),l=ee(),{settings:c}=le(),o=a.useRef(null),n=a.useRef(-1),w=a.useRef(1),b=a.useCallback(g=>{const t=Math.max(1,g.length);return t<=3?0:Math.min(t-1,Math.max(0,Math.floor(t*.3)))},[]),m=a.useCallback(()=>c.fontFamily==="New York"?"Georgia, serif":c.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':"system-ui, -apple-system, sans-serif",[c.fontFamily]),d=a.useCallback(()=>{const g=e.current,t=g?.getContext("2d");if(!g||!t)return;const y=s.currentToken,E=i.current;if(!E)return;const k=w.current,S=E.clientWidth,C=E.clientHeight;if(t.clearRect(0,0,g.width,g.height),!y)return;const P=y.originalText,R=b(P),v=c.fontSize||18,j=Math.min(v*3,Math.max(v*1.8,S*.08)),N=m();t.font=`600 ${j*k}px ${N}`,t.textBaseline="middle";const A=P.slice(0,R),W=P[R]||"",G=P.slice(R+1),O=y.punctuation||"",_=t.measureText(A).width,M=t.measureText(W).width,u=t.measureText(G).width,f=O?t.measureText(O).width:0,x=S*.355*k,I=C*.42*k,$=_+M/2,z=x-$;if(t.strokeStyle="#E25822",t.globalAlpha=.12,t.lineWidth=1.5*k,t.beginPath(),t.moveTo(x,C*.25*k),t.lineTo(x,C*.75*k),t.stroke(),t.globalAlpha=1,t.fillStyle=l.primaryText,t.fillText(A,z,I),t.fillStyle="#E25822",t.shadowColor="#E2582230",t.shadowBlur=24*k,t.fillText(W,z+_,I),t.shadowBlur=0,t.fillStyle=l.primaryText,t.fillText(G,z+_+M,I),O&&(t.fillStyle=l.secondaryText,t.globalAlpha=.4,t.fillText(O,z+_+M+u+2*k,I),t.globalAlpha=1),!s.isPlaying||c.showGhostPreview){const X=s.tokens,U=s.currentIndex;t.font=`400 ${j*.9*k}px ${N}`;const Z=j*.6*k;let se=z-Z;for(let B=U-1;B>=Math.max(0,U-4);B--){const J=X[B];if(!J)break;const K=J.originalText,re=t.measureText(K).width;se-=re;const ie=U-B,ae=Math.max(.08,.4-ie*.08);t.fillStyle=l.primaryText,t.globalAlpha=ae,t.fillText(K,se,I),se-=Z}let ce=z+_+M+u+f+Z;for(let B=U+1;B<=Math.min(X.length-1,U+4);B++){const J=X[B];if(!J)break;const K=J.originalText,re=t.measureText(K).width,ie=B-U,ae=Math.max(.08,.4-ie*.08);t.fillStyle=l.primaryText,t.globalAlpha=ae,t.fillText(K,ce,I),ce+=re+Z}t.globalAlpha=1}const te=s.progress,V=C*.92*k,F=2*k,q=32*k,L=S*k-q*2;t.fillStyle=l.primaryText,t.globalAlpha=.1,t.beginPath(),t.roundRect(q,V,L,F,F/2),t.fill(),t.fillStyle="#E25822",t.globalAlpha=.2,t.beginPath(),t.roundRect(q,V,L*te,F,F/2),t.fill(),t.globalAlpha=1},[l,c,b,m]),p=a.useCallback(()=>{d(),s.isPlaying&&(o.current=requestAnimationFrame(p))},[d]);a.useEffect(()=>{const g=e.current,t=i.current;if(!g||!t)return;const y=window.devicePixelRatio||1;w.current=y;const E=()=>{const S=t.clientWidth,C=t.clientHeight;g.width=S*y,g.height=C*y,g.style.width=`${S}px`,g.style.height=`${C}px`,d()};E(),window.addEventListener("resize",E);const k=s.subscribe(()=>{const S=s.currentIndex;(S!==n.current||!s.isPlaying)&&(n.current=S,s.isPlaying&&!o.current?p():s.isPlaying||(o.current&&(cancelAnimationFrame(o.current),o.current=null),d()))});return d(),()=>{window.removeEventListener("resize",E),k(),o.current&&cancelAnimationFrame(o.current)}},[d,p]),a.useEffect(()=>{d()},[l,c,d]);const T=a.useCallback(()=>{D.impactLight(),h?.()},[h]);return r.jsx("div",{ref:i,className:"absolute inset-0 select-none",style:{backgroundColor:l.background},onClick:T,children:r.jsx("canvas",{ref:e,className:"absolute inset-0 w-full h-full",style:{touchAction:"none"}})})}),ue=[/^chapter\s+(\d+|[ivxlc]+)\s*[:\-–—]?\s*(.*)$/i,/^(part|book|section|prologue|epilogue|interlude)\s*(\d*|[ivxlc]*)\s*[:\-–—]?\s*(.*)$/i,/^(\d+|[IVXLC]+)\.\s+(.+)$/,/^[★✦✧◆◇●○]\s+(.+)$/],je=[/^[\*\#\-–—]{3,}$/,/^[●○◆◇★✦✧]{1,5}$/,/^~{3,}$/,/^\s*\*\s*\*\s*\*\s*$/],Q=[/^(table of contents|contents|index)$/i,/^.{1,50}\s*\.{2,}\s*\d+$/,/^.{1,50}\s+\d+$/],Pe=/^[""\u201C\u00AB\u2039]/,Re=/[""\u201D\u00BB\u203A][,.]?\s*$/,_e=/^.{0,10}(said|asked|replied|whispered|shouted|murmured|exclaimed|cried|muttered|answered|continued|added|began|interrupted|called|demanded|insisted|suggested|warned|promised|admitted|agreed|announced|argued|begged|claimed|complained|confessed|declared|denied|doubted|explained|gasped|groaned|growled|grumbled|guessed|hinted|hissed|howled|huffed|hummed|inquired|joked|laughed|lied|mentioned|moaned|mumbled|mused|noted|observed|offered|ordered|pleaded|pointed out|prayed|pressed|proclaimed|proposed|protested|questioned|reasoned|recalled|remarked|reminded|repeated|reported|requested|responded|revealed|roared|sang|scolded|screamed|sighed|smiled|snapped|sneered|sobbed|spoke|stammered|stated|stormed|stuttered|swore|teased|threatened|told|urged|uttered|volunteered|vowed|wailed|warned|wept|wondered|yelled)\b/i,Le=[/^dear\s+.+[,:]/i,/^to\s+(whom|my|the)/i,/^(sincerely|regards|yours|best|love|cheers|respectfully|warmly),?$/i],Ee=60,Me=[/^\s{4,}.+/,/^>\s+/],Y={bullet:/^[\•\-\*\◦\▪]\s+/,number:/^(\d+)[.)]\s+/,letter:/^([a-z])[.)]\s+/i},Fe=[/^[""\u201C].{10,200}[""\u201D]\s*—/,/^[""\u201C].{10,200}[""\u201D]$/];class Ne{static formatText(e){const i=[],s=this.splitIntoParagraphs(e);let l=!1,c=-1,o="paragraph",n=!1,w={inDialogue:!1,speaker:""},b=0;for(let m=0;m<Math.min(s.length,50);m++){const d=s[m].trim();if(Q[0].test(d)){l=!0;continue}if(l&&ue.some(p=>p.test(d))&&m>5){c=m;break}}l=!1;for(let m=0;m<s.length;m++){const d=s[m],p=d.trim();if(!p)continue;if(m<c){if(Q[0].test(p)){l=!0,i.push({type:"chapter-heading",content:p});continue}if(l&&(Q[1].test(p)||Q[2].test(p))){i.push({type:"toc-entry",content:p,metadata:{indentLevel:this.detectIndent(d)}});continue}}if(l=!1,je.some(y=>y.test(p))){i.push({type:"scene-break",content:"* * *"}),n=!0,b=0;continue}const T=this.matchChapterHeading(p);if(T){i.push({type:"chapter-heading",content:p,metadata:{chapterNumber:T.number}}),o="chapter-heading",n=!0,b=0;continue}if(n&&Fe.some(y=>y.test(p))){i.push({type:"epigraph",content:p});continue}if(Le.some(y=>y.test(p))){i.push({type:"letter",content:p}),o="letter",n=!1;continue}const g=this.matchList(p);if(g){i.push({type:"list-item",content:g.content,metadata:{listStyle:g.style,listIndex:g.index}}),o="list-item";continue}if(Me.some(y=>y.test(d))){i.push({type:"blockquote",content:p.replace(/^>\s*/,""),metadata:{indentLevel:this.detectIndent(d)}}),o="blockquote";continue}if(p.length<Ee&&!p.endsWith(".")?b++:b=0,b>=3){for(let y=i.length-1;y>=0&&y>=i.length-b;y--)i[y].type==="paragraph"&&(i[y].type="poetry");i.push({type:"poetry",content:p}),o="poetry";continue}const t=this.detectDialogue(p,w);if(t.isDialogue){w=t.context,t.isAttribution?i.push({type:"dialogue-attribution",content:p,metadata:{speaker:t.speaker}}):i.push({type:"dialogue",content:p,metadata:{speaker:w.speaker}}),o="dialogue",n=!1;continue}if(n&&o==="chapter-heading"){i.push({type:"first-paragraph",content:p,metadata:{isFirstInChapter:!0}}),o="first-paragraph",n=!1;continue}i.push({type:"paragraph",content:p}),o="paragraph",n=!1}return i}static splitIntoParagraphs(e){return e.replace(/\r\n/g,`
`).replace(/\r/g,`
`).split(/\n\n+/)}static detectIndent(e){const i=e.match(/^(\s*)/);return i?Math.floor(i[1].length/2):0}static matchChapterHeading(e){for(const i of ue){const s=e.match(i);if(s){let l;const c=s[1];return/^\d+$/.test(c)?l=parseInt(c):/^[ivxlc]+$/i.test(c)&&(l=this.romanToInt(c)),{number:l}}}return e===e.toUpperCase()&&e.length<50&&e.length>2&&/[A-Z]/.test(e)?{}:null}static romanToInt(e){const i={i:1,v:5,x:10,l:50,c:100};let s=0;const l=e.toLowerCase();for(let c=0;c<l.length;c++){const o=i[l[c]]||0,n=i[l[c+1]]||0;o<n?s-=o:s+=o}return s}static matchList(e){if(e.match(Y.bullet))return{style:"bullet",content:e.replace(Y.bullet,"")};const s=e.match(Y.number);if(s)return{style:"number",content:e.replace(Y.number,""),index:parseInt(s[1])};const l=e.match(Y.letter);return l?{style:"letter",content:e.replace(Y.letter,""),index:l[1].toLowerCase().charCodeAt(0)-96}:null}static detectDialogue(e,i){const s=Pe.test(e),l=Re.test(e),c=_e.test(e);let o=i.speaker;if(c){const n=e.match(/([A-Z][a-z]+)\s+(said|asked|replied)/i)||e.match(/(said|asked|replied)\s+([A-Z][a-z]+)/i);n&&(o=n[1]===n[1].toLowerCase()?n[2]:n[1])}return s&&c?{isDialogue:!0,isAttribution:!0,speaker:o,context:{inDialogue:!1,speaker:o}}:s&&l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!1,speaker:o}}:i.inDialogue&&l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!1,speaker:i.speaker}}:s&&!l?{isDialogue:!0,isAttribution:!1,context:{inDialogue:!0,speaker:o}}:{isDialogue:!1,isAttribution:!1,context:{inDialogue:!1,speaker:""}}}}const he={paragraph:{},"chapter-heading":{fontSize:"1.5em",fontWeight:600,textAlign:"center",marginTop:"2em",marginBottom:"1.5em",letterSpacing:"0.05em"},"scene-break":{textAlign:"center",margin:"2em 0",fontSize:"1.2em",letterSpacing:"0.5em",color:"inherit",opacity:.5},dialogue:{marginLeft:"1em",marginBottom:"0.5em"},"dialogue-attribution":{marginLeft:"1em",marginBottom:"0.75em",fontStyle:"normal"},"toc-entry":{display:"flex",justifyContent:"space-between",borderBottom:"1px dotted currentColor",opacity:.8,padding:"0.25em 0"},letter:{fontStyle:"italic",marginLeft:"2em",marginRight:"2em",padding:"1em",borderLeft:"2px solid currentColor",opacity:.9},poetry:{fontStyle:"italic",marginLeft:"2em",whiteSpace:"pre-wrap",lineHeight:1.8},blockquote:{marginLeft:"1.5em",paddingLeft:"1em",borderLeft:"3px solid currentColor",opacity:.85,fontStyle:"italic"},"list-item":{marginLeft:"1.5em",marginBottom:"0.25em"},"first-paragraph":{},epigraph:{textAlign:"center",fontStyle:"italic",marginBottom:"2em",opacity:.8,fontSize:"0.95em"}},Ae=a.memo(({book:h,onToggleChrome:e,onRequestPlay:i,isRSVPActive:s})=>{const l=de.getInstance(),c=H.getInstance(),o=ee(),{settings:n,updateSettings:w}=le(),b=a.useRef(null),m=a.useRef(null),[d,p]=a.useState([]),[T,g]=a.useState(0),[t,y]=a.useState(!1),[E,k]=a.useState(0),[S,C]=a.useState(""),P=a.useRef(!1),R=a.useRef(null),v=a.useRef(n.fontSize);a.useEffect(()=>{y(!1),k(0),(async()=>{if(!h.chapters||h.chapters.length===0){y(!0);return}try{await l.load(h);const f=l.contentStorage.string;C(f),y(!0),k(1);const x=h.lastTokenIndex||0;c.loadContent(f,{tokenIndex:x}).then(()=>{p(c.tokens),g(c.currentIndex)}).catch(()=>{})}catch(f){console.error("[FlowReader] Init failed:",f),y(!0)}})()},[h.id]),a.useEffect(()=>c.subscribe(()=>{if(c.tokens.length>0&&c.tokens!==d&&p(c.tokens),g(c.currentIndex),!s&&m.current&&c.tokens.length>0){const f=c.progress,x=m.current.scrollHeight-m.current.clientHeight,I=f*x,$=m.current.scrollTop;Math.abs(I-$)>500&&(P.current=!0,m.current.scrollTo({top:I,behavior:"smooth"}),setTimeout(()=>{P.current=!1},600))}}),[s]),a.useEffect(()=>{const u=m.current;if(!u||!t||d.length===0||s)return;let f=!1;const x=()=>{P.current||f||(f=!0,requestAnimationFrame(()=>{if(!P.current&&u){const I=u.scrollTop/Math.max(1,u.scrollHeight-u.clientHeight),$=Math.floor(I*(d.length-1));Math.abs($-c.currentIndex)>5&&(c.seek({tokenIndex:$}),l.saveProgress($))}f=!1}))};return u.addEventListener("scroll",x,{passive:!0}),()=>u.removeEventListener("scroll",x)},[t,d.length,s]);const j=a.useCallback(u=>{if(u.touches.length===2){const f=u.touches[0].clientX-u.touches[1].clientX,x=u.touches[0].clientY-u.touches[1].clientY;R.current=Math.sqrt(f*f+x*x),v.current=n.fontSize}},[n.fontSize]),N=a.useCallback(u=>{if(u.touches.length===2&&R.current!==null){u.preventDefault();const f=u.touches[0].clientX-u.touches[1].clientX,x=u.touches[0].clientY-u.touches[1].clientY,$=Math.sqrt(f*f+x*x)/R.current,z=Math.round(Math.max(12,Math.min(40,v.current*$)));z!==n.fontSize&&w({fontSize:z})}},[n.fontSize,w]),A=a.useCallback(()=>{R.current=null},[]);a.useEffect(()=>{const u=m.current;if(u)return u.addEventListener("touchstart",j,{passive:!0}),u.addEventListener("touchmove",N,{passive:!1}),u.addEventListener("touchend",A,{passive:!0}),()=>{u.removeEventListener("touchstart",j),u.removeEventListener("touchmove",N),u.removeEventListener("touchend",A)}},[j,N,A]);const W=a.useMemo(()=>{if(d.length===0)return[];const u=[];let f=[],x=0,I="paragraph";const $=/^chapter\s+(\d+|[ivxlc]+)|^(part|book|section|prologue|epilogue)\s*/i,z=/^[\*\#\-–—]{3,}$|^[●○◆◇★]{1,5}$/,te=/^[""\u201C]/;for(let F=0;F<d.length;F++){const q=d[F];if(f.push(q),q.isParagraphEnd||F===d.length-1){const L=f.map(X=>X.originalText).join(" "),ne=V(L,I);u.push({tokens:f,startIndex:x,plainText:L,blockType:ne,metadata:I==="chapter-heading"?{isFirstInChapter:!0}:void 0}),I=ne,f=[],x=F+1}}function V(F,q){const L=F.trim();return z.test(L)?"scene-break":L.length<60&&($.test(L)||L===L.toUpperCase()&&/[A-Z]/.test(L)&&L.length>2)?"chapter-heading":te.test(L)?"dialogue":q==="chapter-heading"?"first-paragraph":"paragraph"}return u},[d]),G=a.useCallback(u=>{D.impactMedium(),c.seek({tokenIndex:u}),i?.(u)},[i]),O=a.useCallback(()=>{c.toggle()},[]),_=n.fontFamily==="New York"?'"New York", "Iowan Old Style", Georgia, serif':n.fontFamily==="OpenDyslexic"?'"OpenDyslexic", sans-serif':n.fontFamily==="Atkinson Hyperlegible"?'"Atkinson Hyperlegible", sans-serif':"system-ui, -apple-system, sans-serif";if(!t)return r.jsx("div",{className:"absolute inset-0 flex items-center justify-center",style:{backgroundColor:o.background},children:r.jsx("div",{className:"w-6 h-6 rounded-full border-2 animate-spin",style:{borderColor:`${o.accent}20`,borderTopColor:o.accent}})});const M=a.useMemo(()=>d.length>0||!S?null:Ne.formatText(S),[d.length,S]);return r.jsxs("div",{ref:b,className:"absolute inset-0",children:[r.jsx("div",{ref:m,className:"absolute inset-0 overflow-y-auto overscroll-contain transition-opacity duration-300",style:{backgroundColor:o.background,opacity:s?c.isPlaying?0:.4:1,pointerEvents:s?"none":"auto"},onClick:e,children:r.jsxs("div",{className:"max-w-2xl mx-auto px-6 py-safe",style:{paddingTop:"calc(5rem + env(safe-area-inset-top))",paddingBottom:"12rem"},children:[M&&M.length>0&&M.map((u,f)=>r.jsx($e,{block:u,fontSize:n.fontSize,lineHeight:n.lineHeight,paragraphSpacing:n.paragraphSpacing,fontFamily:_,theme:o},f)),!M&&W.length>0&&W.map(u=>r.jsx(ze,{para:u,activeIndex:T,fontSize:n.fontSize,lineHeight:n.lineHeight,paragraphSpacing:n.paragraphSpacing,fontFamily:_,theme:o,onWordClick:G},u.startIndex)),!M&&W.length===0&&S&&r.jsx("p",{style:{color:o.primaryText,fontSize:`${n.fontSize}px`,fontFamily:_},children:S}),!S&&d.length===0&&r.jsx("p",{style:{color:o.primaryText,opacity:.5,textAlign:"center",paddingTop:"2rem"},children:"No content to display"})]})}),r.jsx("div",{className:`absolute inset-0 transition-all duration-300 ${s?"opacity-100 scale-100":"opacity-0 scale-95 pointer-events-none"}`,style:{transitionTimingFunction:"cubic-bezier(0.2, 0, 0, 1)"},children:r.jsx(Ie,{onTap:O})})]})}),$e=a.memo(({block:h,fontSize:e,lineHeight:i,paragraphSpacing:s,fontFamily:l,theme:c})=>{const o={fontSize:`${e}px`,lineHeight:i,fontFamily:l,color:c.primaryText,textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},n=he[h.type];switch(h.type){case"chapter-heading":return r.jsx("h2",{style:{...o,...n,fontSize:`${e*1.5}px`},children:h.content});case"scene-break":return r.jsx("div",{style:{...o,...n},role:"separator",children:h.content});case"dialogue":case"dialogue-attribution":return r.jsx("p",{style:{...o,...n,marginBottom:`${s*.6}px`},children:h.content});case"toc-entry":const w=h.content.match(/^(.+?)(\s*\.{2,}\s*|\s{2,})(\d+)$/);return w?r.jsxs("div",{style:{...o,display:"flex",justifyContent:"space-between",alignItems:"baseline",gap:"0.5em",marginBottom:"0.25em",paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel*1.5}em`:0},children:[r.jsx("span",{style:{flex:"1"},children:w[1].trim()}),r.jsx("span",{style:{borderBottom:"1px dotted currentColor",flex:"1",opacity:.3,marginBottom:"0.25em"}}),r.jsx("span",{style:{opacity:.6},children:w[3]})]}):r.jsx("p",{style:{...o,...n,marginBottom:"0.25em"},children:h.content});case"letter":return r.jsx("blockquote",{style:{...o,...n,marginBottom:`${s}px`,borderLeftColor:c.accent},children:h.content});case"poetry":return r.jsx("p",{style:{...o,...n,marginBottom:`${s*.5}px`},children:h.content});case"blockquote":return r.jsx("blockquote",{style:{...o,...n,marginBottom:`${s}px`,borderLeftColor:c.accent,paddingLeft:h.metadata?.indentLevel?`${h.metadata.indentLevel}em`:"1em"},children:h.content});case"list-item":const b=h.metadata?.listStyle==="number"?`${h.metadata.listIndex}. `:h.metadata?.listStyle==="letter"?`${String.fromCharCode(96+(h.metadata.listIndex||1))}. `:"• ";return r.jsxs("p",{style:{...o,...n,marginBottom:"0.25em"},children:[r.jsx("span",{style:{opacity:.6},children:b}),h.content]});case"first-paragraph":const m=h.content.charAt(0),d=h.content.slice(1);return r.jsxs("p",{style:{...o,marginBottom:`${s}px`,textAlign:"justify",textJustify:"inter-word"},children:[r.jsx("span",{style:{float:"left",fontSize:`${e*3.2}px`,lineHeight:.8,marginRight:"0.08em",marginTop:"0.05em",fontWeight:500,color:c.accent},children:m}),d]});case"epigraph":return r.jsx("p",{style:{...o,...n,marginBottom:`${s*2}px`,fontSize:`${e*.95}px`},children:h.content});case"paragraph":default:return r.jsx("p",{style:{...o,marginBottom:`${s}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em"},children:h.content})}}),ze=a.memo(({para:h,activeIndex:e,fontSize:i,lineHeight:s,paragraphSpacing:l,fontFamily:c,theme:o,onWordClick:n})=>{const w={fontSize:`${i}px`,lineHeight:s,fontFamily:c,color:o.primaryText,textRendering:"optimizeLegibility",WebkitFontSmoothing:"antialiased"},b=he[h.blockType],m=(d,p=0)=>r.jsx(r.Fragment,{children:d.map((T,g)=>{const t=T.globalIndex===e;return r.jsxs(pe.Fragment,{children:[r.jsx("span",{onClick:y=>{y.stopPropagation(),n(T.globalIndex)},className:"inline rounded-sm cursor-pointer select-none transition-colors duration-150",style:{backgroundColor:t?o.accent:"transparent",color:t?"#FFFFFF":"inherit",padding:t?"0.1em 0.15em":"0",margin:t?"-0.1em -0.15em":"0"},children:T.originalText})," "]},T.id)})});switch(h.blockType){case"chapter-heading":return r.jsx("h2",{className:"cursor-pointer",style:{...w,...b,fontSize:`${i*1.5}px`},children:m(h.tokens)});case"scene-break":return r.jsx("div",{className:"cursor-pointer",style:{...w,...b},role:"separator",children:"* * *"});case"dialogue":return r.jsx("p",{className:"cursor-pointer",style:{...w,...b,marginBottom:`${l*.6}px`},children:m(h.tokens)});case"first-paragraph":const d=h.tokens[0],p=h.tokens.slice(1),T=d?.originalText?.charAt(0)||"",g=d?.originalText?.slice(1)||"";return r.jsxs("p",{className:"cursor-pointer",style:{...w,marginBottom:`${l}px`,textAlign:"justify",textJustify:"inter-word"},children:[r.jsx("span",{onClick:t=>{t.stopPropagation(),d&&n(d.globalIndex)},style:{float:"left",fontSize:`${i*3.2}px`,lineHeight:.8,marginRight:"0.08em",marginTop:"0.05em",fontWeight:500,color:e===d?.globalIndex?"#FFFFFF":o.accent,backgroundColor:e===d?.globalIndex?o.accent:"transparent",borderRadius:"0.1em",cursor:"pointer"},children:T}),g&&r.jsx("span",{onClick:t=>{t.stopPropagation(),d&&n(d.globalIndex)},className:"cursor-pointer",style:{backgroundColor:e===d?.globalIndex?o.accent:"transparent",color:e===d?.globalIndex?"#FFFFFF":"inherit"},children:g})," ",m(p)]});case"paragraph":default:return r.jsx("p",{className:"cursor-pointer transition-opacity hover:opacity-100",style:{...w,marginBottom:`${l}px`,opacity:.92,textAlign:"justify",textJustify:"inter-word",hyphens:"auto",WebkitHyphens:"auto",wordBreak:"break-word",letterSpacing:"-0.01em"},children:m(h.tokens)})}}),Be=a.memo(({book:h,onToggleRSVP:e,isRSVPActive:i,onSettingsClick:s})=>{const l=H.getInstance(),{settings:c,updateSettings:o}=le(),n=ee(),[w,b]=a.useState(!1),[m,d]=a.useState(0),[p,T]=a.useState(!1),g=a.useRef(null),t=a.useRef(null),y=a.useRef(!1),E=a.useRef(0),k=a.useRef(null),S=a.useRef(null),[C,P]=a.useState(!1),R=a.useRef(!1);a.useEffect(()=>{const u=()=>{if(b(l.isPlaying),!p){const x=l.progress;d(x),t.current&&(t.current.style.width=`${x*100}%`)}};u();const f=l.subscribe(u);return()=>f()},[p]);const v=a.useCallback(()=>l.getTimeRemainingFormatted(),[m]),j=a.useCallback(u=>{if(!g.current)return;u.preventDefault(),T(!0),y.current=l.isPlaying,y.current&&l.pause();const f=g.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));d(x),t.current&&(t.current.style.width=`${x*100}%`),u.target.setPointerCapture(u.pointerId)},[]),N=a.useCallback(u=>{if(!p||!g.current)return;const f=g.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));d(x),t.current&&(t.current.style.width=`${x*100}%`)},[p]),A=a.useCallback(u=>{if(!p||!g.current)return;const f=g.current.getBoundingClientRect(),x=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));l.seek({progress:x}),T(!1),y.current&&l.play(),D.impactMedium()},[p]),W=a.useCallback(()=>{const u=Date.now();u-E.current<200||(E.current=u,D.impactMedium(),e())},[e]),G=a.useCallback(u=>{D.impactLight();const f=Math.max(50,Math.min(1e3,(c.rsvpSpeed||250)+u));o({rsvpSpeed:f,hasCustomSpeed:!0})},[c.rsvpSpeed,o]),O=a.useCallback(()=>{i&&(D.impactLight(),R.current=l.isPlaying,l.seekByTokens(-10),S.current=setTimeout(()=>{P(!0),R.current&&l.pause(),k.current=setInterval(()=>{l.seekByTokens(-10),D.selectionChanged(),l.currentIndex<=0&&_()},150)},300))},[i]),_=a.useCallback(()=>{S.current&&clearTimeout(S.current),k.current&&clearInterval(k.current),S.current=null,k.current=null,C&&(P(!1),R.current&&l.play(),D.impactMedium())},[C]);a.useEffect(()=>()=>{k.current&&clearInterval(k.current),S.current&&clearTimeout(S.current)},[]);const M=a.useCallback(()=>{D.impactLight(),o({showGhostPreview:!c.showGhostPreview})},[c.showGhostPreview,o]);return r.jsxs("div",{className:"w-full backdrop-blur-xl rounded-2xl border overflow-hidden",style:{backgroundColor:`${n.surface}f0`,borderColor:n.borderColor},children:[r.jsx("div",{ref:g,className:"h-10 px-4 flex items-center cursor-pointer touch-none",onPointerDown:j,onPointerMove:N,onPointerUp:A,onPointerCancel:A,children:r.jsxs("div",{className:"w-full h-1 rounded-full relative",style:{backgroundColor:`${n.primaryText}10`},children:[r.jsx("div",{ref:t,className:"absolute top-0 left-0 h-full rounded-full",style:{backgroundColor:n.accent,width:`${m*100}%`}}),p&&r.jsx("div",{className:"absolute top-1/2 w-4 h-4 rounded-full border-2 border-white shadow-lg",style:{left:`${m*100}%`,transform:"translate(-50%, -50%)",backgroundColor:n.accent}})]})}),r.jsxs("div",{className:"flex items-center justify-between px-4 pb-4 gap-3",children:[r.jsxs("div",{className:"flex items-center h-11 rounded-xl border shrink-0",style:{borderColor:n.borderColor,backgroundColor:`${n.primaryText}05`},children:[r.jsx("button",{onClick:()=>G(-25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:n.secondaryText},children:r.jsx(ge,{size:16})}),r.jsx("div",{className:"px-2 min-w-[48px] text-center",children:r.jsx("span",{className:"text-xs font-bold tabular-nums",style:{color:n.primaryText},children:c.rsvpSpeed||250})}),r.jsx("button",{onClick:()=>G(25),className:"w-10 h-full flex items-center justify-center active:scale-90 transition-transform",style:{color:n.secondaryText},children:r.jsx(ye,{size:16})})]}),r.jsxs("div",{className:"flex items-center gap-2",children:[i&&r.jsx("button",{onPointerDown:O,onPointerUp:_,onPointerLeave:_,onPointerCancel:_,className:`w-11 h-11 rounded-full flex items-center justify-center transition-all ${C?"scale-110":"active:scale-95"}`,style:{backgroundColor:C?`${n.accent}25`:`${n.primaryText}08`,color:C?n.accent:n.secondaryText},children:r.jsx(xe,{size:18,className:C?"animate-spin":"",style:{animationDirection:"reverse",animationDuration:"1s"}})}),r.jsx("button",{onClick:W,className:"w-14 h-14 rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform",style:{backgroundColor:n.accent,boxShadow:`0 4px 16px -2px ${n.accent}50`},children:i&&w?r.jsx(be,{size:22,className:"text-white fill-white"}):r.jsx(ke,{size:22,className:"text-white fill-white ml-0.5"})}),i&&r.jsx("button",{onClick:M,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:c.showGhostPreview?`${n.accent}25`:`${n.primaryText}08`,color:c.showGhostPreview?n.accent:n.secondaryText},children:r.jsx(we,{size:18,className:c.showGhostPreview?"fill-current":""})})]}),r.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[r.jsx("button",{onClick:s,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${n.primaryText}08`,color:n.secondaryText},children:r.jsx(Te,{size:18})}),r.jsx("span",{className:"text-xs font-medium tabular-nums min-w-[32px] text-right",style:{color:n.secondaryText},children:v()})]})]})]})}),Ye=({book:h,onClose:e})=>{const i=de.getInstance(),s=H.getInstance(),l=ee(),[c,o]=a.useState(!0),[n,w]=a.useState(!1),[b,m]=a.useState(!1),[d,p]=a.useState(!1),[T,g]=a.useState(!1),t=a.useRef(!1);a.useEffect(()=>{const v=()=>{const N=s.mode==="rsvp",A=s.isPlaying;w(N),m(A),i.isRSVPMode=N};v();const j=s.subscribe(v);return()=>j()},[]),a.useEffect(()=>{const v=s.onPositionChange(j=>{i.saveProgress(j.tokenIndex)});return()=>v()},[]),a.useEffect(()=>()=>{s.pause(),s.mode==="rsvp"&&i.saveProgress(s.currentIndex),s.setMode("scroll"),s.clear()},[]),a.useEffect(()=>{const v=()=>{t.current||(t.current=!0,d||T?y():n&&(s.pause(),s.setMode("scroll"),o(!0)),t.current=!1)};return window.addEventListener("popstate",v),()=>window.removeEventListener("popstate",v)},[d,T,n]),a.useEffect(()=>{let v;return c&&n&&b&&(v=setTimeout(()=>o(!1),2500)),()=>clearTimeout(v)},[c,n,b]),a.useEffect(()=>{d&&s.isPlaying&&s.pause()},[d]);const y=a.useCallback(()=>{g(!0),setTimeout(()=>{p(!1),g(!1)},400)},[]),E=a.useCallback(()=>{const v=s.currentIndex,j=s.progress;s.pause(),i.saveProgress(v),s.setMode("scroll"),e(h.id,v,j)},[h.id,e]),k=a.useCallback(()=>{n?s.toggle():(s.setMode("rsvp"),t.current||window.history.pushState({rsvpMode:!0},"",window.location.href),s.play(),o(!1))},[n]),S=a.useCallback(v=>{s.seek({tokenIndex:v}),s.setMode("rsvp"),t.current||window.history.pushState({rsvpMode:!0},"",window.location.href),s.play(),o(!1)},[]),C=a.useCallback(()=>{t.current||window.history.pushState({modal:"settings"},"",window.location.href),p(!0)},[]),P=a.useCallback(()=>{o(v=>!v)},[]),R=a.useCallback(()=>{s.pause(),s.setMode("scroll"),o(!0)},[]);return r.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden m-0 p-0 animate-fadeIn",style:{backgroundColor:l.background},children:[r.jsx("div",{className:"absolute inset-0 z-10",children:r.jsx(Ae,{book:h,onToggleChrome:P,onRequestPlay:S,isRSVPActive:n})}),r.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50 pointer-events-auto",style:{bottom:"calc(2rem + env(safe-area-inset-bottom))"},children:r.jsx(Be,{book:h,onToggleRSVP:k,isRSVPActive:n,onSettingsClick:C})}),r.jsx("div",{className:`absolute top-0 left-0 right-0 z-[60] transition-transform duration-400 pointer-events-none ${c||n&&!b?"translate-y-0":"-translate-y-full"}`,style:{transitionTimingFunction:"cubic-bezier(0.16, 1, 0.3, 1)"},children:r.jsx("div",{className:"backdrop-blur-2xl border-b pt-safe-top py-4 px-5 flex items-center justify-between pointer-events-auto",style:{backgroundColor:l.dimmer,borderColor:l.borderColor},children:r.jsx("button",{onClick:n?R:E,className:"w-11 h-11 -ml-1 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${l.primaryText}08`,color:l.primaryText},children:r.jsx(Se,{size:20})})})}),(d||T)&&r.jsxs(r.Fragment,{children:[r.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:T?"fadeOut 0.4s ease-out":"fadeIn 0.6s ease-out"},onClick:y}),r.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[32px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:l.background,animation:T?"slideDown 0.5s cubic-bezier(0.7, 0, 0.84, 0)":"slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1)"},children:r.jsx(ve,{onClose:y})})]}),r.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideDown { from { transform: translateY(0); } to { transform: translateY(100%); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
      `})]})};export{Ye as ReaderContainer};
