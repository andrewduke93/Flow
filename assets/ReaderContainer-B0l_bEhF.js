const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rsvp-DJNz9Vk9.js","assets/animations-D9Wo9mUM.js"])))=>i.map(i=>d[i]);
import{r as a,j as e}from"./animations-D9Wo9mUM.js";import{u as $,_ as D,T as z}from"./index-BZGi7ocY.js";import{u as L,b as G,R as S}from"./rsvp-DJNz9Vk9.js";import{T as M}from"./cloud-DoEluFuo.js";import{M as q,l as H,m as J,n as K,o as Q,P as U,p as X,q as Y,E as Z,r as ee,s as te,t as se}from"./icons-DhCoUMbR.js";import"./vendor-react-uIRdnfX0.js";const oe=({book:x,onToggleChrome:s,isActive:o})=>{const t=$(),{settings:r}=L(),c=a.useRef(null),[i,h]=a.useState([]),[p,w]=a.useState(-1),[l,T]=a.useState(!1),[m,f]=a.useState(300);a.useEffect(()=>{(async()=>{if(!x.chapters||x.chapters.length===0){h([]);return}try{const u=x.chapters.sort((b,j)=>b.sortOrder-j.sortOrder).map(b=>{const j=document.createElement("div");return j.innerHTML=b.content,j.textContent||j.innerText||""}).join(`

`),y=(await G.process(u)).map((b,j)=>({...b,globalIndex:j}));h(y),w(0)}catch(u){console.error("Failed to process book tokens:",u),h([])}})()},[x]),a.useEffect(()=>{const n=c.current;if(!n)return;const u=g=>{const y=g.target?.closest?.("[data-idx]");if(y){const b=Number(y.dataset.idx);Number.isNaN(b)||(w(b),g.stopPropagation(),g.preventDefault())}};return n.addEventListener("pointerdown",u,{capture:!0}),()=>n.removeEventListener("pointerdown",u,{capture:!0})},[c,i]);const N=()=>{T(!1);try{const{RSVPConductor:n}=require("../services/rsvpConductor");n.getInstance().shutdown(!0)}catch{}};a.useEffect(()=>{if(!l||i.length===0)return;const n=setInterval(()=>{w(u=>Math.min(i.length-1,u+1))},m);return()=>clearInterval(n)},[l,i,m]),a.useEffect(()=>{if(!c.current)return;const n=c.current.querySelector(`[data-idx="${p}"]`);n&&n.scrollIntoView({block:"center",behavior:"smooth"})},[p]);const _=n=>{w(n)},C=async()=>{if(i.length===0){console.warn("No tokens available to start RSVP");return}T(!0);try{const{RSVPConductor:n}=await D(async()=>{const{RSVPConductor:y}=await import("./rsvp-DJNz9Vk9.js").then(b=>b.r);return{RSVPConductor:y}},__vite__mapDeps([0,1])),u=n.getInstance(),g=i.map(y=>y.originalText).join(" ");await u.prepare(g,{index:Math.max(0,p)}),u.play()}catch(n){console.error("Failed to start RSVP conductor:",n)}};return e.jsxs("div",{ref:c,className:"absolute inset-0 w-full h-full overflow-y-auto bg-gradient-to-br from-blue-50 to-indigo-100",style:{color:t.primaryText,pointerEvents:"auto"},children:[e.jsxs("div",{className:"fixed top-0 left-0 w-full flex justify-between items-center p-4 z-50 bg-white/80 backdrop-blur-md shadow",children:[e.jsx("span",{className:"font-bold text-xl text-indigo-700",children:"Flow Reader"}),l?e.jsxs("button",{className:"px-6 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-red-500 text-white font-semibold shadow-lg hover:scale-105 transition",onClick:N,children:[e.jsx("span",{className:"mr-2",children:"â¹ï¸"})," Exit Flow"]}):e.jsxs("button",{className:"px-6 py-2 rounded-lg bg-gradient-to-r from-indigo-500 to-blue-500 text-white font-semibold shadow-lg hover:scale-105 transition",onClick:C,children:[e.jsx("span",{className:"mr-2",children:"â–¶ï¸"})," Start Flow"]}),l&&e.jsxs("div",{className:"flex items-center ml-4",children:[e.jsx("span",{className:"mr-2 text-sm text-gray-600",children:"Speed:"}),e.jsx("input",{type:"range",min:"100",max:"1000",value:m,onChange:n=>f(Number(n.target.value)),className:"w-32"}),e.jsxs("span",{className:"ml-2 text-xs text-gray-700",children:[m,"ms"]})]})]}),e.jsxs("div",{className:"p-8 pt-24 max-w-3xl mx-auto",children:[i.length===0?e.jsx("div",{className:"text-center text-lg mt-32",children:"No content available"}):e.jsx("div",{className:"flex flex-wrap gap-1",children:i.map(n=>e.jsx("span",{"data-idx":n.globalIndex,className:n.globalIndex===p?"bg-gradient-to-r from-yellow-300 to-orange-200 text-black px-2 py-1 rounded shadow-lg font-bold transition-all scale-110":"hover:bg-blue-200 cursor-pointer px-2 py-1 rounded transition-all",style:{fontSize:r.fontSize,marginRight:2},onClick:()=>_(n.globalIndex),children:n.originalText},n.globalIndex))}),l&&i.length>0&&e.jsxs("div",{className:"mt-12 flex flex-col items-center",children:[e.jsx("div",{className:"text-4xl font-extrabold text-indigo-700 animate-pulse mb-4",children:i[p]?.originalText}),e.jsx("div",{className:"text-sm text-gray-500",children:"Flow mode: auto-advancing, tap Exit to return"})]})]})]})};class P{constructor(){this.words=[],this.sourceText="",this.totalWords=0,this._position=0,this._isPlaying=!1,this._wpm=300,this.playbackTimer=null,this.positionListeners=new Set,this.playStateListeners=new Set}static getInstance(){return P.instance||(P.instance=new P),P.instance}load(s){if(this.stop(),this.sourceText=s,this.words=[],!s||s.length===0){this.totalWords=0;return}const o=Math.ceil(s.length/5);this.words=new Array(o);let t=0,r=-1,c=!0,i=!1;for(let h=0;h<=s.length;h++){const p=h<s.length?s[h]:" ",w=p===" "||p==="	"||p===`
`||p==="\r";if(p===`
`&&(i=!0),w&&!c&&r>=0){const T=s.slice(r,h);let m=0;const f=T[T.length-1];f==="."||f==="!"||f==="?"?m=2:(f===","||f===";"||f===":"||f==="â€”"||f==="â€“")&&(m=1),this.words[t]={text:T,start:r,end:h,index:t,trailingPause:m},t++,r=-1}else!w&&c&&(r=h,i&&t>0&&(this.words[t-1].trailingPause=3),i=!1);c=w}this.words.length=t,this.totalWords=t}get position(){return this._position}set position(s){const o=Math.max(0,Math.min(this.totalWords-1,s));o!==this._position&&(this._position=o,this.notifyPosition())}get progress(){return this.totalWords>0?this._position/this.totalWords:0}set progress(s){this.position=Math.floor(s*this.totalWords)}get total(){return this.totalWords}getWord(s){return this.words[s]||null}getCurrentWord(){return this.words[this._position]||null}getWindow(s,o){const t=Math.max(0,this._position-s),r=Math.min(this.totalWords,this._position+o);return this.words.slice(t,r)}getRange(s,o){const t=Math.max(0,s),r=Math.min(this.totalWords,t+o);return this.words.slice(t,r)}getParagraphs(s,o){const t=[];let r=[],c=s;for(let i=s;i<this.totalWords&&t.length<o;i++){const h=this.words[i];r.length===0&&(c=i),r.push(h),h.trailingPause===3&&(t.push({words:r,startIndex:c}),r=[])}return r.length>0&&t.length<o&&t.push({words:r,startIndex:c}),t}wordIndexFromProgress(s){return Math.floor(s*this.totalWords)}get isPlaying(){return this._isPlaying}get wpm(){return this._wpm}set wpm(s){this._wpm=Math.max(50,Math.min(1500,s)),this._isPlaying&&(this.stop(),this.play())}play(){this._isPlaying||this.totalWords===0||(this._isPlaying=!0,this.notifyPlayState(),this.scheduleNext())}stop(){this.playbackTimer!==null&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this._isPlaying&&(this._isPlaying=!1,this.notifyPlayState())}toggle(){this._isPlaying?this.stop():this.play()}scheduleNext(){if(!this._isPlaying)return;const s=this.getCurrentWord();if(!s){this.stop();return}let o=6e4/this._wpm;const t=s.trailingPause;t===1?o*=1.3:t===2?o*=1.8:t===3&&(o*=2.2);const r=s.text.length;r>10?o*=1.2:r>7?o*=1.1:r<=2&&(o*=.85),this.playbackTimer=window.setTimeout(()=>{this._position<this.totalWords-1?(this.position=this._position+1,this.scheduleNext()):this.stop()},o)}skipForward(s=10){this.position=this._position+s}skipBack(s=10){this.position=this._position-s}jumpToStart(){this.position=0}jumpToEnd(){this.position=this.totalWords-1}onPosition(s){return this.positionListeners.add(s),()=>this.positionListeners.delete(s)}onPlayState(s){return this.playStateListeners.add(s),()=>this.playStateListeners.delete(s)}notifyPosition(){const s=this._position;this.positionListeners.forEach(o=>o(s))}notifyPlayState(){const s=this._isPlaying;this.playStateListeners.forEach(o=>o(s))}getStats(){return{totalWords:this.totalWords,position:this._position,progress:this.progress,isPlaying:this._isPlaying,wpm:this._wpm}}cleanup(){this.stop(),this.words=[],this.sourceText="",this.totalWords=0,this._position=0}}const de=({book:x,onClose:s})=>{const o=P.getInstance(),t=$(),{settings:r,updateSettings:c}=L(),[i,h]=a.useState(!0),[p,w]=a.useState(!1),[l,T]=a.useState(0),[m,f]=a.useState(r.rsvpSpeed||300),[N,_]=a.useState(r.showGhostPreview??!0),[C,n]=a.useState(!1),u=a.useRef(),g=a.useRef();a.useEffect(()=>{o.wpm=r.rsvpSpeed||300,f(o.wpm),_(r.showGhostPreview??!0);const d=o.onPosition(k=>{T(o.progress),g.current&&clearTimeout(g.current),g.current=setTimeout(()=>{const I={...x,lastTokenIndex:k,bookmarkProgress:o.progress,lastOpened:new Date};M.getInstance().saveBook(I)},200)}),v=o.onPlayState(k=>{if(w(k),k)u.current=setTimeout(()=>h(!1),3e3);else{h(!0),g.current&&clearTimeout(g.current);const I={...x,lastTokenIndex:o.position,bookmarkProgress:o.progress,lastOpened:new Date};M.getInstance().saveBook(I)}});return()=>{if(d(),v(),u.current&&clearTimeout(u.current),g.current){clearTimeout(g.current);const k={...x,lastTokenIndex:o.position,bookmarkProgress:o.progress,lastOpened:new Date};M.getInstance().saveBook(k)}}},[x.id]),a.useEffect(()=>()=>o.stop(),[]);const y=a.useCallback(()=>{o.stop(),s(x.id,o.position,o.progress)},[x.id,s]),b=a.useCallback(()=>{S.impactMedium(),o.toggle()},[]),j=a.useCallback(()=>{S.impactLight(),o.skipBack(50)},[]),W=a.useCallback(d=>{S.impactLight();const v=Math.max(100,Math.min(800,m+d));o.wpm=v,f(v),c({rsvpSpeed:v,hasCustomSpeed:!0})},[m,c]),V=a.useCallback(()=>{S.impactLight();const d=!N;_(d),c({showGhostPreview:d})},[N,c]),F=a.useCallback(()=>{S.impactLight();const d=z.getInstance(),v=d.mode,k=v==="Night"?"Modern":v==="Modern"?"Sepia":"Night";d.setMode(k)},[]),B=a.useCallback(()=>{u.current&&clearTimeout(u.current),h(d=>!d),n(!1)},[]),A=a.useCallback(d=>{o.progress=parseFloat(d.target.value)},[]),E=a.useCallback(d=>{S.impactLight();const v=Math.max(14,Math.min(32,r.fontSize+d));c({fontSize:v})},[r.fontSize,c]);a.useEffect(()=>{const d=()=>{p?o.stop():y()};return window.addEventListener("popstate",d),()=>window.removeEventListener("popstate",d)},[p,y]);const R=z.getInstance(),O=R.mode==="Night"?q:R.mode==="Sepia"?H:J;return e.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden",style:{backgroundColor:t.background},children:[e.jsx(oe,{book:x,onToggleChrome:B,isActive:!0}),e.jsx("div",{className:"fixed left-0 right-0 z-[60] flex justify-center pointer-events-none",style:{bottom:"max(20px, env(safe-area-inset-bottom))"},children:e.jsxs("div",{className:`pointer-events-auto shadow-xl backdrop-blur-2xl border flex flex-col rounded-2xl overflow-hidden transition-all duration-300 ease-out ${i?"translate-y-0 opacity-100":"translate-y-4 opacity-0"}`,style:{backgroundColor:t.surface+"f0",borderColor:t.borderColor,maxWidth:"420px",width:"calc(100% - 24px)"},children:[e.jsxs("div",{className:"px-4 pt-3 pb-1",children:[e.jsx("input",{type:"range",min:"0",max:"1",step:"0.0001",value:l,onChange:A,className:"w-full h-1.5 rounded-full appearance-none cursor-pointer touch-pan-x",style:{background:`linear-gradient(to right, ${t.accent} ${l*100}%, ${t.borderColor} ${l*100}%)`}}),e.jsxs("div",{className:"flex justify-between mt-1.5 px-0.5",children:[e.jsx("span",{className:"text-[10px] tabular-nums",style:{color:t.secondaryText,opacity:.6},children:l<.1?"ðŸŒ± just starting":l<.25?`${Math.round(l*100)}% ðŸŒ¿`:l<.5?`${Math.round(l*100)}% ðŸ“– nice pace`:l<.75?`${Math.round(l*100)}% âœ¨ halfway!`:l<.9?`${Math.round(l*100)}% ðŸ”¥ almost there`:`${Math.round(l*100)}% ðŸŽ¯ so close!`}),e.jsxs("span",{className:"text-[10px] tabular-nums",style:{color:t.secondaryText,opacity:.6},children:["~",Math.round((1-l)*o.total/Math.max(1,m)),"m left"]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 px-1.5 pb-2",children:[e.jsx("button",{onClick:j,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Rewind",children:e.jsx(K,{size:18})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:()=>W(-25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Slower",children:e.jsx(Q,{size:16})}),e.jsxs("div",{className:"h-9 px-2 rounded-xl flex items-center justify-center gap-1 min-w-[70px]",style:{backgroundColor:`${t.primaryText}06`},children:[e.jsx("span",{className:"text-sm font-bold tabular-nums",style:{color:t.primaryText},children:m}),e.jsx("span",{className:"text-[10px] lowercase opacity-50",style:{color:t.secondaryText},children:"wpm"})]}),e.jsx("button",{onClick:()=>W(25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Faster",children:e.jsx(U,{size:16})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:b,className:"flex-1 flex items-center justify-center gap-1.5 h-9 rounded-xl font-semibold text-white shadow-md active:scale-[0.97] transition-all duration-150 text-sm hover:brightness-105",style:{backgroundColor:t.accent,minWidth:"80px"},"aria-label":p?"Pause":"Play",children:p?e.jsxs(e.Fragment,{children:[e.jsx(X,{size:16})," ",e.jsx("span",{className:"lowercase",children:"pause"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{size:16,className:"ml-0.5"})," ",e.jsx("span",{className:"lowercase",children:"flow~"})]})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:t.borderColor}}),e.jsx("button",{onClick:V,className:`w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90 ${N?"":"opacity-40"}`,style:{backgroundColor:N?`${t.accent}15`:"transparent",color:N?t.accent:t.secondaryText},"aria-label":"Toggle context",children:N?e.jsx(Z,{size:17}):e.jsx(ee,{size:17})}),e.jsx("button",{onClick:F,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:t.secondaryText},"aria-label":"Toggle theme",children:e.jsx(O,{size:17})}),e.jsx("button",{onClick:()=>n(d=>!d),className:"w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90",style:{backgroundColor:C?`${t.accent}15`:"transparent",color:C?t.accent:t.secondaryText},"aria-label":"Text size",children:e.jsx(te,{size:17})})]}),C&&e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t",style:{borderColor:t.borderColor},children:[e.jsx("span",{className:"text-xs lowercase",style:{color:t.secondaryText},children:"text size"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>E(-2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${t.primaryText}06`,color:t.primaryText},children:e.jsx("span",{className:"text-sm",children:"A"})}),e.jsx("span",{className:"text-sm font-semibold w-8 text-center tabular-nums",style:{color:t.primaryText},children:r.fontSize}),e.jsx("button",{onClick:()=>E(2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${t.primaryText}06`,color:t.primaryText},children:e.jsx("span",{className:"text-lg",children:"A"})})]})]})]})}),e.jsx("div",{className:`fixed top-0 left-0 right-0 z-[60] transition-all duration-300 ease-out ${i?"translate-y-0 opacity-100":"-translate-y-full opacity-0 pointer-events-none"}`,children:e.jsx("div",{className:"backdrop-blur-2xl border-b",style:{backgroundColor:`${t.surface}e8`,borderColor:t.borderColor,paddingTop:"max(12px, env(safe-area-inset-top))"},children:e.jsxs("div",{className:"flex items-center px-4 pb-3",children:[e.jsx("button",{onClick:y,className:"w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${t.primaryText}08`,color:t.primaryText},"aria-label":"Back",children:e.jsx(se,{size:22})}),e.jsxs("div",{className:"flex-1 mx-3 text-center",children:[e.jsx("h1",{className:"text-sm font-semibold truncate",style:{color:t.primaryText},children:x.title}),e.jsx("p",{className:"text-[10px] opacity-50 truncate",style:{color:t.secondaryText},children:x.author})]}),e.jsx("div",{className:"w-10"})]})})}),e.jsx("style",{children:`
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${t.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
          border: none;
        }
      `})]})};export{de as ReaderContainer};
