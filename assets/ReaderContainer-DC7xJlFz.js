const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/cloud-FGMHPRwG.js","assets/rsvp-VHkoIypx.js","assets/animations-CJNRPifJ.js","assets/index-BC47H-GM.js","assets/vendor-react-uhaD0WpH.js","assets/icons-CvM8Zi5d.js"])))=>i.map(i=>d[i]);
import{r as t,j as e,R as Te}from"./animations-CJNRPifJ.js";import{u as le,_ as ge}from"./index-BC47H-GM.js";import{a as me,b as ae,d as ce,u as ye,e as ee,R as J}from"./rsvp-VHkoIypx.js";import{d as Ce,k as Se,M as je,P as Pe,l as ke,m as Re,n as Ie,S as Ne,o as be,p as Me}from"./icons-CvM8Zi5d.js";import{SettingsSheet as Ee}from"./SettingsSheet-DH5z8Ds0.js";import"./vendor-react-uhaD0WpH.js";import"./cloud-FGMHPRwG.js";const $e=t.memo(({token:c,isActive:N,theme:i})=>e.jsx("span",{id:`w-$${c.globalIndex}`,"data-idx":c.globalIndex,"data-off":c.startOffset,className:`inline py-0.5 rounded-[2px] cursor-pointer select-none transition-colors duration-200 $${N?"":"hover:opacity-60"}`,style:{backgroundColor:N?i.accent:"transparent",color:N?"#FFFFFF":"inherit",boxDecorationBreak:"clone",WebkitBoxDecorationBreak:"clone"},children:c.originalText})),ze=t.memo(({text:c,settings:N,startTokenIndex:i,onParagraphClick:b})=>e.jsx("p",{id:`p-$${i}`,"data-start-index":i,onClick:()=>b(i),className:"max-w-[60ch] mx-auto box-border relative cursor-pointer hover:opacity-100 transition-opacity scroll-mt-32",style:{fontSize:`$${N.fontSize}px`,lineHeight:N.lineHeight,marginBottom:N.paragraphSpacing,fontFamily:N.fontFamily==="New York"?"serif":"sans-serif",color:"inherit",opacity:.9,whiteSpace:"pre-line",textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto"},children:c})),Le=t.memo(({tokens:c,activeIndex:N,onWordClick:i,settings:b,theme:d,startTokenIndex:l})=>{const M=t.useCallback(s=>{const f=s.target;if(f.dataset.idx){s.stopPropagation();const p=parseInt(f.dataset.idx||"-1"),o=parseInt(f.dataset.off||"0");p>=0&&i(p,o)}},[i]);return e.jsx("p",{id:`p-$${l}`,"data-start-index":l,onClick:M,className:"max-w-[60ch] mx-auto box-border relative scroll-mt-32",style:{fontSize:`$${b.fontSize}px`,lineHeight:b.lineHeight,marginBottom:b.paragraphSpacing,fontFamily:b.fontFamily==="New York"?"serif":"sans-serif",opacity:.9,whiteSpace:"pre-line",textAlign:"justify",hyphens:"auto",WebkitHyphens:"auto"},children:c.map((s,f)=>e.jsxs(Te.Fragment,{children:[e.jsx($e,{token:s,isActive:s.globalIndex===N,theme:d})," "]},s.id))})}),Ve=t.memo(({sectionIndex:c,paragraphs:N,activeParagraphIndex:i,activeIndex:b,onWordClick:d,onParagraphClick:l,settings:M,theme:s})=>e.jsx("div",{children:N.map((f,p)=>{const o=c*30+p;return Math.abs(o-i)<=1?e.jsx(Le,{startTokenIndex:f.startIndex,tokens:f.tokens,activeIndex:b,onWordClick:d,settings:M,theme:s},o):e.jsx(ze,{text:f.plainText,settings:M,startTokenIndex:f.startIndex,onParagraphClick:l},o)})})),Ae=({book:c,onToggleChrome:N,onRequestRSVP:i,isActive:b})=>{const d=me.getInstance(),l=ae.getInstance(),M=ce.getInstance(),s=le(),{settings:f}=ye(),p=t.useRef(null),[o,G]=t.useState([]),[W,C]=t.useState(-1),$=t.useRef(-1),[V,z]=t.useState(!1),[P,F]=t.useState(0),[D,A]=t.useState(!1),O=t.useRef(!1),k=t.useRef(null);t.useRef(null);const w=t.useCallback(n=>{C(n),$.current=n},[]),E=t.useCallback((n,u)=>{if(!p.current)return;let h=document.getElementById(`w-${n}`);if(!h){const ne=Array.from(p.current.querySelectorAll("p[data-start-index]"));let Q=null,X=-1;for(const se of ne){const q=parseInt(se.dataset.startIndex||"-1");q<=n&&q>X&&(Q=se,X=q)}h=Q}if(!h){if(d.totalTokens>0){const ne=n/d.totalTokens,X=p.current.scrollHeight*ne;p.current.scrollTo({top:X,behavior:u?"smooth":"instant"})}return}O.current=!0;const y=p.current,x=y.clientHeight*.15;let j=h.offsetTop,L=h.offsetParent;for(;L&&L!==y;)j+=L.offsetTop,L=L.offsetParent;const ie=j-x;y.scrollTo({top:Math.max(0,ie),behavior:u?"smooth":"instant"}),setTimeout(()=>{O.current=!1},u?600:100)},[]);t.useEffect(()=>{"scrollRestoration"in history&&(history.scrollRestoration="manual"),z(!1),A(!1),O.current=!0;const u=(d.currentBook?.id===c.id?d.currentBook.lastTokenIndex:void 0)??c.lastTokenIndex;u!==void 0&&w(u);const h=d.subscribe(()=>{F(d.loadingProgress)});return(async()=>{if(z(!1),A(!1),F(0),G([]),!c.chapters||c.chapters.length===0){console.error("[TitanReaderView] Book has no chapters! This indicates a data loading issue.",{bookId:c.id,title:c.title,hasChapters:!!c.chapters,chaptersLength:c.chapters?.length}),z(!0),A(!0);return}try{await d.load(c);const x=d.contentStorage.string;x||console.warn("[TitanReaderView] Loaded book has no content string."),await l.prepare(x,{progress:0})}catch(x){console.error("[TitanReaderView] Initialization pipeline failed:",x)}finally{const x=M.tokens;G(x),z(!0),requestAnimationFrame(()=>{A(!0)})}})(),()=>h()},[c.id,w]),t.useEffect(()=>{const n=()=>{const x=d.currentBook?.lastTokenIndex;if(x===void 0)return;const j=Math.abs(x-$.current);if(j>0&&(w(x),j>10)){const L=d.isRSVPMode;E(x,L)}},u=x=>{if(d.totalTokens>0){const j=Math.floor(x*d.totalTokens);w(j),E(j,d.isRSVPMode)}},h=d.subscribe(n),y=d.onJump(u);return()=>{h(),y()}},[w,E]),t.useEffect(()=>{const n=ae.getInstance(),u=ce.getInstance();let h=n.state;const y=()=>{const j=n.state;if(h==="PLAYING"&&j==="PAUSED"){const L=u.currentIndex;w(L),E(L,!0)}h=j},x=n.subscribe(y);return()=>x()},[w,E]),t.useLayoutEffect(()=>{if(!V||o.length===0)return;requestAnimationFrame(()=>{const u=(d.currentBook?.id===c.id?d.currentBook.lastTokenIndex:c.lastTokenIndex)??-1;u<=10?(p.current&&(p.current.scrollTop=0),setTimeout(()=>{A(!0),O.current=!1},100)):(E(u,!1),setTimeout(()=>A(!0),100))})},[V,o.length,c.id,E]);const B=t.useRef(null),H=t.useRef(-1),Z=t.useCallback(n=>{H.current=n,B.current&&clearTimeout(B.current),B.current=window.setTimeout(()=>{H.current>=0&&d.saveProgress(H.current),B.current=null},500)},[]);t.useEffect(()=>()=>{B.current&&(H.current>=0&&d.saveProgress(H.current),clearTimeout(B.current))},[]),t.useEffect(()=>{if(!D||!b){k.current&&k.current.disconnect();return}k.current&&k.current.disconnect();const n=y=>{if(!O.current){for(const x of y)if(x.isIntersecting){const j=x.target,L=parseInt(j.dataset.startIndex||"-1");if(L>=0){w(L),Z(L);break}}}},u={root:p.current,rootMargin:"-10% 0px -60% 0px",threshold:0};return k.current=new IntersectionObserver(n,u),p.current?.querySelectorAll("p[data-start-index]")?.forEach(y=>k.current?.observe(y)),()=>k.current?.disconnect()},[D,o.length,w]);const Y=t.useMemo(()=>{const n=[];let u=[],h=-1;for(const y of o)u.length===0&&(h=y.globalIndex),u.push(y),y.isParagraphEnd&&(n.push({tokens:u,startIndex:h,plainText:u.map(x=>x.originalText).join(" ")}),u=[]);return u.length>0&&n.push({tokens:u,startIndex:h===-1?0:h,plainText:u.map(y=>y.originalText).join(" ")}),n},[o]),K=t.useCallback((n,u)=>{w(n),d.saveProgress(n),i&&i(u,n)},[i,w]),te=t.useCallback(n=>{w(n),d.saveProgress(n)},[w]),T=t.useMemo(()=>Y.findIndex(n=>W>=n.startIndex&&W<n.startIndex+n.tokens.length),[Y,W]),S=t.useMemo(()=>{const n=[];for(let u=0;u<Y.length;u+=30)n.push(Y.slice(u,u+30));return n},[Y]);return e.jsxs("div",{ref:p,className:"absolute inset-0 z-10 w-full h-full overflow-y-auto overflow-x-hidden custom-scrollbar box-border",style:{backgroundColor:s.background,color:s.primaryText,scrollBehavior:"auto",WebkitOverflowScrolling:"touch",touchAction:"pan-y",overscrollBehaviorY:"contain",transform:"translateZ(0)"},onClick:n=>{n.target===n.currentTarget&&N()},children:[!V&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[100] pointer-events-auto",style:{backgroundColor:s.background},children:e.jsxs("div",{className:"flex flex-col items-center gap-6",children:[e.jsxs("div",{className:"w-12 h-12 relative",children:[e.jsx("div",{className:"absolute inset-0 rounded-full border-2 opacity-20",style:{borderColor:s.accent}}),e.jsx("div",{className:"absolute inset-0 rounded-full border-2 border-t-transparent animate-spin",style:{borderColor:s.accent,borderTopColor:"transparent"}})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"text-sm font-bold tracking-widest lowercase",style:{color:s.secondaryText},children:"loading"}),e.jsxs("span",{className:"text-xs font-mono mt-1 opacity-50",style:{color:s.primaryText},children:[Math.floor(P*100),"%"]})]})]})}),V&&o.length===0&&e.jsx("div",{className:"fixed inset-0 flex items-center justify-center z-[50] pointer-events-auto",style:{backgroundColor:s.background},children:e.jsxs("div",{className:"flex flex-col items-center gap-4 px-8 text-center",children:[e.jsx("div",{className:"text-4xl opacity-30",children:"ðŸ“–"}),e.jsx("span",{className:"text-lg font-medium",style:{color:s.secondaryText},children:"No content available"}),e.jsx("span",{className:"text-sm opacity-60",style:{color:s.secondaryText},children:"This book appears to be empty or failed to load."}),e.jsxs("div",{className:"mt-4 flex gap-3",children:[e.jsx("button",{className:"px-4 py-2 rounded bg-zune-ember text-white text-sm shadow",onClick:async()=>{try{const n=(await ge(async()=>{const{TitanStorage:y}=await import("./cloud-FGMHPRwG.js").then(x=>x.t);return{TitanStorage:y}},__vite__mapDeps([0,1,2]))).TitanStorage.getInstance(),u=(await ge(async()=>{const{IngestionService:y}=await import("./cloud-FGMHPRwG.js").then(x=>x.i);return{IngestionService:y}},__vite__mapDeps([0,1,2]))).IngestionService.getInstance(),h=await n.getSource(c.id);if(h){const y=new File([h],`${c.title||"book"}.epub`,{type:"application/epub+zip"}),x=await u.ingest(y);await n.saveBook(x),await n.saveSource(x.id,h),window.location.reload();return}if(c.id==="guide-book-v1"){const x=(await ge(async()=>{const{generateMockBooks:j}=await import("./index-BC47H-GM.js").then(L=>L.m);return{generateMockBooks:j}},__vite__mapDeps([3,2,4,1,5,0]))).generateMockBooks().find(j=>j.id==="guide-book-v1");if(x){await n.saveBook(x),window.location.reload();return}}alert("Repair failed: no source available to re-ingest. Try re-importing the book or use the Library to open a different title.")}catch(n){console.error("Repair failed",n),alert("Repair failed â€” see console for details.")}},children:"Repair book"}),e.jsx("button",{className:"px-4 py-2 rounded border border-neutral-700 text-sm",onClick:()=>{p.current&&(p.current.scrollTop=0)},children:"Scroll to top"})]})]})}),e.jsxs("div",{className:"w-full min-h-[100dvh] px-6 md:px-0 py-24 md:py-32 box-border relative",children:[S.map((n,u)=>e.jsx(Ve,{sectionIndex:u,paragraphs:n,activeParagraphIndex:T,activeIndex:W,onWordClick:K,onParagraphClick:te,settings:f,theme:s},u)),e.jsx("div",{className:"h-[40vh]"})]})]})},Be=({onTap:c,onLongPressExit:N,onRewindStateChange:i})=>{const b=ae.getInstance(),d=ce.getInstance(),l=le(),{settings:M}=ye(),s=t.useRef(null),f=t.useRef(null),[p,o]=t.useState(0),[G,W]=t.useState([]),[C,$]=t.useState(!1),[V,z]=t.useState(0),[P,F]=t.useState(!1),D=t.useRef(-1),A=t.useRef([]),O=t.useRef({x:0,y:0,time:0}),k=t.useRef(null),w=t.useRef(null),E=t.useRef(0),B=t.useRef(new Map),H=t.useRef(0),Z=t.useRef(0),Y=t.useRef(!1),K=300,te=100,T=50,S="#E25822",n=35.5,u="clamp(2.5rem, 10vw, 4rem)";t.useEffect(()=>{W(d.tokens),A.current=d.tokens,D.current=d.currentIndex,o(d.currentIndex),$(b.state===ee.PLAYING);const a=()=>{const v=d.currentIndex,I=b.state===ee.PLAYING,_=d.tokens;$(I);const U=_!==A.current,oe=v!==D.current;U&&(W(_),A.current=_),oe&&(D.current=v,o(v))},m=b.subscribe(a),R=d.subscribe(a);return a(),()=>{m(),R()}},[]);const h=t.useMemo(()=>G[p]||null,[G,p]),y=!C||M.showGhostPreview,x=5,j=t.useMemo(()=>{if(G.length===0)return[];if(!y)return h?[{token:h,globalIdx:p}]:[];const a=Math.max(0,p-x),m=Math.min(G.length-1,p+x);return G.slice(a,m+1).map((R,v)=>({token:R,globalIdx:a+v}))},[G,p,y,x,h]);t.useLayoutEffect(()=>{if(!f.current)return;const a=f.current,m=Array.from(a.children),v=(s.current?.clientWidth||window.innerWidth)*(n/100);B.current.clear(),m.forEach(_=>{const U=parseInt(_.dataset.idx||"0"),oe=_.getBoundingClientRect(),ve=a.getBoundingClientRect(),ue=oe.left-ve.left;let de=ue+oe.width/2;if(U===p&&h){const fe=h.originalText,we=se(fe);try{const pe=_.querySelector&&_.querySelector("span:nth-child(2)")||null;if(pe&&pe.getBoundingClientRect){const re=pe.getBoundingClientRect();de=(re.left+re.right)/2-ve.left}else if(fe.length>0){const re=oe.width/fe.length,he=we*re+re/2;de=ue+he}}catch{const re=oe.width/Math.max(1,fe.length),he=we*re+re/2;de=ue+he}}B.current.set(U,{left:ue,width:oe.width,center:de})});const I=B.current.get(p);I&&z(v-I.center)},[j,p,h]),t.useEffect(()=>()=>{k.current&&clearTimeout(k.current),w.current&&clearInterval(w.current)},[]);const L=a=>{a.stopPropagation();const m=Date.now();if(Y.current||m-H.current<te)return;H.current=m,a.target.setPointerCapture?.(a.pointerId);const R=a.target,v=R.dataset.idx?parseInt(R.dataset.idx):null;if(v!==null){m-Z.current>=T&&(Z.current=m,Y.current=!0,d.seek(v),o(v),J.impactMedium(),requestAnimationFrame(()=>{Y.current=!1}));return}if(!C){Y.current=!0,N?.(),setTimeout(()=>{Y.current=!1},300);return}O.current={x:a.clientX,y:a.clientY,time:Date.now()},k.current=setTimeout(()=>{F(!0),J.impactLight(),E.current=p,b.pause(),w.current=setInterval(()=>{E.current=Math.max(0,E.current-1),o(E.current),J.selectionChanged(),E.current<=0&&X()},300),setTimeout(()=>{P&&X()},3e4)},K)},ie=a=>{if(P){const m=Math.abs(a.clientX-O.current.x),R=Math.abs(a.clientY-O.current.y);(m>50||R>50)&&X()}},ne=a=>{a.target.releasePointerCapture?.(a.pointerId),k.current&&(clearTimeout(k.current),k.current=null),X()},Q=a=>{a.target.releasePointerCapture?.(a.pointerId),k.current&&(clearTimeout(k.current),k.current=null),X()},X=()=>{P&&(w.current&&(clearInterval(w.current),w.current=null),F(!1),d.pause(),d.currentIndex=Math.max(0,Math.min(E.current,d.tokens.length-1)),d.notify(),b.play(),J.impactMedium())};if(t.useEffect(()=>{!P&&p!==d.currentIndex&&o(d.currentIndex)},[P]),t.useEffect(()=>{i?.(P)},[P,i]),!h)return null;const se=a=>{const m=Math.max(1,a.length);if(m<=3)return 0;const R=Math.floor(m*.3);return Math.min(m-1,Math.max(0,R))},q=se(h.originalText),xe=h.originalText.slice(0,q),r=h.originalText[q]||"",g=h.originalText.slice(q+1);return e.jsxs("div",{ref:s,role:"application","aria-label":"Speed reading view. Tap to pause, swipe to navigate, hold to exit.","aria-live":"off",className:"absolute inset-0 select-none overflow-hidden touch-none",style:{backgroundColor:l.background},onPointerDown:L,onPointerMove:ie,onPointerUp:ne,onPointerCancel:Q,onPointerLeave:Q,children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{backgroundColor:l.background,opacity:.95}}),e.jsx("div",{className:"absolute inset-0 z-10 pointer-events-none",style:{background:`radial-gradient(ellipse 80% 50% at ${n}% 42%, transparent 0%, ${l.background} 100%)`}}),e.jsx("div",{className:"absolute top-[20%] bottom-[20%] w-[2px] z-0 pointer-events-none transition-all duration-200",style:{left:`${n}%`,backgroundColor:S,opacity:P?.6:.15,boxShadow:P?`0 0 30px ${S}80`:"none"}}),e.jsxs("div",{className:"absolute inset-x-0 top-[42%] -translate-y-1/2 flex items-center justify-start overflow-visible z-20",children:[y&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute left-0 top-[-50%] bottom-[-50%] w-32 z-30 pointer-events-none",style:{background:`linear-gradient(to right, ${l.background}, transparent)`}}),e.jsx("div",{className:"absolute right-0 top-[-50%] bottom-[-50%] w-32 z-30 pointer-events-none",style:{background:`linear-gradient(to left, ${l.background}, transparent)`}})]}),e.jsx("div",{ref:f,className:"flex items-baseline gap-5 whitespace-nowrap will-change-transform",style:{transform:`translateX(${V}px)`,transition:P?"transform 0.05s linear":"none",opacity:P?.85:1},children:j.map(({token:a,globalIdx:m})=>{const R=m===p,v=Math.abs(m-p),I=Math.max(.12,.55-v*.1);return R?e.jsxs("span",{"data-idx":m,className:"inline-flex items-baseline font-sans font-semibold cursor-pointer transition-opacity hover:opacity-100",style:{fontSize:u},children:[e.jsx("span",{style:{color:l.primaryText},children:xe}),e.jsx("span",{style:{color:S,textShadow:P?`0 0 10px ${S}60`:`0 0 20px ${S}40`},children:r}),e.jsx("span",{style:{color:l.primaryText},children:g}),a.punctuation&&e.jsx("span",{style:{color:l.secondaryText,opacity:.5,marginLeft:"1px"},children:a.punctuation})]},a.id):e.jsx("span",{"data-idx":m,className:"font-sans cursor-pointer transition-opacity hover:opacity-100",style:{fontSize:u,fontWeight:400,color:l.primaryText,opacity:I},children:a.originalText},a.id)})})]})]})},_e=({book:c,currentProgress:N,preciseThresholds:i,onSelectChapter:b,onSelect:d,onClose:l,readSpeed:M})=>{const s=le(),f=t.useRef(null),p=t.useMemo(()=>!c.chapters||c.chapters.length===0?[]:c.chapters.map((C,$)=>{const V=i[$]??0;let z=C.title.trim();const P=z.match(/^(?:chapter|part|book|letter|section)\s+(?:[\divxlcdm]+)\s*[:.-]\s+(.+)$/i),F=z.match(/^\d+\.\s+(.+)$/i);P&&P[1]?z=P[1]:F&&F[1]&&(z=F[1]);const D=Math.ceil(C.wordCount/M);return{original:C,index:$,cleanTitle:z,startProgress:V,durationLabel:D<1?"< 1m":`${D}m`}}),[c,M,i]),o=t.useMemo(()=>{let C=0;for(let $=0;$<p.length&&N>=p[$].startProgress-1e-4;$++)C=$;return C},[p,N]);t.useEffect(()=>{if(f.current){const $=Math.max(0,o*64-100);f.current.scrollTo({top:$,behavior:"smooth"})}},[]);const G=C=>{J.impactMedium(),b?b(C):d&&d(p[C].startProgress),l()},W=t.useRef(Date.now());return e.jsxs("div",{className:"absolute bottom-full mb-4 left-2 right-2 z-50 flex flex-col max-h-[60vh] rounded-3xl overflow-hidden shadow-2xl border backdrop-blur-3xl origin-bottom animate-slideUp",style:{backgroundColor:`${s.dimmer}f5`,borderColor:s.borderColor},children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b shrink-0",style:{borderColor:s.borderColor},children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-base font-bold lowercase",style:{color:s.primaryText},children:"chapters"}),e.jsxs("span",{className:"text-[10px] opacity-40",style:{color:s.secondaryText},children:[p.length," ",p.length!==1?"sections":"section"]})]}),e.jsx("button",{onClick:l,className:"w-11 h-11 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${s.primaryText}08`,color:s.primaryText},children:e.jsx(Ce,{size:20})})]}),e.jsx("div",{ref:f,className:"overflow-y-auto custom-scrollbar px-2 pb-4 pt-1",children:p.map((C,$)=>{const V=$===o;return e.jsxs("button",{onClick:()=>G(C.index),className:`w-full text-left flex items-center gap-3 p-3 rounded-2xl transition-all duration-200 group ${V?"shadow-md":"hover:bg-white/5 opacity-50"}`,style:{backgroundColor:V?s.surface:"transparent"},children:[e.jsx("div",{className:`w-10 h-10 rounded-xl flex items-center justify-center shrink-0 transition-all ${V?"bg-white/5":"bg-transparent"}`,style:{color:V?s.accent:s.secondaryText},children:V?e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 bg-current opacity-30 animate-ping rounded-full"}),e.jsx("div",{className:"w-2.5 h-2.5 bg-current rounded-full"})]}):e.jsx("span",{className:"text-xs font-semibold opacity-40 tabular-nums",children:$+1})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-semibold truncate lowercase",style:{color:s.primaryText},children:C.cleanTitle}),C.cleanTitle!==C.original.title&&e.jsx("span",{className:"text-[10px] opacity-30 truncate block",style:{color:s.primaryText},children:C.original.title})]}),e.jsx("div",{className:"flex items-center gap-1 opacity-40 shrink-0",style:{color:s.primaryText},children:e.jsx("span",{className:"text-[11px] font-medium tabular-nums",children:C.durationLabel})})]},C.original.id)})})]},W.current)},Fe=t.memo(({book:c,onToggleRSVP:N,isRSVPActive:i,isRewinding:b=!1,onSettingsClick:d})=>{const l=me.getInstance(),M=ae.getInstance(),s=ce.getInstance(),{settings:f,updateSettings:p}=ye(),o=le(),[G,W]=t.useState(!1),[C,$]=t.useState(!1),[V,z]=t.useState(0),[P,F]=t.useState(0),[D,A]=t.useState(!1),O=t.useRef(!1),k=t.useRef(null),w=t.useRef(null),E=t.useRef(null),B=t.useRef(!1),H=t.useRef(null),Z=t.useRef(0),Y=t.useRef(0),K=t.useRef(!1),te=t.useRef(0),T=t.useRef(0),S=o.accent,n=t.useCallback(r=>r<=150?"relaxed":r<=200?"easy":r<=275?"normal":r<=350?"brisk":r<=450?"fast":"turbo",[]),u=t.useMemo(()=>{if(l.chapterTokenOffsets.length>0&&l.totalTokens>0)return l.chapterTokenOffsets.map(a=>a/l.totalTokens);if(!c.chapters||c.chapters.length===0)return[];const r=c.chapters.reduce((a,m)=>a+m.wordCount,0);if(r===0)return c.chapters.map((a,m)=>m/c.chapters.length);let g=0;return c.chapters.map(a=>{const m=g/r;return g+=a.wordCount,m})},[c,l.chapterTokenOffsets,l.totalTokens]),h=t.useCallback(r=>{const g=Math.max(1,s.tokens.length||l.totalTokens),a=Math.floor(r*g),m=g-a,R=f.rsvpSpeed||250,v=Math.ceil(m/R);if(v<1)return"< 1m";if(v>=60){const I=Math.floor(v/60),_=v%60;return`${I}h ${_}m`}return`${v}m`},[f.rsvpSpeed,s.tokens.length,l.totalTokens]),y=t.useCallback(r=>{if(!c.chapters||c.chapters.length===0)return"";let g=0;for(let I=u.length-1;I>=0;I--)if(r>=u[I]-1e-4){g=I;break}const a=c.chapters[g];if(!a)return"";const m=a.title.trim(),R=m.match(/^(?:chapter|part|book|letter|section)\s+(?:[\divxlcdm]+)\s*[:.-]\s+(.+)$/i),v=m.match(/^\d+\.\s+(.+)$/i);return R&&R[1]?R[1]:v&&v[1]?v[1]:m},[c.chapters,u]),x=t.useRef(0),j=t.useCallback(r=>{const g=Math.max(0,Math.min(1,r));if(k.current&&(k.current.style.width=`${g*100}%`),E.current&&(E.current.style.left=`${g*100}%`,E.current.style.transform="translateX(-50%)"),O.current)return;(Math.abs(g-x.current)>.005||g===0||g===1)&&(x.current=g,F(g))},[]);t.useEffect(()=>{const r=()=>{W(M.state===ee.PLAYING)},g=U=>{B.current||j(U)},a=()=>{if(!B.current&&l.isRSVPMode&&s.tokens.length>0){const U=s.currentIndex/s.tokens.length;j(U)}};r();const m=l.isRSVPMode&&s.tokens.length>0?s.currentIndex/s.tokens.length:l.currentProgress;x.current=m,F(m),j(m);const R=l.subscribe(r),v=M.subscribe(r),I=l.onProgress(g),_=s.subscribe(a);return()=>{R(),v(),I(),_()}},[j]);const L=r=>{if(r.preventDefault(),r.stopPropagation(),$(!0),B.current=!0,Z.current=r.clientY,w.current){const g=w.current.getBoundingClientRect();Y.current=Math.max(0,Math.min(1,(r.clientX-g.left)/g.width))}K.current=M.state===ee.PLAYING,K.current&&M.pause(),Q(r.clientX,r.clientY,!1),r.target.setPointerCapture(r.pointerId)},ie=r=>{B.current&&(r.preventDefault(),H.current&&cancelAnimationFrame(H.current),H.current=requestAnimationFrame(()=>{Q(r.clientX,r.clientY,!0)}))},ne=r=>{if(B.current){if(H.current&&cancelAnimationFrame(H.current),$(!1),B.current=!1,r.target.releasePointerCapture(r.pointerId),w.current){const g=w.current.getBoundingClientRect(),a=Math.max(0,Math.min(1,(r.clientX-g.left)/g.width));X(a)}K.current&&M.play()}},Q=(r,g,a)=>{if(!w.current)return;const m=w.current.getBoundingClientRect();let R=(r-m.left)/m.width;if(a){const I=Math.abs(g-Z.current);let _=1;I>200?_=.1:I>100?_=.3:I>50&&(_=.6),_<1&&(R=Y.current+(R-Y.current)*_)}const v=Math.max(0,Math.min(1,R));if(z(I=>(u.some(U=>I<U&&v>=U||I>U&&v<=U)&&J.impactLight(),v)),j(v),l.isRSVPMode){const I=Math.max(1,s.tokens.length);s.seek(Math.floor(v*I))}else l.jump(v)},X=r=>{if(l.isRSVPMode){const g=Math.max(1,s.tokens.length);s.seek(Math.floor(r*g))}else l.jump(r)},se=r=>{r.stopPropagation();const g=Date.now();g-te.current<300||(te.current=g,navigator.vibrate&&navigator.vibrate(10),N())},q=r=>{const g=Date.now();if(g-T.current<80)return;T.current=g,J.impactLight();const a=f.rsvpSpeed||250,m=Math.max(50,Math.min(2e3,a+r));p({rsvpSpeed:m,hasCustomSpeed:!0})},xe=r=>{if(J.impactMedium(),l.isRSVPMode){if(r<l.chapterTokenOffsets.length){const g=l.chapterTokenOffsets[r];s.seek(g),l.jumpToChapter(r)}}else l.jumpToChapter(r)};return e.jsxs("div",{className:"w-full relative pointer-events-auto",children:[D&&e.jsx(_e,{book:c,currentProgress:P,readSpeed:f.rsvpSpeed,preciseThresholds:u,onSelectChapter:r=>xe(r),onClose:()=>{O.current=!1,A(!1)}}),C&&!D&&e.jsx("div",{className:"absolute -top-12 left-0 right-0 flex justify-center pointer-events-none z-50",style:{animation:"fadeIn 300ms cubic-bezier(0.16, 1, 0.3, 1)"},children:e.jsxs("div",{className:"px-4 py-1.5 rounded-full shadow-xl border backdrop-blur-md text-xs font-bold font-variant-numeric tabular-nums flex items-center gap-2",style:{backgroundColor:o.surface,borderColor:o.borderColor,color:o.primaryText},children:[e.jsxs("span",{children:[(V*100).toFixed(0),"%"]}),e.jsx("span",{className:"opacity-30",children:"|"}),e.jsx("span",{className:"lowercase",children:h(V)})]})}),e.jsxs("div",{className:"w-full backdrop-blur-2xl rounded-3xl shadow-2xl border overflow-hidden",style:{backgroundColor:`${o.surface}f5`,borderColor:o.borderColor},children:[e.jsxs("button",{onClick:()=>{J.impactLight(),!D&&M.state===ee.PLAYING&&M.pause();const r=!D;O.current=r,A(r)},className:"w-full flex justify-between items-center px-5 pt-2.5 pb-0 text-[10px] font-medium select-none hover:opacity-100 transition-opacity active:scale-[0.99]",style:{color:o.primaryText,opacity:D?.8:.4},children:[e.jsxs("div",{className:"flex items-center gap-1.5 truncate max-w-[70%]",children:[e.jsx(Se,{size:10,className:"opacity-60"}),e.jsx("span",{className:"truncate lowercase",children:y(P)})]}),e.jsx("span",{className:"tabular-nums opacity-60 text-[9px]",children:h(P)})]}),e.jsx("div",{className:"relative h-4 w-full cursor-pointer group touch-none z-20",onPointerDown:L,onPointerMove:ie,onPointerUp:ne,onPointerCancel:ne,children:e.jsxs("div",{ref:w,className:"absolute inset-x-6 inset-y-0 flex items-center",children:[e.jsxs("div",{className:"w-full h-[1.5px] rounded-full overflow-hidden relative",style:{backgroundColor:o.primaryText+"08"},children:[e.jsx("div",{ref:k,className:"absolute top-0 left-0 bottom-0 h-full will-change-transform rounded-full",style:{width:"0%",backgroundColor:S}}),t.useMemo(()=>u.map((r,g)=>e.jsx("div",{className:"absolute top-0 bottom-0 w-[1px] bg-white/10",style:{left:`${r*100}%`}},g)),[u])]}),e.jsx("div",{ref:E,className:`absolute top-1/2 w-3.5 h-3.5 -mt-[7px] rounded-full shadow-lg border-2 border-white transition-all duration-200 will-change-transform ${C?"scale-125":"scale-0 group-hover:scale-75"}`,style:{left:"0%",backgroundColor:o.accent,boxShadow:`0 0 10px ${o.accent}33`}})]})}),e.jsxs("div",{className:"grid grid-cols-[1fr_auto_1fr] items-center px-5 pb-4 pt-0.5",children:[e.jsxs("div",{className:"flex items-center h-11 rounded-xl overflow-hidden border",style:{borderColor:o.borderColor,backgroundColor:`${o.primaryText}05`},role:"group","aria-label":"Reading speed control",children:[e.jsx("button",{onClick:()=>q(-25),"aria-label":"Decrease reading speed",className:"w-11 h-full flex items-center justify-center hover:bg-white/5 active:scale-90 transition-all outline-none",style:{color:o.secondaryText},children:e.jsx(je,{size:16})}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:o.borderColor}}),e.jsxs("div",{className:"px-2 text-center flex flex-col items-center justify-center min-w-[52px]",children:[e.jsx("span",{className:"font-variant-numeric tabular-nums text-xs font-semibold leading-tight",style:{color:o.primaryText},children:f.rsvpSpeed}),e.jsx("span",{className:"text-[9px] uppercase tracking-wide opacity-60",style:{color:o.secondaryText},children:n(f.rsvpSpeed)})]}),e.jsx("div",{className:"w-px h-5",style:{backgroundColor:o.borderColor}}),e.jsx("button",{onClick:()=>q(25),"aria-label":"Increase reading speed",className:"w-11 h-full flex items-center justify-center hover:bg-white/5 active:scale-90 transition-all outline-none",style:{color:o.secondaryText},children:e.jsx(Pe,{size:16})})]}),e.jsx("div",{className:"flex items-center justify-center px-4",children:e.jsx("button",{onClick:se,className:"w-12 h-12 rounded-full flex items-center justify-center shadow-lg relative text-white border border-white/10 hover:scale-105 active:scale-95 transition-all outline-none",style:{backgroundColor:S,boxShadow:`0 6px 24px -4px ${S}66`},children:b?e.jsx(ke,{size:20,className:"fill-white animate-pulse"}):i&&G?e.jsx(Re,{size:20,className:"fill-white"}):e.jsx(Ie,{size:20,className:"fill-white ml-0.5"})})}),e.jsxs("div",{className:"flex items-center gap-2",children:[i&&e.jsx("button",{className:"flex items-center justify-center w-11 h-11 rounded-xl border transition-all outline-none active:scale-95",style:{borderColor:f.showGhostPreview?o.accent+"40":o.borderColor,backgroundColor:f.showGhostPreview?`${o.accent}15`:`${o.primaryText}05`,color:f.showGhostPreview?o.accent:o.secondaryText},onClick:r=>{r.stopPropagation(),J.impactLight(),p({showGhostPreview:!f.showGhostPreview})},title:f.showGhostPreview?"Hide word preview":"Show word preview",children:e.jsx(Ne,{size:16,className:f.showGhostPreview?"fill-current":""})}),e.jsxs("button",{className:"flex items-center justify-center h-11 gap-2 rounded-xl border hover:bg-white/5 active:scale-95 transition-all outline-none px-3",style:{borderColor:o.borderColor,backgroundColor:`${o.primaryText}05`},onClick:r=>{r.stopPropagation(),d()},children:[e.jsx(be,{size:16,style:{color:o.secondaryText}}),e.jsx("div",{className:"w-px h-4",style:{backgroundColor:o.borderColor}}),e.jsxs("div",{className:"flex items-baseline gap-0.5 opacity-60",children:[e.jsx(be,{size:14,style:{color:o.secondaryText}}),e.jsx(be,{size:10,style:{color:o.secondaryText}})]})]})]})]})]})]})}),Xe=({book:c,onClose:N})=>{const i=me.getInstance(),b=ae.getInstance(),d=ce.getInstance(),l=le(),[M,s]=t.useState(!0),[f,p]=t.useState(!1),[o,G]=t.useState(!1),[W,C]=t.useState(!1),[$,V]=t.useState(0),[z,P]=t.useState(!1),[F,D]=t.useState(!1),A=t.useRef(!1),O=t.useRef(!1);t.useEffect(()=>{p(i.isRSVPMode);const T=()=>{p(i.isRSVPMode),G(b.state===ee.PLAYING),V(i.currentProgress)},S=i.subscribe(T),n=b.subscribe(T);return T(),()=>{S(),n()}},[]),t.useEffect(()=>()=>{b.shutdown(i.isRSVPMode),i.isRSVPMode=!1,d.clear()},[]),t.useEffect(()=>{const T=()=>{if(!A.current){if(A.current=!0,z||F)k();else if(f){const S=me.getInstance(),n=ae.getInstance();S.isRSVPMode&&(n.pause(),n.shutdown(!0),S.isRSVPMode=!1,S.notify(),p(!1),s(!0))}A.current=!1}};return window.addEventListener("popstate",T),()=>window.removeEventListener("popstate",T)},[z,F,f]),t.useEffect(()=>{let T;return M&&f&&(T=setTimeout(()=>s(!1),2500)),()=>clearTimeout(T)},[M,f]),t.useEffect(()=>{z&&b.state===ee.PLAYING&&b.pause()},[z]);const k=()=>{D(!0),setTimeout(()=>{P(!1),D(!1)},400)},w=()=>{let T=i.currentBook?.lastTokenIndex??(c.lastTokenIndex||0);i.isRSVPMode&&(T=d.currentIndex,i.saveProgress(T));const S=i.currentProgress;b.shutdown(i.isRSVPMode),i.isRSVPMode=!1,N(c.id,T,S)},E=async(T,S,n)=>{if(O.current)return;if(f&&T===void 0&&S===void 0&&n===void 0){b.state===ee.PLAYING?b.pause(!0):b.play();return}const u=T??!i.isRSVPMode;if(!(u===i.isRSVPMode&&S===void 0&&n===void 0)){O.current=!0;try{if(u){const h=i.contentStorage.string,y={offset:S??i.userSelectionOffset??void 0,index:n??(S===void 0?i.currentBook?.lastTokenIndex??void 0:void 0),progress:S===void 0&&n===void 0?i.currentProgress:void 0};await b.prepare(h,y),i.isRSVPMode=!0,i.notify(),A.current||window.history.pushState({rsvpMode:!0},"",window.location.href),b.play(),s(!1)}else{b.pause();const h=d.currentIndex;if(i.isRSVPMode=!1,i.saveProgress(h,!0),i.totalTokens>0){const y=h/i.totalTokens;i.jump(y)}s(!0)}}catch(h){console.error("Toggle failed",h),i.isRSVPMode=!1,i.notify()}finally{O.current=!1}}},B=t.useCallback(()=>{b.state===ee.PLAYING?b.pause(!0):b.play()},[]),H=t.useCallback(()=>{i.isRSVPMode&&E(!1)},[]),Z=t.useCallback(()=>{A.current||window.history.pushState({modal:"settings"},"",window.location.href),P(!0)},[]),Y=t.useCallback(()=>{s(T=>!T)},[]),K=t.useCallback((T,S)=>{E(!0,T,S)},[]),te=t.useCallback(T=>{E(void 0,T)},[]);return e.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden m-0 p-0 animate-fadeIn",style:{backgroundColor:l.background},children:[e.jsx("div",{className:"absolute inset-0 z-10 w-full h-full will-change-transform transition-opacity duration-300",style:{opacity:f?o?0:.4:1,pointerEvents:f?"none":"auto"},children:e.jsx(Ae,{book:c,onToggleChrome:Y,onRequestRSVP:K,isActive:!f})}),e.jsxs("div",{className:`absolute inset-0 z-20 transition-all duration-300 will-change-[transform,opacity] ${f?"opacity-100 scale-100":"opacity-0 scale-95"}`,style:{pointerEvents:f?"auto":"none",transitionTimingFunction:"cubic-bezier(0.2, 0, 0, 1)"},children:[e.jsx(Be,{onTap:B,onLongPressExit:H,onRewindStateChange:C}),e.jsx("style",{children:`
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
      `})]}),e.jsx("div",{className:"absolute left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50 pointer-events-auto",style:{bottom:"calc(2rem + env(safe-area-inset-bottom))"},children:e.jsx(Fe,{book:c,onToggleRSVP:te,isRSVPActive:f,isRewinding:W,onSettingsClick:Z})}),e.jsx("div",{className:`absolute top-0 left-0 right-0 z-[60] transition-transform duration-400 pointer-events-none ${M||f&&!o?"translate-y-0":"-translate-y-full"}`,style:{transitionTimingFunction:"cubic-bezier(0.16, 1, 0.3, 1)"},children:e.jsxs("div",{className:"backdrop-blur-2xl border-b pt-safe-top py-4 px-5 flex items-center justify-between pointer-events-auto",style:{backgroundColor:l.dimmer,borderColor:l.borderColor},children:[e.jsx("button",{onClick:f?H:w,className:"w-11 h-11 -ml-1 rounded-full flex items-center justify-center transition-all active:scale-95",style:{backgroundColor:`${l.primaryText}08`,color:l.primaryText},children:e.jsx(Me,{size:20})}),f&&e.jsx("span",{className:"text-xs font-medium",style:{color:l.secondaryText},children:"Tap to exit RSVP"})]})}),(z||F)&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-[100]",style:{backgroundColor:"rgba(0,0,0,0.5)",backdropFilter:"blur(2px)",animation:F?"fadeOut 0.4s ease-out":"fadeIn 0.6s ease-out"},onClick:k}),e.jsx("div",{className:"fixed bottom-0 left-0 right-0 z-[101] rounded-t-[32px] h-[70vh] shadow-2xl overflow-hidden",style:{backgroundColor:l.background,animation:F?"slideDown 0.5s cubic-bezier(0.7, 0, 0.84, 0)":"slideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1)"},children:e.jsx(Ee,{onClose:k})})]})]})};export{Xe as ReaderContainer};
