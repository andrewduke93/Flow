import{j as t,r as n}from"./animations-D9Wo9mUM.js";import{u as I,T as $}from"./index-CP2cVjs9.js";import{u as L,R as j}from"./rsvp-ChCL7CNZ.js";import{T as N}from"./cloud-BD3GCjEV.js";import{M as V,l as D,m as H,n as q,o as J,P as K,p as Q,q as U,E as X,r as Y,s as Z,t as ee}from"./icons-DhCoUMbR.js";import"./vendor-react-uIRdnfX0.js";class b{constructor(){this.words=[],this.sourceText="",this.totalWords=0,this._position=0,this._isPlaying=!1,this._wpm=300,this.playbackTimer=null,this.positionListeners=new Set,this.playStateListeners=new Set}static getInstance(){return b.instance||(b.instance=new b),b.instance}load(s){if(this.stop(),this.sourceText=s,this.words=[],!s||s.length===0){this.totalWords=0;return}const o=Math.ceil(s.length/5);this.words=new Array(o);let e=0,i=-1,l=!0,h=!1;for(let c=0;c<=s.length;c++){const p=c<s.length?s[c]:" ",u=p===" "||p==="	"||p===`
`||p==="\r";if(p===`
`&&(h=!0),u&&!l&&i>=0){const T=s.slice(i,c);let g=0;const x=T[T.length-1];x==="."||x==="!"||x==="?"?g=2:(x===","||x===";"||x===":"||x==="â€”"||x==="â€“")&&(g=1),this.words[e]={text:T,start:i,end:c,index:e,trailingPause:g},e++,i=-1}else!u&&l&&(i=c,h&&e>0&&(this.words[e-1].trailingPause=3),h=!1);l=u}this.words.length=e,this.totalWords=e}get position(){return this._position}set position(s){const o=Math.max(0,Math.min(this.totalWords-1,s));o!==this._position&&(this._position=o,this.notifyPosition())}get progress(){return this.totalWords>0?this._position/this.totalWords:0}set progress(s){this.position=Math.floor(s*this.totalWords)}get total(){return this.totalWords}getWord(s){return this.words[s]||null}getCurrentWord(){return this.words[this._position]||null}getWindow(s,o){const e=Math.max(0,this._position-s),i=Math.min(this.totalWords,this._position+o);return this.words.slice(e,i)}getRange(s,o){const e=Math.max(0,s),i=Math.min(this.totalWords,e+o);return this.words.slice(e,i)}getParagraphs(s,o){const e=[];let i=[],l=s;for(let h=s;h<this.totalWords&&e.length<o;h++){const c=this.words[h];i.length===0&&(l=h),i.push(c),c.trailingPause===3&&(e.push({words:i,startIndex:l}),i=[])}return i.length>0&&e.length<o&&e.push({words:i,startIndex:l}),e}wordIndexFromProgress(s){return Math.floor(s*this.totalWords)}get isPlaying(){return this._isPlaying}get wpm(){return this._wpm}set wpm(s){this._wpm=Math.max(50,Math.min(1500,s)),this._isPlaying&&(this.stop(),this.play())}play(){this._isPlaying||this.totalWords===0||(this._isPlaying=!0,this.notifyPlayState(),this.scheduleNext())}stop(){this.playbackTimer!==null&&(clearTimeout(this.playbackTimer),this.playbackTimer=null),this._isPlaying&&(this._isPlaying=!1,this.notifyPlayState())}toggle(){this._isPlaying?this.stop():this.play()}scheduleNext(){if(!this._isPlaying)return;const s=this.getCurrentWord();if(!s){this.stop();return}let o=6e4/this._wpm;const e=s.trailingPause;e===1?o*=1.3:e===2?o*=1.8:e===3&&(o*=2.2);const i=s.text.length;i>10?o*=1.2:i>7?o*=1.1:i<=2&&(o*=.85),this.playbackTimer=window.setTimeout(()=>{this._position<this.totalWords-1?(this.position=this._position+1,this.scheduleNext()):this.stop()},o)}skipForward(s=10){this.position=this._position+s}skipBack(s=10){this.position=this._position-s}jumpToStart(){this.position=0}jumpToEnd(){this.position=this.totalWords-1}onPosition(s){return this.positionListeners.add(s),()=>this.positionListeners.delete(s)}onPlayState(s){return this.playStateListeners.add(s),()=>this.playStateListeners.delete(s)}notifyPosition(){const s=this._position;this.positionListeners.forEach(o=>o(s))}notifyPlayState(){const s=this._isPlaying;this.playStateListeners.forEach(o=>o(s))}getStats(){return{totalWords:this.totalWords,position:this._position,progress:this.progress,isPlaying:this._isPlaying,wpm:this._wpm}}cleanup(){this.stop(),this.words=[],this.sourceText="",this.totalWords=0,this._position=0}}const te=({book:d,onToggleChrome:s,isActive:o})=>{b.getInstance();const e=I(),{settings:i}=L(),l=d?.chapters?[...d.chapters].sort((u,a)=>u.sortOrder-a.sortOrder):[],h=[];for(const u of l)if(u.content){const a=u.content.replace(/<[^>]*>/g," ").replace(/&[a-z]+;/gi," ").replace(/\s+/g," ").trim();a&&h.push(a)}const p=h.join(`

`).split(/\n{2,}/).filter(Boolean);return t.jsx("div",{className:"absolute inset-0 overflow-y-auto",style:{backgroundColor:e.background},children:t.jsx("div",{style:{maxWidth:"65ch",margin:"0 auto",padding:"80px 24px 200px",fontSize:i.fontSize,lineHeight:i.lineHeight,fontFamily:i.fontFamily,color:e.primaryText},children:p.map((u,a)=>t.jsx("p",{style:{marginBottom:"1.5em",textAlign:"justify"},children:u},a))})})},le=({book:d,onClose:s})=>{const o=b.getInstance(),e=I(),{settings:i,updateSettings:l}=L(),[h,c]=n.useState(!0),[p,u]=n.useState(!1),[a,T]=n.useState(0),[g,x]=n.useState(i.rsvpSpeed||300),[y,S]=n.useState(i.showGhostPreview??!0),[k,M]=n.useState(!1),v=n.useRef(),w=n.useRef();n.useEffect(()=>{o.wpm=i.rsvpSpeed||300,x(o.wpm),S(i.showGhostPreview??!0);const r=o.onPosition(f=>{T(o.progress),w.current&&clearTimeout(w.current),w.current=setTimeout(()=>{const P={...d,lastTokenIndex:f,bookmarkProgress:o.progress,lastOpened:new Date};N.getInstance().saveBook(P)},200)}),m=o.onPlayState(f=>{if(u(f),f)v.current=setTimeout(()=>c(!1),3e3);else{c(!0),w.current&&clearTimeout(w.current);const P={...d,lastTokenIndex:o.position,bookmarkProgress:o.progress,lastOpened:new Date};N.getInstance().saveBook(P)}});return()=>{if(r(),m(),v.current&&clearTimeout(v.current),w.current){clearTimeout(w.current);const f={...d,lastTokenIndex:o.position,bookmarkProgress:o.progress,lastOpened:new Date};N.getInstance().saveBook(f)}}},[d.id]),n.useEffect(()=>()=>o.stop(),[]);const C=n.useCallback(()=>{o.stop(),s(d.id,o.position,o.progress)},[d.id,s]),E=n.useCallback(()=>{j.impactMedium(),o.toggle()},[]),B=n.useCallback(()=>{j.impactLight(),o.skipBack(50)},[]),W=n.useCallback(r=>{j.impactLight();const m=Math.max(100,Math.min(800,g+r));o.wpm=m,x(m),l({rsvpSpeed:m,hasCustomSpeed:!0})},[g,l]),F=n.useCallback(()=>{j.impactLight();const r=!y;S(r),l({showGhostPreview:r})},[y,l]),R=n.useCallback(()=>{j.impactLight();const r=$.getInstance(),m=r.mode,f=m==="Night"?"Modern":m==="Modern"?"Sepia":"Night";r.setMode(f)},[]),G=n.useCallback(()=>{v.current&&clearTimeout(v.current),c(r=>!r),M(!1)},[]),A=n.useCallback(r=>{o.progress=parseFloat(r.target.value)},[]),_=n.useCallback(r=>{j.impactLight();const m=Math.max(14,Math.min(32,i.fontSize+r));l({fontSize:m})},[i.fontSize,l]);n.useEffect(()=>{const r=()=>{p?o.stop():C()};return window.addEventListener("popstate",r),()=>window.removeEventListener("popstate",r)},[p,C]);const z=$.getInstance(),O=z.mode==="Night"?V:z.mode==="Sepia"?D:H;return t.jsxs("div",{className:"fixed inset-0 z-50 w-full h-[100dvh] overflow-hidden",style:{backgroundColor:e.background},children:[t.jsx(te,{book:d,onToggleChrome:G,isActive:!0,showGhostWords:y}),t.jsx("div",{className:"fixed left-0 right-0 z-[60] flex justify-center pointer-events-none",style:{bottom:"max(20px, env(safe-area-inset-bottom))"},children:t.jsxs("div",{className:`pointer-events-auto shadow-xl backdrop-blur-2xl border flex flex-col rounded-2xl overflow-hidden transition-all duration-300 ease-out ${h?"translate-y-0 opacity-100":"translate-y-4 opacity-0"}`,style:{backgroundColor:e.surface+"f0",borderColor:e.borderColor,maxWidth:"420px",width:"calc(100% - 24px)"},children:[t.jsxs("div",{className:"px-4 pt-3 pb-1",children:[t.jsx("input",{type:"range",min:"0",max:"1",step:"0.0001",value:a,onChange:A,className:"w-full h-1.5 rounded-full appearance-none cursor-pointer touch-pan-x",style:{background:`linear-gradient(to right, ${e.accent} ${a*100}%, ${e.borderColor} ${a*100}%)`}}),t.jsxs("div",{className:"flex justify-between mt-1.5 px-0.5",children:[t.jsx("span",{className:"text-[10px] tabular-nums",style:{color:e.secondaryText,opacity:.6},children:a<.1?"ðŸŒ± just starting":a<.25?`${Math.round(a*100)}% ðŸŒ¿`:a<.5?`${Math.round(a*100)}% ðŸ“– nice pace`:a<.75?`${Math.round(a*100)}% âœ¨ halfway!`:a<.9?`${Math.round(a*100)}% ðŸ”¥ almost there`:`${Math.round(a*100)}% ðŸŽ¯ so close!`}),t.jsxs("span",{className:"text-[10px] tabular-nums",style:{color:e.secondaryText,opacity:.6},children:["~",Math.round((1-a)*o.total/Math.max(1,g)),"m left"]})]})]}),t.jsxs("div",{className:"flex items-center gap-1 px-1.5 pb-2",children:[t.jsx("button",{onClick:B,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:e.secondaryText},"aria-label":"Rewind",children:t.jsx(q,{size:18})}),t.jsx("div",{className:"w-px h-5",style:{backgroundColor:e.borderColor}}),t.jsx("button",{onClick:()=>W(-25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:e.secondaryText},"aria-label":"Slower",children:t.jsx(J,{size:16})}),t.jsxs("div",{className:"h-9 px-2 rounded-xl flex items-center justify-center gap-1 min-w-[70px]",style:{backgroundColor:`${e.primaryText}06`},children:[t.jsx("span",{className:"text-sm font-bold tabular-nums",style:{color:e.primaryText},children:g}),t.jsx("span",{className:"text-[10px] lowercase opacity-50",style:{color:e.secondaryText},children:"wpm"})]}),t.jsx("button",{onClick:()=>W(25),className:"w-8 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:e.secondaryText},"aria-label":"Faster",children:t.jsx(K,{size:16})}),t.jsx("div",{className:"w-px h-5",style:{backgroundColor:e.borderColor}}),t.jsx("button",{onClick:E,className:"flex-1 flex items-center justify-center gap-1.5 h-9 rounded-xl font-semibold text-white shadow-md active:scale-[0.97] transition-all duration-150 text-sm hover:brightness-105",style:{backgroundColor:e.accent,minWidth:"80px"},"aria-label":p?"Pause":"Play",children:p?t.jsxs(t.Fragment,{children:[t.jsx(Q,{size:16})," ",t.jsx("span",{className:"lowercase",children:"pause"})]}):t.jsxs(t.Fragment,{children:[t.jsx(U,{size:16,className:"ml-0.5"})," ",t.jsx("span",{className:"lowercase",children:"flow~"})]})}),t.jsx("div",{className:"w-px h-5",style:{backgroundColor:e.borderColor}}),t.jsx("button",{onClick:F,className:`w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90 ${y?"":"opacity-40"}`,style:{backgroundColor:y?`${e.accent}15`:"transparent",color:y?e.accent:e.secondaryText},"aria-label":"Toggle context",children:y?t.jsx(X,{size:17}):t.jsx(Y,{size:17})}),t.jsx("button",{onClick:R,className:"w-9 h-9 rounded-xl flex items-center justify-center hover:bg-black/5 transition-colors active:scale-90",style:{color:e.secondaryText},"aria-label":"Toggle theme",children:t.jsx(O,{size:17})}),t.jsx("button",{onClick:()=>M(r=>!r),className:"w-9 h-9 rounded-xl flex items-center justify-center transition-colors active:scale-90",style:{backgroundColor:k?`${e.accent}15`:"transparent",color:k?e.accent:e.secondaryText},"aria-label":"Text size",children:t.jsx(Z,{size:17})})]}),k&&t.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-t",style:{borderColor:e.borderColor},children:[t.jsx("span",{className:"text-xs lowercase",style:{color:e.secondaryText},children:"text size"}),t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("button",{onClick:()=>_(-2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${e.primaryText}06`,color:e.primaryText},children:t.jsx("span",{className:"text-sm",children:"A"})}),t.jsx("span",{className:"text-sm font-semibold w-8 text-center tabular-nums",style:{color:e.primaryText},children:i.fontSize}),t.jsx("button",{onClick:()=>_(2),className:"w-9 h-9 rounded-xl flex items-center justify-center active:scale-90 transition-transform",style:{backgroundColor:`${e.primaryText}06`,color:e.primaryText},children:t.jsx("span",{className:"text-lg",children:"A"})})]})]})]})}),t.jsx("div",{className:`fixed top-0 left-0 right-0 z-[60] transition-all duration-300 ease-out ${h?"translate-y-0 opacity-100":"-translate-y-full opacity-0 pointer-events-none"}`,children:t.jsx("div",{className:"backdrop-blur-2xl border-b",style:{backgroundColor:`${e.surface}e8`,borderColor:e.borderColor,paddingTop:"max(12px, env(safe-area-inset-top))"},children:t.jsxs("div",{className:"flex items-center px-4 pb-3",children:[t.jsx("button",{onClick:C,className:"w-10 h-10 rounded-full flex items-center justify-center transition-all active:scale-90",style:{backgroundColor:`${e.primaryText}08`,color:e.primaryText},"aria-label":"Back",children:t.jsx(ee,{size:22})}),t.jsxs("div",{className:"flex-1 mx-3 text-center",children:[t.jsx("h1",{className:"text-sm font-semibold truncate",style:{color:e.primaryText},children:d.title}),t.jsx("p",{className:"text-[10px] opacity-50 truncate",style:{color:e.secondaryText},children:d.author})]}),t.jsx("div",{className:"w-10"})]})})}),t.jsx("style",{children:`
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${e.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
          width: 14px;
          height: 14px;
          border-radius: 50%;
          background: ${e.accent};
          cursor: pointer;
          box-shadow: 0 1px 4px rgba(0,0,0,0.2);
          border: none;
        }
      `})]})};export{le as ReaderContainer};
