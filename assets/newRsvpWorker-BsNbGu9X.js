(function(){"use strict";const d=t=>/[.!?]$/.test(t)?2:/[,;:]$/.test(t)?1.5:1,u=t=>Math.min(2,1+Math.max(0,t.length-6)*.08),g=(t,r)=>{const e=6e4/Math.max(1,t),s=d(r),n=u(r);return Math.round(e*s*n)},y=(t,r,e=1)=>{const s=t.replace(/\s+/g," ").trim();if(s.length===0)return[];const n=s.split(" "),o=[];for(let c=0;c<n.length;c+=e){const a=n.slice(c,c+e),l=a.join(" "),i=g(r,a[a.length-1]||l);o.push({index:o.length,text:l,duration:i})}return o},h=(t,r,e=1)=>{try{const s=globalThis.reedy;if(s&&(s.simpleParser||s.parse1||s.parse3)){const o=(s.simpleParser||s.parse1||s.parse3)(t||"");return!o||!o.length?[]:o.map(a=>{try{return typeof a=="string"?a:a.toString?a.toString():String(a)}catch{return String(a)}}).map((a,l)=>{const i=o[l];let p=g(r,a);if(i&&typeof i.getComplexity=="function")try{const f=i.getComplexity();p=Math.round(p*Math.max(.7,Math.min(3,f)))}catch{}return{index:l,text:a,duration:p}})}}catch{}return y(t,r,e)},m=t=>{try{const e=new DOMParser().parseFromString(t,"text/html");return e.body&&e.body.textContent||""}catch{return t.replace(/<[^>]+>/g," ")}};self.addEventListener("message",t=>{const r=t.data;if(!(!r||r.type!=="prepare"))try{let e=r.content||"";/</.test(e)&&/[a-z][\s\S]*>/i.test(e)&&(e=m(e));const s=500,n=h(e,r.wpm||300,r.chunkSize||1);if(n.length===0){self.postMessage({type:"prepared",tokens:[]});return}for(let o=0;o<n.length;o+=s){const c=n.slice(o,o+s),a=Math.min(.99,(o+c.length)/n.length);self.postMessage({type:"chunk",tokens:c,progress:a})}self.postMessage({type:"prepared",tokens:n})}catch(e){self.postMessage({type:"error",message:String(e)})}});async function M(){try{try{self.window=self}catch{}const t=self.location&&self.location.origin?self.location.origin+"/packages/reedy-core/js/content/":"/packages/reedy-core/js/content/",r=["content.js","Parser.js","Sequencer.js","Reader.js","View.js","ContentSelector.js"];for(const e of r){const s=t+e;try{const n=await fetch(s);if(!n.ok)throw new Error(`HTTP ${n.status}`);const o=await n.text();(0,eval)(o)}catch(n){return self.postMessage({type:"reedy-load-error",file:e,message:String(n)}),!1}}return globalThis.reedy?(self.postMessage({type:"reedy-loaded"}),!0):(self.postMessage({type:"reedy-load-error",message:"reedy global not found after load"}),!1)}catch(t){return self.postMessage({type:"reedy-load-error",message:String(t)}),!1}}M().catch(()=>{})})();
